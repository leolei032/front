# HEYTAP 主题编辑器 - 架构重构实施方案（简要版）

## 目标

### 目标一：应用架构重构
对原有架构进行分层设计（主进程、子进程、通信层、渲染层），提升系统的可扩展性与可维护性，以支持多产品线（主题、锁屏、天气）的制作和扩展能力。

### 目标二：复杂任务解耦与稳定性提升
将主题导出等高耗时任务重构至独立子进程，并设计带优先级管理的任务队列，彻底解决界面卡顿与崩溃问题，应用稳定性显著提升。

---

## 核心要做的事情

### 一、建立四层架构

```
渲染层 (Renderer Layer)
  ↓ IPC Bridge
通信层 (Communication Layer)
  ↓
主进程层 (Main Process Layer)
  ↓
子进程层 (Worker Process Layer)
```

#### 1. 渲染层改造
- **统一状态管理**：抽象产品线通用 Store 模式
- **UI 组件抽象**：创建通用产品编辑器组件
- **本地缓存优化**：使用 IndexedDB 缓存大数据

**关键文件**：
- `src/renderer/store/modules/product.js` - 通用 Store
- `src/renderer/components/ProductEditor/` - 通用编辑器组件

#### 2. 通信层建设
- **创建 IPC 管理器**：统一管理所有 IPC 通信
- **API 抽象层**：为每个产品线创建统一 API 接口
- **错误处理与重试**：自动重试失败的请求

**关键文件**：
- `src/universal/communication/IPCManager.js` - IPC 管理器
- `src/universal/communication/ProductAPI.js` - API 抽象层
- `preload/communication-bridge.js` - 通信桥接

#### 3. 主进程层重构
- **创建 IPC 路由器**：自动路由请求到对应处理器
- **任务分发器**：将重量级任务分发到子进程
- **轻量级业务**：主进程只处理轻量级操作

**关键文件**：
- `src/electron/main.js` - 主进程入口（重构 background.js）
- `src/electron/core/IPCRouter.js` - IPC 路由器
- `src/electron/core/TaskDispatcher.js` - 任务分发器
- `src/electron/modules/theme/index.js` - 主题模块（重构）

#### 4. 子进程层建设
- **创建 Worker Pool**：管理多个 Worker 进程
- **实现各类 Worker**：主题、图片、锁屏、小组件
- **进度反馈机制**：实时向主进程报告进度

**关键文件**：
- `src/electron/workers/BaseWorker.js` - Worker 基类
- `src/electron/workers/theme-worker.js` - 主题 Worker
- `src/electron/workers/image-worker.js` - 图片 Worker
- `src/electron/workers/lockscreen-worker.js` - 锁屏 Worker
- `src/electron/workers/widget-worker.js` - 小组件 Worker

### 二、实现任务队列与优先级管理

#### 1. 任务队列
- **优先级队列**：高优先级任务优先执行
- **任务取消**：支持取消正在执行的任务
- **任务重试**：失败任务自动重试

**关键文件**：
- `src/electron/core/TaskQueue.js` - 任务队列
- `src/electron/core/TaskPriority.js` - 优先级定义

#### 2. 优先级定义
```javascript
CRITICAL: 10  // 用户等待的导出
HIGH: 8       // 用户触发的操作
NORMAL: 5     // 后台任务
LOW: 3        // 预加载、缓存
IDLE: 1       // 清理、统计
```

#### 3. 任务调度
- **并发控制**：根据 CPU 核心数控制并发任务数
- **负载均衡**：任务均匀分配到各个 Worker
- **超时控制**：任务超时自动取消

### 三、重量级任务迁移

#### 需要迁移到子进程的任务

1. **主题导出** (`outputTheme`)
   - 文件拷贝
   - 资源处理
   - 压缩打包
   - XML 生成

2. **主题导入** (`inputThemes`)
   - 解压缩
   - 文件校验
   - 数据解析

3. **图片批处理**
   - 批量压缩
   - 批量缩放
   - 格式转换

4. **锁屏导出** (`outputLockscreen`)
   - 资源处理
   - 多分辨率生成
   - 压缩打包

5. **小组件打包** (`outputWidget`)
   - 资源处理
   - 压缩打包

---

## 实施步骤

### 阶段一：基础架构（2周）

**Week 1: 通信层**
- [ ] 创建 `IPCManager` 类
- [ ] 创建 `ProductAPI` 基类
- [ ] 更新 preload 脚本
- [ ] 编写单元测试

**Week 2: 主进程重构**
- [ ] 创建 `IPCRouter`
- [ ] 创建 `TaskDispatcher`
- [ ] 重构 `background.js` → `main.js`
- [ ] 创建 Worker 基础设施

### 阶段二：子进程与任务队列（2周）

**Week 3: 任务队列**
- [ ] 实现 `TaskQueue` 类
- [ ] 实现优先级管理
- [ ] 实现任务取消机制
- [ ] 编写测试

**Week 4: Worker 实现**
- [ ] 创建 `BaseWorker` 类
- [ ] 创建 `ThemeWorker`
- [ ] 创建 `ImageWorker`
- [ ] 测试 Worker 通信

### 阶段三：业务迁移（3周）

**Week 5: 主题模块**
- [ ] 迁移主题导出到 `ThemeWorker`
- [ ] 迁移主题导入到 `ThemeWorker`
- [ ] 实现进度反馈
- [ ] 回归测试

**Week 6: 锁屏模块**
- [ ] 创建 `LockscreenWorker`
- [ ] 迁移锁屏导出
- [ ] 迁移锁屏导入
- [ ] 回归测试

**Week 7: 小组件模块**
- [ ] 创建 `WidgetWorker`
- [ ] 迁移小组件导出
- [ ] 迁移小组件导入
- [ ] 回归测试

### 阶段四：优化与上线（2周）

**Week 8: 性能优化**
- [ ] Worker Pool 调优
- [ ] 任务队列优化
- [ ] 内存管理优化
- [ ] 性能测试

**Week 9: 上线准备**
- [ ] 完整回归测试
- [ ] 文档完善
- [ ] 团队培训
- [ ] 灰度发布

---

## 关键代码示例

### 1. 统一 API 调用

**之前**：
```javascript
// 渲染进程直接调用
const res = await window.electron.output({
  theme_id: this.currentTheme.id,
  theme_name: this.currentTheme.name
})
```

**之后**：
```javascript
// 通过统一 API
import { ThemeAPI } from '@/universal/communication/ProductAPI'

const res = await ThemeAPI.export(this.currentTheme.id, {
  osVersions: [12000, 13000],
  settingsIcons: []
})

// 监听进度
ThemeAPI.onExportProgress((progress) => {
  this.exportProgress = progress
})
```

### 2. 主进程路由

**之前**：
```javascript
// background.js 中大量 ipcMain.on
ipcMain.on('output', async (evt, msg) => {
  await main.output(msg)
  win.webContents.send('outputed')
})
```

**之后**：
```javascript
// 自动路由
// 请求：theme:export
// 自动路由到：modules/theme/index.js 的 export 方法

class ThemeModule {
  async export(data) {
    // 分发到子进程
    return await dispatcher.dispatch('theme', 'export', data, {
      priority: TaskPriority.HIGH,
      timeout: 300000
    })
  }
}
```

### 3. Worker 处理

**之前**：
```javascript
// 主进程直接执行（阻塞）
const outputTheme = async({ themeID, osVersions }) => {
  await utils.copyPro(...)  // 阻塞
  await cleanTheme(...)     // 阻塞
  await dealItems(...)      // 阻塞
  await utils.compress(...) // 阻塞
}
```

**之后**：
```javascript
// 子进程执行（不阻塞主进程）
class ThemeWorker extends BaseWorker {
  async handleExport(data, onProgress) {
    onProgress(0)
    await utils.copyPro(...)
    onProgress(25)
    await cleanTheme(...)
    onProgress(50)
    await dealItems(...)
    onProgress(75)
    await utils.compress(...)
    onProgress(100)
  }
}
```

---

## 预期效果

### 性能提升
- ✅ 主题导出时界面不卡顿（保持 60fps）
- ✅ 主进程 CPU 占用 < 20%
- ✅ 大型主题包导出不崩溃
- ✅ 批量操作不阻塞界面

### 稳定性提升
- ✅ Worker 崩溃不影响主进程
- ✅ 任务失败自动重试
- ✅ 长时间运行无内存泄漏
- ✅ 异常情况数据不丢失

### 扩展性提升
- ✅ 新增产品线（如天气）只需 1-2 天
- ✅ 新增 Worker 类型简单
- ✅ 新增任务类型简单
- ✅ 代码结构清晰易维护

---

## 风险与应对

### 主要风险
1. **现有功能回归** → 完整回归测试 + 灰度发布
2. **开发周期延长** → 分阶段实施 + 并行开发
3. **Worker 频繁崩溃** → 崩溃恢复机制 + 内存限制
4. **团队学习成本** → 详细文档 + 代码示例 + 培训

### 降级方案
保留原有实现，出现问题可快速回滚：
```javascript
const USE_WORKER = process.env.USE_WORKER !== 'false'

if (USE_WORKER) {
  // 使用新实现
  return await dispatcher.dispatch('theme', 'export', data)
} else {
  // 降级到原有实现
  return await legacyExportTheme(data)
}
```

---

## 验收标准

### 功能验收
- [ ] 所有现有功能正常工作
- [ ] 主题/锁屏/小组件导出在子进程执行
- [ ] 任务队列和优先级管理正常
- [ ] 任务取消功能正常
- [ ] 进度反馈正常

### 性能验收
- [ ] 导出时主进程 CPU < 20%
- [ ] 界面无卡顿（60fps）
- [ ] 大型主题包导出不崩溃
- [ ] 内存占用 < 2GB

### 稳定性验收
- [ ] 连续导出 100 个主题包无崩溃
- [ ] Worker 崩溃后自动恢复
- [ ] 长时间运行无内存泄漏

### 扩展性验收
- [ ] 能快速添加新产品线
- [ ] 新增 Worker 类型简单
- [ ] API 接口统一清晰

---

## 总结

### 核心改动
1. **四层架构**：渲染层 → 通信层 → 主进程层 → 子进程层
2. **统一通信**：IPCManager + ProductAPI
3. **任务队列**：优先级管理 + 任务取消
4. **Worker Pool**：进程池 + 负载均衡
5. **重量级任务迁移**：导出、导入、批处理 → 子进程

### 实施时间
**总计：9 周**
- 基础架构：2 周
- 子进程与队列：2 周
- 业务迁移：3 周
- 优化与上线：2 周

### 关键成果
- ✅ 架构清晰，易扩展
- ✅ 性能优异，不卡顿
- ✅ 稳定性高，不崩溃
- ✅ 可维护性好

---

**详细方案请参考**：`架构重构实施方案.md`

**文档版本**：v1.0
**生成时间**：2025-12-16
**作者**：AI Assistant

