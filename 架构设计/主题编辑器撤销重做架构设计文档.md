# ä¸»é¢˜ç¼–è¾‘å™¨ - æ’¤é”€/é‡åšæ¶æ„è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v2.0 **æ›´æ–°æ—¥æœŸ**: 2025-12-09 **çŠ¶æ€**: æŠ€æœ¯æ–¹æ¡ˆï¼ˆæ·±åº¦ç ”ç©¶ç‰ˆï¼‰ **æ–‡æ¡£ç±»å‹**: å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…å«æ‰€æœ‰å®ç°ç»†èŠ‚

---

## ğŸ“‘ æ–‡æ¡£å¯¼è¯»

### é˜…è¯»æŒ‡å—

æœ¬æ–‡æ¡£æ˜¯**æ·±åº¦ç ”ç©¶ç‰ˆæœ¬**ï¼ŒåŒ…å«æ‰€æœ‰æŠ€æœ¯ç»†èŠ‚ã€å®Œæ•´ä»£ç å®ç°å’Œä½¿ç”¨åœºæ™¯ã€‚

**ä¸åŒè§’è‰²çš„é˜…è¯»è·¯å¾„**ï¼š

| è§’è‰²                  | æ¨èç« èŠ‚                          | é˜…è¯»æ–¹å¼                 | é¢„è®¡æ—¶é—´ |
| --------------------- | --------------------------------- | ------------------------ | -------- |
| **æ¶æ„å¸ˆ/æŠ€æœ¯Leader** | 1-6ç« ï¼ˆèƒŒæ™¯ã€æ–¹æ¡ˆå¯¹æ¯”ã€æ¶æ„è®¾è®¡ï¼‰ | å¿«é€Ÿæµè§ˆ + é‡ç‚¹ç« èŠ‚ç²¾è¯»  | 1å°æ—¶    |
| **æ ¸å¿ƒå¼€å‘**          | å…¨éƒ¨ç« èŠ‚ï¼Œé‡ç‚¹7-11ç«               | å®Œæ•´é˜…è¯»ï¼Œä»£ç ç¤ºä¾‹éœ€ç†è§£ | 4-6å°æ—¶  |
| **æµ‹è¯•å·¥ç¨‹å¸ˆ**        | 3ã€11ã€12ç«                        | é‡ç‚¹é˜…è¯»è¾¹ç•Œå¤„ç†ç›¸å…³å†…å®¹ | 1.5å°æ—¶  |
| **æ–°äºº/ç»´æŠ¤è€…**       | æŒ‰é¡ºåºå®Œæ•´é˜…è¯»                    | å¾ªåºæ¸è¿›ï¼Œä»£ç ç¤ºä¾‹å¯è·³è¿‡ | 1-2å¤©    |

### æœ¯è¯­è¡¨

| æœ¯è¯­               | å®šä¹‰                                                | ä½¿ç”¨åœºæ™¯     |
| ------------------ | --------------------------------------------------- | ------------ |
| **Command**        | å°è£…ä¸€æ¬¡å¯æ’¤é”€æ“ä½œçš„å¯¹è±¡ï¼ŒåŒ…å«execute/undo/redoé€»è¾‘ | æ ¸å¿ƒè®¾è®¡æ¨¡å¼ |
| **Patch**          | Immer.js ç”Ÿæˆçš„ JSON å·®å¼‚è®°å½•ï¼ˆforward/inverseï¼‰    | å¢é‡å­˜å‚¨     |
| **Snapshot**       | å‘¨æœŸæ€§ä¿å­˜çš„å®Œæ•´çŠ¶æ€ï¼Œç”¨äºåŠ é€Ÿé•¿è·ç¦»æ’¤é”€            | æ€§èƒ½ä¼˜åŒ–     |
| **FilePool**       | æŒ‰æ–‡ä»¶ hash å­˜å‚¨å¹¶ç®¡ç†å¼•ç”¨è®¡æ•°çš„æ–‡ä»¶æ±               | æ–‡ä»¶ç®¡ç†     |
| **RAF**            | requestAnimationFrameï¼Œæµè§ˆå™¨å¸§åŒæ­¥æœºåˆ¶             | æ‰¹å¤„ç†ä¼˜åŒ–   |
| **Event Sourcing** | äº‹ä»¶æº¯æºï¼Œåªå­˜å‚¨æ“ä½œåºåˆ—è€Œéæœ€ç»ˆçŠ¶æ€                | æ¶æ„æ¨¡å¼     |
| **Immer**          | åŸºäº Proxy çš„ä¸å¯å˜æ•°æ®åº“ï¼Œè‡ªåŠ¨ç”Ÿæˆ Patch           | æ ¸å¿ƒæŠ€æœ¯     |
| **LRU**            | Least Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨æ·˜æ±°ç­–ç•¥           | å†…å­˜ç®¡ç†     |
| **GC**             | Garbage Collectionï¼Œåƒåœ¾å›æ”¶                        | æ–‡ä»¶æ± æ¸…ç†   |

### å…³é”®è®¾è®¡å†³ç­–é€Ÿè§ˆ

| å†³ç­–ç‚¹       | é€‰æ‹©æ–¹æ¡ˆ                    | æ ¸å¿ƒä¼˜åŠ¿                    | ç« èŠ‚     |
| ------------ | --------------------------- | --------------------------- | -------- |
| **å­˜å‚¨æ–¹å¼** | Patchï¼ˆå¢é‡ï¼‰               | å†…å­˜èŠ‚çœ 99%ï¼ˆ50MB â†’ 50KBï¼‰ | ç¬¬5ã€7ç«  |
| **æ’¤é”€åŠ é€Ÿ** | å‘¨æœŸå¿«ç…§ï¼ˆæ¯20æ­¥ï¼‰          | å¹³è¡¡å†…å­˜ä¸æ€§èƒ½              | ç¬¬7ç«     |
| **åˆå¹¶ç­–ç•¥** | RAFæ‰¹å¤„ç† + Mapå»é‡         | ç®€å•é«˜æ•ˆï¼ˆ97%åˆå¹¶ç‡ï¼‰       | ç¬¬9ç«     |
| **æ–‡ä»¶å­˜å‚¨** | å†…å®¹å¯»å€ï¼ˆhashï¼‰ + å¼•ç”¨è®¡æ•° | å»é‡ + å¯æ’¤é”€               | ç¬¬7ç«     |
| **æ¸²æŸ“ä¼˜åŒ–** | 5ç§ç­–ç•¥ç»„åˆ                 | æ— å¡é¡¿ã€æ— é—ªçƒ              | ç¬¬8ã€9ç«  |
| **é™çº§æ–¹æ¡ˆ** | Immerå¤±æ•ˆæ—¶åˆ‡æ¢å¿«ç…§æ¨¡å¼     | ä¿è¯ç¨³å®šæ€§                  | ç¬¬11ç«    |

### æ–‡æ¡£ç»“æ„

```
ç¬¬ä¸€éƒ¨åˆ†ï¼šèƒŒæ™¯ä¸å†³ç­–ï¼ˆ1-6ç« ï¼‰
â”œâ”€ 1. é¡¹ç›®èƒŒæ™¯ - ä¸šåŠ¡åœºæ™¯å’ŒæŠ€æœ¯æ ˆ
â”œâ”€ 2. æ ¸å¿ƒè¯‰æ±‚ - åŠŸèƒ½éœ€æ±‚ + å½“å‰é—®é¢˜
â”œâ”€ 3. ç¼–è¾‘æ“ä½œç±»å‹ - é«˜ä¸­ä½é¢‘æ“ä½œåˆ†æ
â”œâ”€ 4. è®¾è®¡ç›®æ ‡ - æ€§èƒ½æŒ‡æ ‡ + æ¶æ„åŸåˆ™
â”œâ”€ 5. æ•´ä½“è®¾è®¡æ€è·¯ - æ ¸å¿ƒç†å¿µ + æ–¹æ¡ˆå¯¹æ¯”
â””â”€ 6. JSONæ•°æ®ç»“æ„è®¾è®¡åŸåˆ™ - Schemaçº¦æŸ

ç¬¬äºŒéƒ¨åˆ†ï¼šæ¶æ„è®¾è®¡ä¸å®ç°ï¼ˆ7-10ç« ï¼‰
â”œâ”€ 7. æ¶æ„è®¾è®¡ä¸ä»£ç å®ç° - å®Œæ•´å®ç°ç»†èŠ‚
â”œâ”€ 8. æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥ - 5ç§ä¼˜åŒ–æ–¹æ¡ˆè¯¦è§£
â”œâ”€ 9. æ“ä½œåˆå¹¶/æŠ˜å ä¼˜åŒ– - Patchåˆå¹¶ç®—æ³•
â””â”€ 10. å…¸å‹ä½¿ç”¨åœºæ™¯ - 6ä¸ªè¯¦ç»†åœºæ™¯

ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®¹é”™ä¸è¾¹ç•Œï¼ˆ11-13ç« ï¼‰
â”œâ”€ 11. é™çº§ä¸å®¹é”™ç­–ç•¥ - 5ä¸ªé™çº§æ–¹æ¡ˆï¼ˆæ–°å¢â­ï¼‰
â”œâ”€ 12. é”™è¯¯å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ - å®Œæ•´å¼‚å¸¸å¤„ç†
â””â”€ 13. æŠ€æœ¯çº¦æŸ - ç¯å¢ƒå’ŒèŒƒå›´é™åˆ¶

ç¬¬å››éƒ¨åˆ†ï¼šè¯„ä¼°ä¸æ‰©å±•ï¼ˆ14-15ç« ï¼‰
â”œâ”€ 14. æˆåŠŸæ ‡å‡† - å¯é‡åŒ–æŒ‡æ ‡
â””â”€ 15. åç»­æ‰©å±•æ–¹å‘ - åä½œç¼–è¾‘ç­‰

ç¬¬äº”éƒ¨åˆ†ï¼šå‚è€ƒèµ„æ–™ï¼ˆ16ç« ï¼‰
â””â”€ 16. å‚è€ƒèµ„æ–™ - è®¾è®¡æ¨¡å¼ + æŠ€æœ¯åº“

é™„å½•
â””â”€ A. æ–‡æ¡£ç»´æŠ¤ - ç‰ˆæœ¬è®°å½•
```

### é‡è¦æç¤º

1. **ä»£ç ç¤ºä¾‹å‡ä¸ºæ ¸å¿ƒå®ç°**ï¼šæ‰€æœ‰ä»£ç éƒ½æ˜¯å¸®åŠ©ç†è§£æ–¹æ¡ˆçš„å…³é”®ï¼Œä¸æ˜¯æ¼”ç¤ºä»£ç 
2. **ç« èŠ‚é—´æœ‰ä¾èµ–å…³ç³»**ï¼šå»ºè®®æŒ‰é¡ºåºé˜…è¯»ï¼Œåç»­ç« èŠ‚ä¼šå¼•ç”¨å‰é¢çš„æ¦‚å¿µ
3. **æ€§èƒ½æ•°æ®åŸºäºçœŸå®åœºæ™¯**ï¼šæ‰€æœ‰æ€§èƒ½æŒ‡æ ‡éƒ½æ˜¯åŸºäº5-10MB Schemaçš„å®æµ‹é¢„ä¼°
4. **æ–°å¢å†…å®¹å·²æ ‡æ³¨**ï¼šæ ‡è®°ä¸º"æ–°å¢"çš„ç« èŠ‚æ˜¯åœ¨åŸæ–¹æ¡ˆåŸºç¡€ä¸Šè¡¥å……çš„å®¹é”™ç­–ç•¥

---

## ğŸ“‹ 1. é¡¹ç›®èƒŒæ™¯

### é¡¹ç›®æ¦‚è¿°

ä¸»é¢˜ç¼–è¾‘å™¨æ˜¯ä¸€ä¸ªåŸºäº **ä½ä»£ç ** ç†å¿µçš„å¯è§†åŒ–ç¼–è¾‘å·¥å…·ï¼Œæ ¸å¿ƒç‰¹ç‚¹ï¼š

- **è¾“å…¥**: ZIP åŒ…ï¼ˆåŒ…å«æè¿°æ–‡ä»¶ + é™æ€èµ„æºï¼‰
- **ä¸­é—´æ€**: Schema ä½œä¸ºç»Ÿä¸€æ•°æ®æ¨¡å‹
- **æ˜¾ç¤º**: å¯è§†åŒ– UI ç•Œé¢æ¨¡æ‹Ÿä¸»é¢˜ç”»é¢
- **äº¤äº’**: å¯è§†åŒ–æ“ä½œæ¯ä¸ªæ¨¡å—çš„ UI/æ•°æ®ä¿¡æ¯
- **è¾“å‡º**: å¤„ç†åçš„ä¸»é¢˜ ZIP åŒ…

### æŠ€æœ¯æ ˆ

- **Electron**: æä¾›è·¨å¹³å°èƒ½åŠ› + æ–‡ä»¶ç³»ç»Ÿè¯»å†™
- **Web æŠ€æœ¯**: å†…éƒ¨ä½¿ç”¨è‡ªç ” Web ä»£ç å®ç°ç¼–è¾‘å™¨ç•Œé¢
- **Schema-Driven**: æ‰€æœ‰ç»„ä»¶é€šè¿‡ Schema æè¿°å¹¶æ¸²æŸ“

---

## ğŸ¯ 2. æ ¸å¿ƒè¯‰æ±‚

### åŠŸèƒ½éœ€æ±‚

å®ç°ç±»ä¼¼ä¸“ä¸šç¼–è¾‘è½¯ä»¶ï¼ˆå¦‚ Photoshopï¼‰çš„ **å‰è¿›/å›é€€ï¼ˆUndo/Redoï¼‰** èƒ½åŠ›ï¼š

- âœ… æ”¯æŒæ’¤é”€ï¼ˆUndoï¼‰ä»»æ„ç¼–è¾‘æ“ä½œ
- âœ… æ”¯æŒé‡åšï¼ˆRedoï¼‰å·²æ’¤é”€çš„æ“ä½œ
- âœ… ç»´æŠ¤å¯é…ç½®çš„å†å²è®°å½•æ·±åº¦ï¼ˆå¦‚ 100 æ­¥ï¼‰
- âœ… æ”¯æŒå¿«æ·é”®ï¼ˆCtrl+Z / Ctrl+Yï¼‰
- âœ… æ˜¾ç¤ºæ“ä½œå†å²é¢æ¿ï¼ˆå¯é€‰ï¼‰

### å½“å‰å®ç°çš„é—®é¢˜

**ç°æœ‰æ–¹æ¡ˆ**: å®Œæ•´å¿«ç…§å­˜å‚¨

```javascript
// æ¯æ¬¡ä¿®æ”¹ä¿å­˜æ•´ä¸ª Schema çš„æ·±æ‹·è´
const historyStack = [
  deepClone(schema), // ä¿®æ”¹å‰
  deepClone(schema), // ä¿®æ”¹1
  deepClone(schema) // ä¿®æ”¹2
  // ... æœ€å¤šä¿å­˜ 10 ä¸ªå¿«ç…§
];
```

**å­˜åœ¨çš„é—®é¢˜**:

1. âŒ **å†…å­˜å ç”¨å·¨å¤§**: æ¯ä¸ªå¿«ç…§å®Œæ•´å¤åˆ¶æ•´ä¸ª Schemaï¼ˆå¯èƒ½åŒ…å«å¤§é‡ç»„ä»¶ã€æ ·å¼ã€æ•°æ®ï¼‰
2. âŒ **æ€§èƒ½ä½ä¸‹**: æ·±æ‹·è´å¤§å‹å¯¹è±¡è€—æ—¶é•¿ï¼ˆå¯èƒ½ 100ms+ï¼‰
3. âŒ **å†å²è®°å½•å—é™**: ä»…æ”¯æŒ 10 æ­¥å†å²ï¼ˆå—å†…å­˜é™åˆ¶ï¼‰
4. âŒ **ä¸å¯æ‰©å±•**: æ— æ³•æ”¯æŒå¤æ‚åœºæ™¯ï¼ˆå¦‚åä½œç¼–è¾‘ã€æ“ä½œåˆå¹¶ï¼‰
5. âŒ **åºåˆ—åŒ–å›°éš¾**: å®Œæ•´ Schema éš¾ä»¥æŒä¹…åŒ–åˆ°ç£ç›˜

**å¯¹æ¯”æ•°æ®**ï¼ˆå‡è®¾ Schema å¤§å°ä¸º 5MBï¼‰:

- 10 æ­¥å†å² = 50MB å†…å­˜å ç”¨
- 100 æ­¥å†å² = 500MB å†…å­˜å ç”¨ï¼ˆä¸å¯æ¥å—ï¼‰

---

## ğŸ”§ 3. ç¼–è¾‘æ“ä½œç±»å‹

### é«˜é¢‘æ“ä½œï¼ˆéœ€è¦ä¼˜åŒ–åˆå¹¶ï¼‰

| æ“ä½œç±»å‹     | ç¤ºä¾‹                 | é¢‘ç‡ | ç‰¹ç‚¹                   |
| ------------ | -------------------- | ---- | ---------------------- |
| **å±æ€§ä¿®æ”¹** | ä¿®æ”¹é¢œè‰²ã€å­—ä½“ã€å°ºå¯¸ | æé«˜ | è¿ç»­è§¦å‘ï¼Œéœ€è¦åˆå¹¶     |
| **æ–‡æœ¬è¾“å…¥** | è¾“å…¥ç»„ä»¶æ ‡é¢˜/æè¿°    | é«˜   | è¿ç»­å­—ç¬¦ï¼Œéœ€è¦åˆå¹¶     |
| **æ‹–æ‹½è°ƒæ•´** | æ‹–åŠ¨ç»„ä»¶ä½ç½®/å¤§å°    | é«˜   | è¿ç»­åæ ‡å˜åŒ–ï¼Œéœ€è¦åˆå¹¶ |

### ä¸­é¢‘æ“ä½œï¼ˆç‹¬ç«‹è®°å½•ï¼‰

| æ“ä½œç±»å‹     | ç¤ºä¾‹                    | é¢‘ç‡ | ç‰¹ç‚¹                 |
| ------------ | ----------------------- | ---- | -------------------- |
| **ç»„ä»¶æ“ä½œ** | æ·»åŠ /åˆ é™¤/å¤åˆ¶ç»„ä»¶      | ä¸­   | ç»“æ„æ€§å˜æ›´ï¼Œç‹¬ç«‹è®°å½• |
| **å›¾å±‚æ“ä½œ** | è°ƒæ•´ z-indexã€é”å®š/éšè— | ä¸­   | ç‹¬ç«‹æ“ä½œï¼Œä¸åˆå¹¶     |
| **æ•°æ®ç»‘å®š** | ç»‘å®šæ•°æ®æºã€è®¾ç½®è¡¨è¾¾å¼  | ä¸­   | é€»è¾‘å˜æ›´ï¼Œç‹¬ç«‹è®°å½•   |

### ä½é¢‘æ“ä½œï¼ˆç‰¹æ®Šå¤„ç†ï¼‰

| æ“ä½œç±»å‹     | ç¤ºä¾‹               | é¢‘ç‡ | ç‰¹ç‚¹                 |
| ------------ | ------------------ | ---- | -------------------- |
| **æ–‡ä»¶æ“ä½œ** | ä¸Šä¼ å›¾ç‰‡ã€æ›¿æ¢èµ„æº | ä½   | å¤§æ–‡ä»¶ï¼Œä»…å­˜å‚¨å¼•ç”¨   |
| **æ‰¹é‡æ“ä½œ** | æ‰¹é‡åˆ é™¤ã€æ‰¹é‡å¯¹é½ | ä½   | å¯èƒ½åŒ…å«å¤šä¸ªå­æ“ä½œ   |
| **å…¨å±€è®¾ç½®** | ä¿®æ”¹ä¸»é¢˜é…ç½®ã€å˜é‡ | ä½   | å½±å“èŒƒå›´å¤§ï¼Œç‹¬ç«‹è®°å½• |

---

## ğŸ’¡ 4. è®¾è®¡ç›®æ ‡

### æ€§èƒ½æŒ‡æ ‡

- âš¡ **æ’¤é”€/é‡åšå»¶è¿Ÿ**: < 50msï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
- ğŸ“¦ **å†…å­˜å ç”¨**: < å½“å‰æ–¹æ¡ˆçš„ 10%ï¼ˆä» 50MB â†’ 5MBï¼‰
- ğŸ”¢ **å†å²æ·±åº¦**: æ”¯æŒè‡³å°‘ 100 æ­¥å†å²
- ğŸ’¾ **æŒä¹…åŒ–**: æ”¯æŒå°†å†å²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆElectronï¼‰

### åŠŸèƒ½ç‰¹æ€§

- ğŸ”— **æ“ä½œåˆå¹¶**: æ™ºèƒ½åˆå¹¶è¿ç»­ç›¸ä¼¼æ“ä½œï¼ˆå¦‚é¢œè‰²è°ƒæ•´ï¼‰
- ğŸ“¸ **å‘¨æœŸå¿«ç…§**: æ··åˆç­–ç•¥ï¼ŒåŠ é€Ÿå¤§é‡æ’¤é”€
- ğŸ”„ **å¯åºåˆ—åŒ–**: æ”¯æŒå¯¼å‡º/å¯¼å…¥æ“ä½œå†å²
- ğŸ§© **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„æ“ä½œç±»å‹

### æ¶æ„åŸåˆ™

- ğŸ¨ **å‘½ä»¤æ¨¡å¼**: æ¯ä¸ªæ“ä½œå°è£…ä¸ºç‹¬ç«‹å‘½ä»¤å¯¹è±¡
- ğŸ“Š **å¢é‡å­˜å‚¨**: åªè®°å½•å˜æ›´å·®å¼‚ï¼ˆDiffï¼‰ï¼Œä¸å­˜å‚¨å®Œæ•´çŠ¶æ€
- ğŸš€ **å»¶è¿Ÿè®¡ç®—**: æŒ‰éœ€æ¢å¤çŠ¶æ€ï¼Œé¿å…é¢„è®¡ç®—
- ğŸ—ï¸ **åˆ†å±‚è®¾è®¡**: å†å²ç®¡ç†ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦

---

## ğŸ§  5. æ•´ä½“è®¾è®¡æ€è·¯

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

æœ¬æ¶æ„åŸºäºä¸‰ä¸ªæ ¸å¿ƒæŠ€æœ¯é€‰å‹ï¼š

1. **Command Patternï¼ˆå‘½ä»¤æ¨¡å¼ï¼‰**

   - **æ¥æº**: Gang of Four è®¾è®¡æ¨¡å¼
   - **æ ¸å¿ƒæ€æƒ³**: å°†æ¯ä¸ªç¼–è¾‘æ“ä½œå°è£…ä¸ºç‹¬ç«‹çš„å‘½ä»¤å¯¹è±¡
   - **ä¼˜åŠ¿**: æ“ä½œå¯é€†ã€å¯åºåˆ—åŒ–ã€å¯ç»„åˆã€å¯å»¶è¿Ÿæ‰§è¡Œ

2. **Event Sourcingï¼ˆäº‹ä»¶æº¯æºï¼‰**

   - **æ¥æº**: DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ¶æ„æ¨¡å¼
   - **æ ¸å¿ƒæ€æƒ³**: ä¸å­˜å‚¨æœ€ç»ˆçŠ¶æ€ï¼Œè€Œæ˜¯å­˜å‚¨å¯¼è‡´çŠ¶æ€å˜åŒ–çš„æ“ä½œåºåˆ—
   - **ä¼˜åŠ¿**: å®Œæ•´çš„æ“ä½œå†å²ã€æ—¶é—´æ—…è¡Œèƒ½åŠ›ã€å®¡è®¡æ—¥å¿—ã€åä½œå†²çªè§£å†³

3. **Immer.jsï¼ˆä¸å¯å˜æ•°æ® + ç»“æ„å…±äº«ï¼‰**
   - **æ¥æº**: React ç”Ÿæ€çš„ä¸å¯å˜æ•°æ®æ–¹æ¡ˆ
   - **æ ¸å¿ƒæ€æƒ³**: åŸºäº Proxy çš„å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰+ è‡ªåŠ¨ç”Ÿæˆ Patch
   - **ä¼˜åŠ¿**: å†…å­˜é«˜æ•ˆã€è‡ªåŠ¨å·®å¼‚è®¡ç®—ã€å¤©ç„¶æ”¯æŒæ’¤é”€/é‡åš

### ä¸ºä»€ä¹ˆæŠ›å¼ƒå¿«ç…§æ–¹æ¡ˆï¼Ÿ

| ç»´åº¦         | å¿«ç…§æ–¹æ¡ˆ                | æœ¬æ¶æ„ï¼ˆCommand + Event Sourcingï¼‰              |
| ------------ | ----------------------- | ----------------------------------------------- |
| **å†…å­˜å ç”¨** | æ¯æ­¥ 5MB Ã— 10 æ­¥ = 50MB | æ¯æ­¥ ~500 bytes Ã— 100 æ­¥ = 50KBï¼ˆ**èŠ‚çœ 99%**ï¼‰ |
| **æ‰§è¡Œæ€§èƒ½** | æ·±æ‹·è´ 100ms+           | Immer Patch åº”ç”¨ < 5msï¼ˆ**å¿« 20 å€**ï¼‰          |
| **å†å²æ·±åº¦** | å—å†…å­˜é™åˆ¶ï¼Œé€šå¸¸ 10 æ­¥  | æ”¯æŒ 100-1000 æ­¥                                |
| **åä½œèƒ½åŠ›** | æ— æ³•åˆå¹¶å†²çª            | å¯åŸºäºæ“ä½œåºåˆ—è¿›è¡Œ OT/CRDT                      |
| **å®¡è®¡æ—¥å¿—** | æ— æ³•è¿½æº¯å…·ä½“æ“ä½œ        | å®Œæ•´çš„æ“ä½œå†å²è®°å½•                              |
| **æŒä¹…åŒ–**   | 500MB éš¾ä»¥å­˜å‚¨          | 5MB è½»æ¾ä¿å­˜åˆ°ç£ç›˜                              |

**å…³é”®æ´å¯Ÿ**:

- æˆ‘ä»¬ä¸éœ€è¦ä¿å­˜ 10 ä¸ªå®Œæ•´çš„ Schemaï¼ˆçŠ¶æ€å¿«ç…§ï¼‰
- æˆ‘ä»¬åªéœ€è¦ä¿å­˜ 100 æ¡æ“ä½œè®°å½•ï¼ˆäº‹ä»¶æ—¥å¿—ï¼‰
- ä»»ä½•å†å²çŠ¶æ€éƒ½å¯ä»¥é€šè¿‡ **é‡æ”¾æ“ä½œåºåˆ—** è¿˜åŸ

### ç”¨æˆ·æ“ä½œæ¨¡å¼åˆ†æ

åœ¨è®¾è®¡ä¼˜åŒ–ç­–ç•¥å‰ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æç”¨æˆ·çš„å®é™…æ“ä½œæ¨¡å¼ï¼š

**é«˜é¢‘è¿ç»­æ“ä½œ**ï¼ˆæ‹–åŠ¨ã€æ»šåŠ¨ã€è¿ç»­ç‚¹å‡»ï¼‰ï¼š

- **æ—¶é—´ç‰¹å¾**: < 16ms é—´éš”
- **æ‰¹æ¬¡åˆ†å¸ƒ**: åŒä¸€ RAF æ‰¹æ¬¡å†…
- **åˆå¹¶æœºä¼š**: âœ… è‡ªåŠ¨åˆå¹¶ï¼ˆ99.99% çš„åˆå¹¶åœºæ™¯ï¼‰

**ä½é¢‘ç‹¬ç«‹æ“ä½œ**ï¼ˆæ·»åŠ ç»„ä»¶ã€åˆ é™¤ã€æ–‡ä»¶æ“ä½œï¼‰ï¼š

- **æ—¶é—´ç‰¹å¾**: > 500ms é—´éš”
- **æ‰¹æ¬¡åˆ†å¸ƒ**: ä¸åŒæ‰¹æ¬¡
- **åˆå¹¶æœºä¼š**: âŒ æ— éœ€åˆå¹¶

**å…³é”®æ´å¯Ÿ**ï¼š

- ç”¨æˆ·æ‹–åŠ¨æ»‘å— 30 æ¬¡ â†’ å…¨éƒ¨å‘ç”Ÿåœ¨ ~500ms å†… â†’ åŒä¸€ä¸ª RAF æ‰¹æ¬¡ï¼ˆ16ms çª—å£ï¼‰
- è·¨æ‰¹æ¬¡åˆå¹¶çš„æœºä¼šæå…¶ç½•è§ï¼ˆ< 0.01%ï¼‰
- **ç»“è®º**: æˆ‘ä»¬åªéœ€è¦ä¼˜åŒ–å•ä¸ª RAF æ‰¹æ¬¡å†…çš„åˆå¹¶ï¼Œæ— éœ€å¤æ‚çš„è·¨æ‰¹æ¬¡é€»è¾‘

### ç»Ÿä¸€æ‰¹å¤„ç†ç­–ç•¥

åŸºäºä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬é‡‡ç”¨**æ—¶é—´é˜ˆå€¼ + æ™ºèƒ½åˆ¤æ–­**çš„æ¶æ„ï¼š

**æ ¸å¿ƒæ€è·¯**: æ—¶é—´çª—å£ï¼ˆ100msï¼‰+ Map å»é‡ + åŒé‡è§¦å‘æ¡ä»¶

**ä¸ºä»€ä¹ˆä¸ç”¨ RAFï¼Ÿ**
- RAF æ¯ ~16.6ms è§¦å‘ä¸€æ¬¡ï¼ˆ60fpsï¼‰
- ç”¨æˆ·æ‹–åŠ¨ 500ms ä¼šè§¦å‘ 30 æ¬¡åˆ·æ–°ï¼ˆ500/16.6 â‰ˆ 30ï¼‰
- **å®é™…ä¸Šå¹¶æ²¡æœ‰åˆå¹¶ï¼Œåè€Œå¢åŠ äº†å¤æ‚åº¦**

**æ—¶é—´é˜ˆå€¼æ–¹æ¡ˆçš„ä¼˜åŠ¿**ï¼š
- 100ms çª—å£å†…çš„æ‰€æœ‰æ“ä½œçœŸæ­£åˆå¹¶ä¸º 1 æ¬¡
- é…åˆæ‰¹æ¬¡å¤§å°é™åˆ¶ï¼Œå…¼é¡¾æ€§èƒ½å’Œå“åº”é€Ÿåº¦
- å¤§æ‰¹é‡æ—¶ä½¿ç”¨ Idle Callback é¿å…é˜»å¡

```typescript
class HistoryManager {
  private currentBatch: Map<string, Command> = new Map();
  private flushTimer: number | null = null;
  private lastFlushTime: number = 0;

  // é…ç½®å‚æ•°
  private readonly FLUSH_INTERVAL = 100;  // 100ms æ—¶é—´çª—å£
  private readonly MAX_BATCH_SIZE = 50;   // æ‰¹æ¬¡æœ€å¤§å‘½ä»¤æ•°

  /**
   * æ·»åŠ å‘½ä»¤åˆ°æ‰¹æ¬¡é˜Ÿåˆ—
   */
  addCommand(cmd: Command): void {
    // 1. åŒä¸€ç»„ä»¶ + åŒä¸€å±æ€§ = åŒä¸€ä¸ª key = è‡ªåŠ¨å»é‡
    const key = `${cmd.componentId}:${cmd.propertyPath}`;
    this.currentBatch.set(key, cmd); // Map è‡ªåŠ¨å»é‡ï¼Œä¿ç•™æœ€åä¸€æ¬¡

    // 2. æ™ºèƒ½åˆ¤æ–­æ˜¯å¦ç«‹å³åˆ·æ–°
    const now = performance.now();
    const shouldFlushNow =
      this.currentBatch.size >= this.MAX_BATCH_SIZE ||              // æ‰¹æ¬¡å·²æ»¡
      (now - this.lastFlushTime) >= this.FLUSH_INTERVAL;            // æ—¶é—´åˆ°æœŸ

    if (shouldFlushNow) {
      // ç«‹å³åˆ·æ–°ï¼ˆå–æ¶ˆå¾…æ‰§è¡Œçš„å®šæ—¶å™¨ï¼‰
      if (this.flushTimer !== null) {
        clearTimeout(this.flushTimer);
        this.flushTimer = null;
      }
      this.flushBatch();
    } else {
      // å»¶è¿Ÿåˆ·æ–°ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
      this.scheduleFlush();
    }
  }

  /**
   * è°ƒåº¦æ‰¹æ¬¡åˆ·æ–°ï¼ˆé˜²æŠ–ï¼‰
   */
  private scheduleFlush(): void {
    if (this.flushTimer !== null) {
      clearTimeout(this.flushTimer);
    }

    this.flushTimer = window.setTimeout(() => {
      this.flushBatch();
    }, this.FLUSH_INTERVAL);
  }

  /**
   * åˆ·æ–°æ‰¹æ¬¡ï¼ˆæ‰§è¡Œæ‰€æœ‰å‘½ä»¤ï¼‰
   */
  private flushBatch(): void {
    if (this.currentBatch.size === 0) return;

    const commands = Array.from(this.currentBatch.values());
    console.log(`[Batch] Flushing ${commands.length} commands`);

    // æ™ºèƒ½æ‰§è¡Œï¼šæ ¹æ®å‘½ä»¤æ•°é‡é€‰æ‹©ç­–ç•¥
    if (commands.length > 10) {
      // å¤§æ‰¹é‡ï¼šä½¿ç”¨ Idle Callback é¿å…é˜»å¡ UI
      this.executeWithIdleCallback(commands);
    } else {
      // å°æ‰¹é‡ï¼šç›´æ¥æ‰§è¡Œ
      commands.forEach(cmd => cmd.execute());
    }

    // æ·»åŠ åˆ°å†å²æ ˆï¼ˆä½œä¸ºä¸€ä¸ªæ‰¹æ¬¡ï¼‰
    this.undoStack.push({
      type: 'BATCH',
      commands,
      timestamp: performance.now()
    });

    // æ¸…ç©ºé˜Ÿåˆ—
    this.currentBatch.clear();
    this.flushTimer = null;
    this.lastFlushTime = performance.now();
  }

  /**
   * ä½¿ç”¨ Idle Callback æ‰§è¡Œå¤§æ‰¹é‡å‘½ä»¤
   */
  private executeWithIdleCallback(commands: Command[]): void {
    let index = 0;

    const processBatch = (deadline: IdleDeadline) => {
      // åœ¨ç©ºé—²æ—¶é—´å†…å°½å¯èƒ½å¤šåœ°æ‰§è¡Œ
      while (index < commands.length && deadline.timeRemaining() > 1) {
        commands[index].execute();
        index++;
      }

      // å¦‚æœè¿˜æœ‰æœªæ‰§è¡Œçš„ï¼Œç»§ç»­è°ƒåº¦
      if (index < commands.length) {
        requestIdleCallback(processBatch);
      }
    };

    requestIdleCallback(processBatch, { timeout: 100 });
  }
}
```

**å®é™…åœºæ™¯åˆ†æ**ï¼š

| åœºæ™¯                 | æ—¶é—´è·¨åº¦ | è§¦å‘æ¬¡æ•°        | ä¼˜åŒ–ç»“æœ                      |
| -------------------- | -------- | --------------- | ----------------------------- |
| **æ‹–åŠ¨æ»‘å— 30 æ¬¡**   | 500ms    | 5 æ¬¡æ‰¹æ¬¡åˆ·æ–°    | 30 æ¬¡ â†’ 1 ä¸ª Command          |
| **æ·»åŠ  + åˆ é™¤ç»„ä»¶**  | 2s       | 2 æ¬¡ï¼ˆé—´éš”>100msï¼‰| 2 ä¸ª Commandï¼ˆç‹¬ç«‹è®°å½•ï¼‰      |
| **æ‰¹é‡å¯¹é½ 10 ç»„ä»¶** | 50ms     | 1 æ¬¡æ‰¹æ¬¡åˆ·æ–°    | 10 ä¸ª Commandï¼ˆåˆå¹¶æäº¤ï¼‰     |
| **è¿ç»­æ–‡æœ¬è¾“å…¥**     | 1s       | 10 æ¬¡æ‰¹æ¬¡åˆ·æ–°   | N æ¬¡ â†’ 1 ä¸ª Command           |

**æ€§èƒ½æ•°æ®å¯¹æ¯”**ï¼š

| æŒ‡æ ‡             | RAF æ–¹æ¡ˆï¼ˆ16.6msï¼‰| æ—¶é—´é˜ˆå€¼æ–¹æ¡ˆï¼ˆ100msï¼‰| æ”¹å–„    |
| ---------------- | ----------------- | -------------------- | ------- |
| **æ‰¹æ¬¡åˆ·æ–°æ¬¡æ•°** | 30 æ¬¡ï¼ˆ500ms/16.6ï¼‰| 5 æ¬¡ï¼ˆ500ms/100ï¼‰    | 83% â†“   |
| **å†…å­˜å ç”¨**     | 30KB              | 1KB                  | 97% â†“   |
| **å“åº”å»¶è¿Ÿ**     | 16.6ms            | 100ms                | -       |
| **ä»£ç å¤æ‚åº¦**   | é«˜ï¼ˆRAFç®¡ç†ï¼‰     | ä½ï¼ˆsetTimeoutï¼‰     | ç®€åŒ–    |

**å¯é€‰å¢å¼º**: äº‹åŠ¡æ¨¡å¼ï¼ˆç”¨äºæ˜¾å¼æ‰¹é‡æ“ä½œï¼‰

```typescript
// åœºæ™¯ï¼šæ‰¹é‡å¯¼å…¥ 100 ä¸ªç»„ä»¶
editor.transaction('æ‰¹é‡å¯¼å…¥', () => {
  components.forEach((c) => editor.addComponent(c));
});
// 100 ä¸ªæ“ä½œ â†’ 1 æ¡å†å²è®°å½•ï¼ˆç¬¦åˆç”¨æˆ·å¿ƒæ™ºæ¨¡å‹ï¼‰
```

### ç»„ä»¶ååŒå·¥ä½œæµç¨‹

æ•´ä¸ªç³»ç»Ÿç”± 5 ä¸ªæ ¸å¿ƒæ¨¡å—ååŒå·¥ä½œï¼š

```
ç”¨æˆ·æ“ä½œï¼ˆUI å±‚ï¼‰
    â†“
ã€å‘½ä»¤å°è£…ã€‘Command å¯¹è±¡
    â†“
ã€æ™ºèƒ½è°ƒåº¦ã€‘RAF æ‰¹å¤„ç† + æ“ä½œåˆå¹¶ + ç©ºé—²è°ƒåº¦
    â†“
ã€çŠ¶æ€ç®¡ç†ã€‘Immer.js ç”Ÿæˆ Patches
    â†“
ã€å†å²å­˜å‚¨ã€‘HistoryManager ç»´æŠ¤æ“ä½œæ ˆ
    â†“
ã€çŠ¶æ€æ¢å¤ã€‘åº”ç”¨/æ’¤é”€ Patches â†’ è§¦å‘ UI é‡æ¸²æŸ“
```

**å…³é”®æ•°æ®æµ**:

1. **ç¼–è¾‘æ—¶**:

   ```
   ç”¨æˆ·ä¿®æ”¹å±æ€§ â†’ åˆ›å»º UpdatePropertyCommand
   â†’ Scheduler åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰¹å¤„ç†/åˆå¹¶
   â†’ SchemaManager é€šè¿‡ Immer ç”Ÿæˆ Patches
   â†’ HistoryManager ä¿å­˜ Commandï¼ˆåŒ…å« Patchesï¼‰
   â†’ UI é‡æ–°æ¸²æŸ“
   ```

2. **æ’¤é”€æ—¶**:

   ```
   ç”¨æˆ·æŒ‰ Ctrl+Z â†’ HistoryManager.undo()
   â†’ å–å‡ºæœ€è¿‘çš„ Command
   â†’ åº”ç”¨ inversePatchï¼ˆImmer è‡ªåŠ¨ç”Ÿæˆçš„åå‘æ“ä½œï¼‰
   â†’ SchemaManager æ¢å¤åˆ°ä¸Šä¸€çŠ¶æ€
   â†’ UI é‡æ–°æ¸²æŸ“
   ```

3. **é‡åšæ—¶**:
   ```
   ç”¨æˆ·æŒ‰ Ctrl+Y â†’ HistoryManager.redo()
   â†’ é‡æ–°æ‰§è¡Œ Command.execute()
   â†’ åº”ç”¨ forwardPatch
   â†’ çŠ¶æ€å‰è¿›ä¸€æ­¥
   â†’ UI é‡æ–°æ¸²æŸ“
   ```

### è®¾è®¡æƒè¡¡ä¸å–èˆ

| ç»´åº¦                               | æƒè¡¡ç‚¹                             | é€‰æ‹©                             | åŸå›                                                |
| ---------------------------------- | ---------------------------------- | -------------------------------- | -------------------------------------------------- |
| **å¿«ç…§ vs æ“ä½œæ—¥å¿—**               | å¿«ç…§å›æ»šå¿«ï¼Œä½†å ç”¨å†…å­˜å¤§           | æ“ä½œæ—¥å¿—                         | Schema å¯èƒ½ 5MB+ï¼Œæ“ä½œä»… 500 bytes                 |
| **åŒæ­¥ vs å¼‚æ­¥**                   | åŒæ­¥ç®€å•ï¼Œå¼‚æ­¥æ€§èƒ½å¥½               | æ··åˆï¼šé«˜ä¼˜å…ˆçº§åŒæ­¥ï¼Œä½ä¼˜å…ˆçº§å¼‚æ­¥ | å…¼é¡¾ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½                             |
| **å®Œå…¨åˆå¹¶ vs é€‰æ‹©æ€§åˆå¹¶**         | å®Œå…¨åˆå¹¶å†å²çŸ­ï¼Œé€‰æ‹©æ€§åˆå¹¶ä¿ç•™ç»†èŠ‚ | é€‰æ‹©æ€§åˆå¹¶                       | é«˜é¢‘æ“ä½œï¼ˆå±æ€§è°ƒæ•´ï¼‰åˆå¹¶ï¼Œç»“æ„å˜æ›´ï¼ˆæ·»åŠ ç»„ä»¶ï¼‰ç‹¬ç«‹ |
| **å®¢æˆ·ç«¯ vs æœåŠ¡ç«¯**               | æœåŠ¡ç«¯å¯åä½œï¼Œå®¢æˆ·ç«¯æ€§èƒ½å¥½         | å®¢æˆ·ç«¯ä¸ºä¸»                       | Electron æœ¬åœ°åº”ç”¨ï¼Œä¸éœ€è¦å®æ—¶åä½œ                  |
| **å‘¨æœŸå¿«ç…§ vs çº¯æ—¥å¿—**             | å¿«ç…§åŠ é€Ÿé•¿è·ç¦»è·³è½¬                 | æ¯ 20 æ­¥åˆ›å»ºä¸€æ¬¡å¿«ç…§             | å¹³è¡¡å†…å­˜å’Œæ€§èƒ½ï¼ˆæ’¤é”€ 50 æ­¥æ—¶ä»æœ€è¿‘å¿«ç…§é‡æ”¾ï¼‰       |
| **React Fiber ä¸­æ–­ vs åä½œå¼è®©æ­¥** | Fiber å¯ä¸­æ–­ä»»ä½•ä»»åŠ¡ï¼Œä½†å®ç°å¤æ‚   | åä½œå¼è®©æ­¥                       | æˆ‘ä»¬çš„ä»»åŠ¡ç²’åº¦è¾ƒç²—ï¼Œä¸»åŠ¨è®©æ­¥å·²è¶³å¤Ÿ                 |

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **ç”¨æˆ·æ„ŸçŸ¥ä¼˜å…ˆ**: é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæ‹–æ‹½ã€è¾“å…¥ï¼‰æ°¸ä¸æ’é˜Ÿï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæ‰¹é‡å¯¼å…¥ï¼‰å¯è¢«ä¸­æ–­
2. **å†…å­˜æ•ˆç‡ä¼˜å…ˆ**: ä¼˜å…ˆä½¿ç”¨æ“ä½œæ—¥å¿—è€Œéå¿«ç…§ï¼Œç»“æ„å…±äº«è€Œéæ·±æ‹·è´
3. **æ¸è¿›å¼ä¼˜åŒ–**: ä»ç®€å•æ–¹æ¡ˆå¼€å§‹ï¼Œé€æ­¥å åŠ ä¼˜åŒ–ç­–ç•¥ï¼ˆå¯æŒ‰éœ€å¯ç”¨/ç¦ç”¨ï¼‰
4. **å¯æµ‹è¯•æ€§**: æ¯ä¸ª Command éƒ½æ˜¯çº¯å‡½æ•°ï¼Œæ˜“äºå•å…ƒæµ‹è¯•
5. **å¯æ‰©å±•æ€§**: æ–°å¢æ“ä½œç±»å‹åªéœ€å®ç° `ICommand` æ¥å£
6. **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„æ“ä½œæ—¥å¿—å¯ç”¨äºè°ƒè¯•ã€å®¡è®¡ã€æ€§èƒ½åˆ†æ

### æŠ€æœ¯é£é™©ä¸ç¼“è§£

| é£é™©                       | ç¼“è§£æªæ–½                                                     |
| -------------------------- | ------------------------------------------------------------ |
| **Immer.js æ€§èƒ½ç“¶é¢ˆ**      | ä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼Œæä¾›å¿«ç…§æ¨¡å¼ä½œä¸ºé™çº§æ–¹æ¡ˆ                     |
| **æ“ä½œæ—¥å¿—è¿‡é•¿å¯¼è‡´é‡æ”¾æ…¢** | æ¯ 20 æ­¥åˆ›å»ºå‘¨æœŸå¿«ç…§ï¼Œé•¿è·ç¦»è·³è½¬ä»å¿«ç…§å¼€å§‹é‡æ”¾               |
| **æµè§ˆå™¨ API å…¼å®¹æ€§**      | requestIdleCallbackã€Scheduler API æä¾›ä¸‰å±‚é™çº§æ–¹æ¡ˆ          |
| **å†…å­˜æ³„æ¼**               | LRU ç­–ç•¥é™åˆ¶å†å²æ·±åº¦ï¼Œå®šæœŸæ¸…ç†æ—§æ“ä½œ                         |
| **æ“ä½œåˆå¹¶é€»è¾‘é”™è¯¯**       | æä¾› `disableMerge` é€‰é¡¹ï¼Œå¹¶ä¿ç•™åˆå¹¶å‰çš„åŸå§‹æ“ä½œï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰ |

---

## ğŸ“ 6. JSON æ•°æ®ç»“æ„è®¾è®¡åŸåˆ™

### æ ¸å¿ƒåŸåˆ™

ä¸ºäº†ä¿è¯ Immer.js Patch æœºåˆ¶çš„æ­£ç¡®æ€§å’Œæ€§èƒ½ï¼Œä¸»é¢˜æ•°æ®çš„ JSON ç»“æ„å¿…é¡»éµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

### å¿…é¡»éµå¾ªçš„è§„åˆ™

#### 1. æ¯ä¸ªç»„ä»¶å¿…é¡»æœ‰ç¨³å®šçš„å”¯ä¸€ ID

**é”™è¯¯ç¤ºä¾‹**ï¼šä½¿ç”¨æ•°ç»„ç´¢å¼•

```typescript
// âŒ é”™è¯¯ï¼šä½¿ç”¨æ•°ç»„å­˜å‚¨ç»„ä»¶
{
  "components": [
    { "type": "button", "text": "ç¡®å®š" },  // ç´¢å¼• 0
    { "type": "text", "content": "æ ‡é¢˜" }   // ç´¢å¼• 1
  ]
}
```

**é—®é¢˜**ï¼š

- Immer Patch è·¯å¾„ï¼š`/components/1/text`
- åˆ é™¤ç¬¬ä¸€ä¸ªç»„ä»¶åï¼Œç¬¬äºŒä¸ªç»„ä»¶çš„ç´¢å¼•ä» `1` å˜ä¸º `0`
- å†å²è®°å½•ä¸­çš„è·¯å¾„ `/components/1` å¤±æ•ˆï¼Œæ’¤é”€ä¼šå‡ºé”™

**æ­£ç¡®ç¤ºä¾‹**ï¼šä½¿ç”¨å¯¹è±¡ + ç¨³å®š ID

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¯¹è±¡å­˜å‚¨ç»„ä»¶ï¼Œkey ä¸ºç»„ä»¶ ID
{
  "components": {
    "button_abc123": {
      "id": "button_abc123",
      "type": "button",
      "text": "ç¡®å®š"
    },
    "text_def456": {
      "id": "text_def456",
      "type": "text",
      "content": "æ ‡é¢˜"
    }
  }
}
```

**ä¼˜åŠ¿**ï¼š

- Patch è·¯å¾„ï¼š`/components/button_abc123/text`
- åˆ é™¤å…¶ä»–ç»„ä»¶ä¸ä¼šå½±å“è¯¥ç»„ä»¶çš„è·¯å¾„
- æ’¤é”€/é‡åšæ°¸è¿œèƒ½æ‰¾åˆ°æ­£ç¡®çš„ç»„ä»¶

**ID ç”Ÿæˆç­–ç•¥**ï¼š

```typescript
// æ¨èï¼šæ—¶é—´æˆ³ + éšæœºæ•°
function generateComponentId(type: string): string {
  return `${type}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
  // ç¤ºä¾‹ï¼šbutton_1702345678901_a3x9f2k
}

// æˆ–è€…ä½¿ç”¨ UUID åº“
import { v4 as uuidv4 } from 'uuid';
const id = uuidv4(); // e.g., 110ec58a-a0f2-4ac4-8393-c866d813b8d1
```

---

#### 2. æ–‡ä»¶å¼•ç”¨åªå­˜å‚¨ hashï¼Œç¦æ­¢å­˜å‚¨äºŒè¿›åˆ¶å†…å®¹

**é”™è¯¯ç¤ºä¾‹**ï¼šå­˜å‚¨ base64 ç¼–ç 

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥å­˜å‚¨æ–‡ä»¶å†…å®¹
{
  "backgroundImage": {
    "data": "iVBORw0KGgoAAAANSUhEUgAA...",  // 10MB base64 å­—ç¬¦ä¸²
    "mimeType": "image/png"
  }
}
```

**é—®é¢˜**ï¼š

- å•ä¸ª 10MB å›¾ç‰‡ = 13.3MB base64 å­—ç¬¦ä¸²ï¼ˆ1.33x è†¨èƒ€ï¼‰
- 10 ä¸ªå†å²è®°å½• = 133MB å†…å­˜å ç”¨
- åºåˆ—åŒ–/ååºåˆ—åŒ–ææ…¢

**æ­£ç¡®ç¤ºä¾‹**ï¼šåªå­˜å‚¨ hash å¼•ç”¨

```typescript
// âœ… æ­£ç¡®ï¼šåªå­˜å‚¨æ–‡ä»¶ hashï¼ˆ64 å­—èŠ‚ï¼‰
{
  "backgroundImage": {
    "hash": "a3d2f1e9b7c4d6e8f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3",
    "androidPath": "drawable/bg_main.png",
    "width": 1080,
    "height": 1920
  }
}
```

**ä¼˜åŠ¿**ï¼š

- å†…å­˜å ç”¨ï¼š64 bytes vs. 13.3MBï¼ˆèŠ‚çœ 99.9995%ï¼‰
- 10 ä¸ªå†å²è®°å½•ï¼š640 bytes vs. 133MB
- æ–‡ä»¶å®é™…å­˜å‚¨åœ¨æ–‡ä»¶æ± ï¼ˆ`FilePoolManager`ï¼‰

---

#### 3. ç¦æ­¢åœ¨ä¸šåŠ¡æ•°æ®ä¸­æ·»åŠ ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³

**é”™è¯¯ç¤ºä¾‹**ï¼šæ·»åŠ å…ƒæ•°æ®å­—æ®µ

```typescript
// âŒ é”™è¯¯ï¼šæ±¡æŸ“ä¸šåŠ¡æ•°æ®
{
  "components": {
    "button1": {
      "type": "button",
      "text": "ç¡®å®š",
      "_version": 3,              // â† ä¸éœ€è¦
      "_lastModified": 1702345678,  // â† ä¸éœ€è¦
      "_author": "user123"        // â† ä¸éœ€è¦
    }
  }
}
```

**é—®é¢˜**ï¼š

- æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šæ”¹å˜ `_lastModified`ï¼Œå³ä½¿ä¸šåŠ¡æ•°æ®æœªå˜
- å¯¼è‡´ Patch åŒ…å«æ— å…³ä¿¡æ¯ï¼Œæ— æ³•æ­£ç¡®åˆå¹¶
- å¢åŠ åºåˆ—åŒ–å¤§å°

**æ­£ç¡®æ–¹æ¡ˆ**ï¼š

```typescript
// âœ… ç‰ˆæœ¬ä¿¡æ¯ç”± Command å¯¹è±¡ç®¡ç†
class UpdatePropertyCommand {
  readonly timestamp: number;  // â† åœ¨è¿™é‡Œè®°å½•æ—¶é—´
  readonly description: string;

  constructor(...) {
    this.timestamp = Date.now();  // è‡ªåŠ¨è®°å½•
  }
}

// ä¸šåŠ¡æ•°æ®ä¿æŒçº¯å‡€
{
  "components": {
    "button1": {
      "type": "button",
      "text": "ç¡®å®š"
      // æ— ä»»ä½•å…ƒæ•°æ®å­—æ®µ
    }
  }
}
```

---

#### 4. ç¦æ­¢ä½¿ç”¨è½¯åˆ é™¤æ ‡è®°

**é”™è¯¯ç¤ºä¾‹**ï¼šæ·»åŠ  `_deleted` æ ‡è®°

```typescript
// âŒ é”™è¯¯ï¼šè½¯åˆ é™¤
{
  "components": {
    "button1": {
      "type": "button",
      "text": "ç¡®å®š",
      "_deleted": true  // â† ä¸è¦è¿™æ ·åš
    }
  }
}
```

**é—®é¢˜**ï¼š

- "å·²åˆ é™¤"çš„ç»„ä»¶ä»å ç”¨å†…å­˜
- åˆ—è¡¨æ¸²æŸ“éœ€è¦è¿‡æ»¤ `_deleted=true` çš„é¡¹
- Patch æ— æ³•æ­£ç¡®è¡¨è¾¾"åˆ é™¤"æ“ä½œ

**æ­£ç¡®æ–¹æ¡ˆ**ï¼šç›´æ¥åˆ é™¤ key

```typescript
// âœ… æ­£ç¡®ï¼šç›´æ¥åˆ é™¤ key
{
  "components": {
    // button1 å·²è¢«åˆ é™¤ï¼Œkey ä¸å­˜åœ¨
    "button2": { "type": "button", "text": "å–æ¶ˆ" }
  }
}

// Immer è‡ªåŠ¨ç”Ÿæˆçš„ Patch
{
  "op": "remove",
  "path": "/components/button1"
}

// æ’¤é”€æ—¶ï¼ŒImmer è‡ªåŠ¨ç”Ÿæˆçš„ inverse Patch
{
  "op": "add",
  "path": "/components/button1",
  "value": { "type": "button", "text": "ç¡®å®š" }
}
```

---

### æ¨èçš„è®¾è®¡æ¨¡å¼

#### æ¨¡å¼ 1: åˆ†ç¦»é¡ºåºå’Œæ•°æ®ï¼ˆé€‚ç”¨äºå›¾å±‚ç³»ç»Ÿï¼‰

å¦‚æœç»„ä»¶çš„**æ¸²æŸ“é¡ºåºéå¸¸é‡è¦**ï¼ˆå¦‚ Photoshop å›¾å±‚ï¼‰ï¼Œå»ºè®®åˆ†ç¦»é¡ºåºæ•°ç»„ï¼š

```typescript
{
  "components": {
    "layer1": { "type": "image", "src": "bg.png" },
    "layer2": { "type": "text", "content": "æ ‡é¢˜" },
    "layer3": { "type": "button", "text": "æŒ‰é’®" }
  },

  // å•ç‹¬çš„é¡ºåºæ•°ç»„ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰
  "layerOrder": ["layer1", "layer2", "layer3"]
}
```

**ä¼˜åŠ¿**ï¼š

- è°ƒæ•´å›¾å±‚é¡ºåºåªä¿®æ”¹ `layerOrder` æ•°ç»„
- ä¸å½±å“ç»„ä»¶æ•°æ®æœ¬èº«
- Patch æ›´å°ï¼Œåˆå¹¶æ›´å®¹æ˜“

---

#### æ¨¡å¼ 2: ä½¿ç”¨ zIndexï¼ˆé€‚ç”¨äºè‡ªç”±å¸ƒå±€ï¼‰

å¦‚æœåªéœ€è¦åŸºæœ¬çš„å±‚çº§æ§åˆ¶ï¼Œç›´æ¥ä½¿ç”¨ `zIndex` æ›´ç®€å•ï¼š

```typescript
{
  "components": {
    "btn1": { "type": "button", "text": "ç¡®å®š", "zIndex": 1 },
    "txt1": { "type": "text", "content": "æ ‡é¢˜", "zIndex": 10 }
  }
}
```

---

### æ¨èçš„å®Œæ•´ Schema ç¤ºä¾‹

```typescript
interface ThemeSchema {
  /** å…ƒæ•°æ®ï¼ˆä¸å‚ä¸æ¸²æŸ“ï¼‰ */
  metadata: {
    projectId: string;
    themeName: string;
    xmlData: Record<string, any>; // è§£æåçš„ JSON
    variables: Record<string, VariableDefinition>;
  };

  /** ç»„ä»¶æ•°æ®ï¼ˆæ ¸å¿ƒä¸šåŠ¡æ•°æ®ï¼‰ */
  components: {
    [componentId: string]: {
      id: string; // ä¸ key ç›¸åŒ
      type: 'button' | 'text' | 'image' | 'container';
      name: string;

      style: {
        x: number;
        y: number;
        width: number;
        height: number;
        color?: string;
        // ... å…¶ä»–æ ·å¼
      };

      children?: string[]; // å­ç»„ä»¶ ID æ•°ç»„
      props?: Record<string, any>; // ç»„ä»¶ç‰¹æœ‰å±æ€§
    };
  };

  /** æ–‡ä»¶å¼•ç”¨ï¼ˆåªå­˜ hashï¼‰ */
  assets: {
    images: {
      [assetKey: string]: {
        hash: string; // SHA256 hashï¼ˆ64 å­—èŠ‚ï¼‰
        androidPath: string;
      };
    };
  };
}
```

---

### è®¾è®¡æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹             | è¦æ±‚     | åŸå›                      |
| ------------------ | -------- | ------------------------ |
| âœ… ç»„ä»¶æœ‰ç¨³å®š ID   | **å¿…é¡»** | Immer Patch è·¯å¾„ä¾èµ– key |
| âœ… ID ä½œä¸ºå¯¹è±¡ key | **å¿…é¡»** | é¿å…æ•°ç»„ç´¢å¼•å˜åŒ–         |
| âœ… æ–‡ä»¶åªå­˜ hash   | **å¿…é¡»** | å†…å­˜æ•ˆç‡ï¼ˆèŠ‚çœ 99.9%ï¼‰   |
| ğŸš« æ— ç‰ˆæœ¬å·å­—æ®µ    | **ç¦æ­¢** | æ±¡æŸ“ä¸šåŠ¡æ•°æ®             |
| ğŸš« æ—  deleted æ ‡è®° | **ç¦æ­¢** | Immer è‡ªåŠ¨å¤„ç†åˆ é™¤       |
| âš ï¸ åˆ†ç¦»é¡ºåºæ•°æ®    | æ¨è     | å‡å°‘æ— å…³ Patch           |

---

## ğŸ—ï¸ 7. æ¶æ„è®¾è®¡ä¸ä»£ç å®ç°

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç¼–è¾‘å™¨ UI å±‚                             â”‚
â”‚  (Vue/React Component + Event Handlers)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ è°ƒç”¨æ“ä½œæ–¹æ³•
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HistoryManager                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Undo Stack   â”‚  â”‚ Redo Stack   â”‚  â”‚ Snapshots    â”‚      â”‚
â”‚  â”‚ [Command]    â”‚  â”‚ [Command]    â”‚  â”‚ Map<int,     â”‚      â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  State>      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                             â”‚
â”‚  - execute(command)      - undo()        - redo()          â”‚
â”‚  - merge logic           - snapshot management             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ æ‰§è¡Œ Command
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Command æŠ½è±¡å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ ICommand         â”‚  â”‚ IMergeableCmd    â”‚                â”‚
â”‚  â”‚ - execute()      â”‚  â”‚ - canMerge()     â”‚                â”‚
â”‚  â”‚ - undo()         â”‚  â”‚ - merge()        â”‚                â”‚
â”‚  â”‚ - redo()         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ å…·ä½“å®ç°
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å…·ä½“ Command å®ç°ç±»                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ UpdateProperty    â”‚  â”‚ AddComponent       â”‚             â”‚
â”‚  â”‚ Command           â”‚  â”‚ Command            â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ DeleteComponent   â”‚  â”‚ ReplaceFile        â”‚             â”‚
â”‚  â”‚ Command           â”‚  â”‚ Command            â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ TextInput         â”‚  â”‚ BatchOperation     â”‚             â”‚
â”‚  â”‚ Command (å¯åˆå¹¶)   â”‚  â”‚ Command (ç»„åˆ)      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ ä¿®æ”¹æ•°æ®
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Schema State å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SchemaManager (åŸºäº Immer.js)                         â”‚ â”‚
â”‚  â”‚  - state: Schema (ä¸å¯å˜æ•°æ®)                           â”‚ â”‚
â”‚  â”‚  - setState(newState)                                  â”‚ â”‚
â”‚  â”‚  - getProperty(path)                                   â”‚ â”‚
â”‚  â”‚  - setProperty(path, value) â†’ ç”Ÿæˆ Patches            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ è§¦å‘æ›´æ–°
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ¸²æŸ“å±‚ (UI æ›´æ–°)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 1. Command æ¥å£å®šä¹‰

```typescript
/**
 * åŸºç¡€å‘½ä»¤æ¥å£
 */
interface ICommand {
  /** å‘½ä»¤å”¯ä¸€æ ‡è¯† */
  readonly id: string;

  /** å‘½ä»¤ç±»å‹ï¼ˆç”¨äºåºåˆ—åŒ–ï¼‰ */
  readonly type: string;

  /** å‘½ä»¤æè¿°ï¼ˆæ˜¾ç¤ºåœ¨å†å²é¢æ¿ï¼‰ */
  readonly description: string;

  /** åˆ›å»ºæ—¶é—´æˆ³ */
  readonly timestamp: number;

  /** æ‰§è¡Œå‘½ä»¤ï¼ˆåº”ç”¨å˜æ›´ï¼‰ */
  execute(): void;

  /** æ’¤é”€å‘½ä»¤ï¼ˆæ¢å¤å˜æ›´ï¼‰ */
  undo(): void;

  /** é‡åšå‘½ä»¤ï¼ˆé€šå¸¸ç­‰åŒäº executeï¼‰ */
  redo(): void;

  /** åºåˆ—åŒ–ä¸º JSONï¼ˆç”¨äºæŒä¹…åŒ–ï¼‰ */
  serialize(): Record<string, any>;
}

/**
 * å¯åˆå¹¶å‘½ä»¤æ¥å£ï¼ˆç”¨äºè¿ç»­ç›¸ä¼¼æ“ä½œï¼‰
 */
interface IMergeableCommand extends ICommand {
  /** åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸å¦ä¸€ä¸ªå‘½ä»¤åˆå¹¶ */
  canMerge(command: ICommand): boolean;

  /** åˆå¹¶å¦ä¸€ä¸ªå‘½ä»¤åˆ°å½“å‰å‘½ä»¤ */
  merge(command: ICommand): void;

  /** åˆå¹¶æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰ */
  readonly mergeWindow: number;
}

/**
 * ç»„åˆå‘½ä»¤æ¥å£ï¼ˆæ‰¹é‡æ“ä½œï¼‰
 */
interface ICompositeCommand extends ICommand {
  /** å­å‘½ä»¤åˆ—è¡¨ */
  readonly commands: ICommand[];

  /** æ·»åŠ å­å‘½ä»¤ */
  addCommand(command: ICommand): void;
}
```

---

#### 2. HistoryManager æ ¸å¿ƒå®ç°

```typescript
import { EventEmitter } from 'events';

interface HistoryState {
  canUndo: boolean;
  canRedo: boolean;
  undoCount: number;
  redoCount: number;
}

/**
 * å†å²ç®¡ç†å™¨ - æ ¸å¿ƒæ’¤é”€/é‡åšé€»è¾‘
 */
class HistoryManager extends EventEmitter {
  /** æ’¤é”€æ ˆ */
  private undoStack: ICommand[] = [];

  /** é‡åšæ ˆ */
  private redoStack: ICommand[] = [];

  /** å‘¨æœŸå¿«ç…§ï¼ˆæ¯ N ä¸ªæ“ä½œä¿å­˜ä¸€æ¬¡ï¼‰ */
  private snapshots: Map<number, any> = new Map();

  /** é…ç½®é¡¹ */
  private config = {
    maxHistorySize: 100, // æœ€å¤§å†å²è®°å½•æ•°
    snapshotInterval: 20, // å¿«ç…§é—´éš”ï¼ˆæ¯ 20 ä¸ªæ“ä½œï¼‰
    maxSnapshots: 5, // æœ€å¤§å¿«ç…§æ•°
    enableAutoMerge: true, // è‡ªåŠ¨åˆå¹¶ç›¸ä¼¼æ“ä½œ
    mergeTimeWindow: 1000 // åˆå¹¶æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰
  };

  constructor(config?: Partial<typeof this.config>) {
    super();
    Object.assign(this.config, config);
  }

  /**
   * æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•åˆ°å†å²
   */
  execute(command: ICommand): void {
    // 1. å°è¯•ä¸æœ€åä¸€ä¸ªå‘½ä»¤åˆå¹¶
    if (this.config.enableAutoMerge && this.tryMergeCommand(command)) {
      this.emitStateChange();
      return;
    }

    // 2. æ‰§è¡Œå‘½ä»¤
    command.execute();

    // 3. æ·»åŠ åˆ°æ’¤é”€æ ˆ
    this.undoStack.push(command);

    // 4. æ¸…ç©ºé‡åšæ ˆï¼ˆæ‰§è¡Œæ–°æ“ä½œåï¼Œæ—§çš„é‡åšå†å²å¤±æ•ˆï¼‰
    this.redoStack = [];

    // 5. é™åˆ¶æ ˆå¤§å°
    this.trimHistoryIfNeeded();

    // 6. å‘¨æœŸæ€§ä¿å­˜å¿«ç…§
    this.saveSnapshotIfNeeded();

    // 7. è§¦å‘çŠ¶æ€å˜æ›´äº‹ä»¶
    this.emitStateChange();

    // 8. æ—¥å¿—è®°å½•
    this.logCommand('EXECUTE', command);
  }

  /**
   * æ’¤é”€æ“ä½œ
   */
  undo(steps: number = 1): void {
    if (!this.canUndo()) return;

    const actualSteps = Math.min(steps, this.undoStack.length);

    // å¤§é‡æ’¤é”€æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨å¿«ç…§æ¢å¤
    if (actualSteps > 10) {
      this.undoWithSnapshot(actualSteps);
    } else {
      // æ­£å¸¸é€ä¸ªæ’¤é”€
      for (let i = 0; i < actualSteps; i++) {
        this.undoOne();
      }
    }

    this.emitStateChange();
  }

  /**
   * æ’¤é”€å•ä¸ªæ“ä½œ
   */
  private undoOne(): void {
    const command = this.undoStack.pop();
    if (!command) return;

    command.undo();
    this.redoStack.push(command);
    this.logCommand('UNDO', command);
  }

  /**
   * ä½¿ç”¨å¿«ç…§åŠ é€Ÿå¤§é‡æ’¤é”€
   */
  private undoWithSnapshot(steps: number): void {
    const targetIndex = this.undoStack.length - steps;
    const snapshot = this.findNearestSnapshot(targetIndex);

    if (snapshot) {
      // æ¢å¤åˆ°å¿«ç…§çŠ¶æ€
      this.restoreSnapshot(snapshot);

      // é‡æ”¾å¿«ç…§ä¹‹ååˆ°ç›®æ ‡ä½ç½®çš„å‘½ä»¤
      const replayCount = targetIndex - snapshot.index;
      for (let i = 0; i < replayCount; i++) {
        this.undoStack[snapshot.index + i].execute();
      }

      // è°ƒæ•´æ ˆæŒ‡é’ˆ
      this.redoStack.push(...this.undoStack.slice(targetIndex));
      this.undoStack = this.undoStack.slice(0, targetIndex);
    } else {
      // æ— å¿«ç…§ï¼Œå›é€€åˆ°é€ä¸ªæ’¤é”€
      for (let i = 0; i < steps; i++) {
        this.undoOne();
      }
    }
  }

  /**
   * é‡åšæ“ä½œ
   */
  redo(steps: number = 1): void {
    if (!this.canRedo()) return;

    const actualSteps = Math.min(steps, this.redoStack.length);

    for (let i = 0; i < actualSteps; i++) {
      const command = this.redoStack.pop();
      if (!command) break;

      command.redo();
      this.undoStack.push(command);
      this.logCommand('REDO', command);
    }

    this.emitStateChange();
  }

  /**
   * å°è¯•åˆå¹¶å‘½ä»¤
   */
  private tryMergeCommand(command: ICommand): boolean {
    if (this.undoStack.length === 0) return false;

    const lastCommand = this.undoStack[this.undoStack.length - 1];

    // æ£€æŸ¥æ˜¯å¦å¯åˆå¹¶
    if (this.isMergeableCommand(lastCommand) && lastCommand.canMerge(command)) {
      lastCommand.merge(command);
      return true;
    }

    return false;
  }

  /**
   * æ£€æŸ¥å‘½ä»¤æ˜¯å¦å¯åˆå¹¶
   */
  private isMergeableCommand(cmd: ICommand): cmd is IMergeableCommand {
    return 'canMerge' in cmd && 'merge' in cmd;
  }

  /**
   * é™åˆ¶å†å²æ ˆå¤§å°
   */
  private trimHistoryIfNeeded(): void {
    if (this.undoStack.length > this.config.maxHistorySize) {
      const removeCount = this.undoStack.length - this.config.maxHistorySize;
      this.undoStack.splice(0, removeCount);

      // æ¸…ç†å¯¹åº”çš„å¿«ç…§
      this.snapshots.forEach((_, index) => {
        if (index < removeCount) {
          this.snapshots.delete(index);
        }
      });
    }
  }

  /**
   * ä¿å­˜å¿«ç…§ï¼ˆå¦‚æœéœ€è¦ï¼‰
   */
  private saveSnapshotIfNeeded(): void {
    const currentIndex = this.undoStack.length;

    if (currentIndex % this.config.snapshotInterval === 0) {
      const state = this.captureCurrentState();
      this.snapshots.set(currentIndex, {
        index: currentIndex,
        state: state,
        timestamp: Date.now()
      });

      // é™åˆ¶å¿«ç…§æ•°é‡
      this.trimSnapshots();
    }
  }

  /**
   * æ•è·å½“å‰çŠ¶æ€ï¼ˆç”±å¤–éƒ¨ SchemaManager æä¾›ï¼‰
   */
  private captureCurrentState(): any {
    // é€šè¿‡å›è°ƒè·å–å½“å‰å®Œæ•´çŠ¶æ€
    return this.emit('capture-state');
  }

  /**
   * æ¢å¤å¿«ç…§
   */
  private restoreSnapshot(snapshot: any): void {
    this.emit('restore-state', snapshot.state);
  }

  /**
   * æŸ¥æ‰¾æœ€è¿‘çš„å¿«ç…§
   */
  private findNearestSnapshot(targetIndex: number): any {
    let nearest = null;
    let minDistance = Infinity;

    this.snapshots.forEach((snapshot, index) => {
      if (index <= targetIndex) {
        const distance = targetIndex - index;
        if (distance < minDistance) {
          minDistance = distance;
          nearest = snapshot;
        }
      }
    });

    return nearest;
  }

  /**
   * é™åˆ¶å¿«ç…§æ•°é‡
   */
  private trimSnapshots(): void {
    if (this.snapshots.size > this.config.maxSnapshots) {
      const sortedKeys = Array.from(this.snapshots.keys()).sort((a, b) => a - b);
      const removeCount = this.snapshots.size - this.config.maxSnapshots;

      for (let i = 0; i < removeCount; i++) {
        this.snapshots.delete(sortedKeys[i]);
      }
    }
  }

  /**
   * æ¸…ç©ºå†å²
   */
  clear(): void {
    this.undoStack = [];
    this.redoStack = [];
    this.snapshots.clear();
    this.emitStateChange();
  }

  /**
   * è·å–å½“å‰çŠ¶æ€
   */
  getState(): HistoryState {
    return {
      canUndo: this.canUndo(),
      canRedo: this.canRedo(),
      undoCount: this.undoStack.length,
      redoCount: this.redoStack.length
    };
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ’¤é”€
   */
  canUndo(): boolean {
    return this.undoStack.length > 0;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥é‡åš
   */
  canRedo(): boolean {
    return this.redoStack.length > 0;
  }

  /**
   * è·å–æ’¤é”€æ ˆï¼ˆç”¨äºå†å²é¢æ¿æ˜¾ç¤ºï¼‰
   */
  getUndoStack(): ICommand[] {
    return [...this.undoStack];
  }

  /**
   * è·å–é‡åšæ ˆ
   */
  getRedoStack(): ICommand[] {
    return [...this.redoStack];
  }

  /**
   * è§¦å‘çŠ¶æ€å˜æ›´äº‹ä»¶
   */
  private emitStateChange(): void {
    this.emit('state-change', this.getState());
  }

  /**
   * æ—¥å¿—è®°å½•
   */
  private logCommand(action: string, command: ICommand): void {
    if (process.env.NODE_ENV === 'development') {
      console.log(`[History] ${action}: ${command.description}`, {
        undoCount: this.undoStack.length,
        redoCount: this.redoStack.length
      });
    }
  }

  /**
   * åºåˆ—åŒ–å†å²ï¼ˆç”¨äºæŒä¹…åŒ–ï¼‰
   */
  serialize(): string {
    return JSON.stringify({
      undoStack: this.undoStack.map((cmd) => cmd.serialize()),
      redoStack: this.redoStack.map((cmd) => cmd.serialize())
    });
  }

  /**
   * ååºåˆ—åŒ–å†å²
   */
  static deserialize(data: string, commandFactory: CommandFactory): HistoryManager {
    const parsed = JSON.parse(data);
    const manager = new HistoryManager();

    manager.undoStack = parsed.undoStack.map((d: any) => commandFactory.create(d));
    manager.redoStack = parsed.redoStack.map((d: any) => commandFactory.create(d));

    return manager;
  }
}
```

---

#### 3. åŸºäº Immer.js çš„ Schema ç®¡ç†å™¨

```typescript
import { produce, applyPatches, Patch, enablePatches } from 'immer';

// å¯ç”¨ Immer patches åŠŸèƒ½
enablePatches();

/**
 * Schema çŠ¶æ€ç®¡ç†å™¨ï¼ˆåŸºäº Immer.jsï¼‰
 */
class SchemaManager {
  /** å½“å‰ Schema çŠ¶æ€ï¼ˆä¸å¯å˜ï¼‰ */
  private state: Schema;

  /** çŠ¶æ€å˜æ›´å›è°ƒ */
  private listeners: Set<(state: Schema) => void> = new Set();

  constructor(initialSchema: Schema) {
    this.state = initialSchema;
  }

  /**
   * è·å–å½“å‰çŠ¶æ€
   */
  getState(): Schema {
    return this.state;
  }

  /**
   * è®¾ç½®æ–°çŠ¶æ€
   */
  setState(newState: Schema): void {
    this.state = newState;
    this.notifyListeners();
  }

  /**
   * é€šè¿‡è·¯å¾„è·å–å±æ€§å€¼
   */
  getProperty(path: string): any {
    const keys = path.split('.');
    let value: any = this.state;

    for (const key of keys) {
      if (value === undefined || value === null) return undefined;
      value = value[key];
    }

    return value;
  }

  /**
   * é€šè¿‡è·¯å¾„è®¾ç½®å±æ€§å€¼ï¼ˆç”Ÿæˆ Patchesï¼‰
   */
  setProperty(path: string, value: any): { patches: Patch[]; inversePatches: Patch[] } {
    const keys = path.split('.');

    const [nextState, patches, inversePatches] = produce(
      this.state,
      (draft) => {
        let current: any = draft;

        // å¯¼èˆªåˆ°ç›®æ ‡å±æ€§çš„çˆ¶å¯¹è±¡
        for (let i = 0; i < keys.length - 1; i++) {
          if (current[keys[i]] === undefined) {
            current[keys[i]] = {};
          }
          current = current[keys[i]];
        }

        // è®¾ç½®å€¼
        current[keys[keys.length - 1]] = value;
      },
      (p, ip) => [p, ip]
    );

    this.setState(nextState);

    return { patches, inversePatches };
  }

  /**
   * åº”ç”¨ Patchesï¼ˆç”¨äºæ’¤é”€/é‡åšï¼‰
   */
  applyPatches(patches: Patch[]): void {
    const nextState = applyPatches(this.state, patches);
    this.setState(nextState);
  }

  /**
   * æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨ Immer produceï¼‰
   */
  update(updater: (draft: Schema) => void): {
    patches: Patch[];
    inversePatches: Patch[];
  } {
    const [nextState, patches, inversePatches] = produce(this.state, updater, (p, ip) => [p, ip]);

    this.setState(nextState);

    return { patches, inversePatches };
  }

  /**
   * è®¢é˜…çŠ¶æ€å˜æ›´
   */
  subscribe(listener: (state: Schema) => void): () => void {
    this.listeners.add(listener);

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.listeners.delete(listener);
    };
  }

  /**
   * é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
   */
  private notifyListeners(): void {
    this.listeners.forEach((listener) => listener(this.state));
  }

  /**
   * å…‹éš†å½“å‰çŠ¶æ€ï¼ˆç”¨äºå¿«ç…§ï¼‰
   */
  cloneState(): Schema {
    return JSON.parse(JSON.stringify(this.state));
  }
}
```

---

#### 4. å…·ä½“ Command å®ç°ç¤ºä¾‹

```typescript
/**
 * å±æ€§æ›´æ–°å‘½ä»¤ï¼ˆå¯åˆå¹¶ï¼‰
 */
class UpdatePropertyCommand implements IMergeableCommand {
  readonly id: string;
  readonly type = 'UPDATE_PROPERTY';
  readonly description: string;
  readonly timestamp: number;
  readonly mergeWindow = 1000; // 1ç§’å†…çš„æ“ä½œå¯åˆå¹¶

  private patches: Patch[] = [];
  private inversePatches: Patch[] = [];

  constructor(
    private schemaManager: SchemaManager,
    private componentId: string,
    private propertyPath: string,
    private newValue: any,
    private oldValue?: any
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.description = `ä¿®æ”¹ ${componentId} çš„ ${propertyPath}`;
  }

  execute(): void {
    const fullPath = `components.${this.componentId}.${this.propertyPath}`;
    const { patches, inversePatches } = this.schemaManager.setProperty(fullPath, this.newValue);

    this.patches = patches;
    this.inversePatches = inversePatches;
  }

  undo(): void {
    this.schemaManager.applyPatches(this.inversePatches);
  }

  redo(): void {
    this.schemaManager.applyPatches(this.patches);
  }

  canMerge(command: ICommand): boolean {
    if (!(command instanceof UpdatePropertyCommand)) return false;

    return (
      command.componentId === this.componentId && command.propertyPath === this.propertyPath && command.timestamp - this.timestamp < this.mergeWindow
    );
  }

  merge(command: ICommand): void {
    if (!(command instanceof UpdatePropertyCommand)) return;

    // åˆå¹¶ï¼šä¿ç•™åˆå§‹ inversePatchesï¼Œæ›´æ–° patches å’Œ newValue
    this.newValue = command.newValue;
    this.patches = command.patches;
    // inversePatches ä¿æŒä¸å˜ï¼ˆæ¢å¤åˆ°æœ€åˆçŠ¶æ€ï¼‰
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      componentId: this.componentId,
      propertyPath: this.propertyPath,
      newValue: this.newValue,
      oldValue: this.oldValue,
      timestamp: this.timestamp
    };
  }
}

/**
 * æ·»åŠ ç»„ä»¶å‘½ä»¤
 */
class AddComponentCommand implements ICommand {
  readonly id: string;
  readonly type = 'ADD_COMPONENT';
  readonly description: string;
  readonly timestamp: number;

  private patches: Patch[] = [];
  private inversePatches: Patch[] = [];

  constructor(
    private schemaManager: SchemaManager,
    private component: ComponentSchema,
    private parentId?: string
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.description = `æ·»åŠ ç»„ä»¶ ${component.name}`;
  }

  execute(): void {
    const { patches, inversePatches } = this.schemaManager.update((draft) => {
      if (this.parentId) {
        // æ·»åŠ åˆ°æŒ‡å®šçˆ¶ç»„ä»¶
        draft.components[this.parentId].children.push(this.component);
      } else {
        // æ·»åŠ åˆ°æ ¹çº§
        draft.components[this.component.id] = this.component;
      }
    });

    this.patches = patches;
    this.inversePatches = inversePatches;
  }

  undo(): void {
    this.schemaManager.applyPatches(this.inversePatches);
  }

  redo(): void {
    this.schemaManager.applyPatches(this.patches);
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      component: this.component,
      parentId: this.parentId,
      timestamp: this.timestamp
    };
  }
}

/**
 * åˆ é™¤ç»„ä»¶å‘½ä»¤
 */
class DeleteComponentCommand implements ICommand {
  readonly id: string;
  readonly type = 'DELETE_COMPONENT';
  readonly description: string;
  readonly timestamp: number;

  private patches: Patch[] = [];
  private inversePatches: Patch[] = [];

  constructor(
    private schemaManager: SchemaManager,
    private componentId: string
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.description = `åˆ é™¤ç»„ä»¶ ${componentId}`;
  }

  execute(): void {
    const { patches, inversePatches } = this.schemaManager.update((draft) => {
      delete draft.components[this.componentId];
    });

    this.patches = patches;
    this.inversePatches = inversePatches;
  }

  undo(): void {
    this.schemaManager.applyPatches(this.inversePatches);
  }

  redo(): void {
    this.schemaManager.applyPatches(this.patches);
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      componentId: this.componentId,
      timestamp: this.timestamp
    };
  }
}

/**
 * æ–‡æœ¬è¾“å…¥å‘½ä»¤ï¼ˆå¯åˆå¹¶ï¼‰
 */
class TextInputCommand implements IMergeableCommand {
  readonly id: string;
  readonly type = 'TEXT_INPUT';
  readonly description: string;
  readonly timestamp: number;
  readonly mergeWindow = 500; // 500ms å†…çš„è¾“å…¥å¯åˆå¹¶

  private patches: Patch[] = [];
  private inversePatches: Patch[] = [];
  private text: string;

  constructor(
    private schemaManager: SchemaManager,
    private componentId: string,
    private fieldPath: string,
    text: string
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.text = text;
    this.description = `ç¼–è¾‘ ${componentId} æ–‡æœ¬`;
  }

  execute(): void {
    const fullPath = `components.${this.componentId}.${this.fieldPath}`;
    const { patches, inversePatches } = this.schemaManager.setProperty(fullPath, this.text);

    this.patches = patches;
    this.inversePatches = inversePatches;
  }

  undo(): void {
    this.schemaManager.applyPatches(this.inversePatches);
  }

  redo(): void {
    this.schemaManager.applyPatches(this.patches);
  }

  canMerge(command: ICommand): boolean {
    if (!(command instanceof TextInputCommand)) return false;

    return command.componentId === this.componentId && command.fieldPath === this.fieldPath && command.timestamp - this.timestamp < this.mergeWindow;
  }

  merge(command: ICommand): void {
    if (!(command instanceof TextInputCommand)) return;

    // åˆå¹¶æ–‡æœ¬ï¼ˆè¿½åŠ æ–°è¾“å…¥ï¼‰
    this.text = command.text;
    this.patches = command.patches;
    this.timestamp = command.timestamp;
    // inversePatches ä¿æŒä¸å˜ï¼ˆæ¢å¤åˆ°æœ€åˆæ–‡æœ¬ï¼‰
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      componentId: this.componentId,
      fieldPath: this.fieldPath,
      text: this.text,
      timestamp: this.timestamp
    };
  }
}

/**
 * æ‰¹é‡æ“ä½œå‘½ä»¤ï¼ˆç»„åˆæ¨¡å¼ï¼‰
 */
class BatchOperationCommand implements ICompositeCommand {
  readonly id: string;
  readonly type = 'BATCH_OPERATION';
  readonly description: string;
  readonly timestamp: number;
  readonly commands: ICommand[] = [];

  constructor(description: string = 'æ‰¹é‡æ“ä½œ') {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.description = description;
  }

  addCommand(command: ICommand): void {
    this.commands.push(command);
  }

  execute(): void {
    this.commands.forEach((cmd) => cmd.execute());
  }

  undo(): void {
    // åå‘æ’¤é”€ï¼ˆåæ‰§è¡Œçš„å…ˆæ’¤é”€ï¼‰
    for (let i = this.commands.length - 1; i >= 0; i--) {
      this.commands[i].undo();
    }
  }

  redo(): void {
    this.commands.forEach((cmd) => cmd.redo());
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      description: this.description,
      commands: this.commands.map((cmd) => cmd.serialize()),
      timestamp: this.timestamp
    };
  }
}
```

---

#### 5. é™æ€èµ„æºç‰ˆæœ¬ç®¡ç†ï¼ˆä¸»é¢˜ç¼–è¾‘å™¨æ ¸å¿ƒï¼‰

**èƒŒæ™¯è¯´æ˜**ï¼š

- ä¸»é¢˜æ–‡ä»¶ = XML + JSON + é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€åŠ¨ç”»ç­‰ï¼‰
- è¿è¡Œæ—¶å†…å­˜ï¼šè§£æåçš„ JSON + æ–‡ä»¶å¼•ç”¨ï¼ˆhash å­—ç¬¦ä¸²ï¼‰
- æ ¸å¿ƒæŒ‘æˆ˜ï¼šæ–‡ä»¶æ“ä½œçš„æ’¤é”€/é‡åšä¸èƒ½çœŸå®åˆ é™¤æ–‡ä»¶

**æ¶æ„è®¾è®¡**ï¼š

```typescript
/**
 * ===== æ ¸å¿ƒæ•°æ®ç»“æ„ =====
 */

/**
 * Schemaç»“æ„ï¼ˆè¿è¡Œæ—¶å†…å­˜ï¼‰
 *
 * æ³¨æ„ï¼šXMLå·²è§£æä¸ºJSONï¼Œæ–‡ä»¶åªå­˜hashå¼•ç”¨
 */
interface ThemeSchema {
  metadata: {
    projectId: string;
    themeName: string;
    // è§£æåçš„JSONæ•°æ®ï¼ˆä¸æ˜¯XMLå­—ç¬¦ä¸²ï¼‰
    xmlData: any;
    editorConfig: any;
    variables: Map<string, VariableDefinition>;
  };

  // æ–‡ä»¶å¼•ç”¨ï¼ˆåªå­˜hashï¼Œä¸å­˜äºŒè¿›åˆ¶å†…å®¹ï¼‰
  assets: {
    images: Map<string, ImageAssetRef>;
    animations: Map<string, AnimationAssetRef>;
  };
}

/**
 * å›¾ç‰‡èµ„æºå¼•ç”¨ï¼ˆå†…å­˜å ç”¨çº¦100 bytesï¼‰
 */
interface ImageAssetRef {
  hash: string; // SHA256 hashï¼ˆ64å­—ç¬¦ï¼‰
  androidPath: string; // Androidè§„èŒƒè·¯å¾„
}

/**
 * æ–‡ä»¶æ± å¼•ç”¨è®¡æ•°è¡¨ï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰
 */
interface RefCountTable {
  [hash: string]: {
    count: number; // å¼•ç”¨è®¡æ•°
    referencedBy: Set<string>; // å¼•ç”¨æ¥æºï¼ˆcommandIdåˆ—è¡¨ï¼‰
    zeroRefTimestamp?: number; // å½’é›¶æ—¶é—´ï¼ˆç”¨äºå»¶è¿ŸGCï¼‰
  };
}

/**
 * ===== æ–‡ä»¶æ± ç®¡ç†å™¨ =====
 */
class FilePoolManager {
  private poolDir: string; // æ–‡ä»¶æ± ç›®å½•
  private metadata: Map<string, FileMetadata> = new Map();
  private refCount: RefCountTable = {};

  /**
   * æ·»åŠ æ–‡ä»¶åˆ°æ± ï¼ˆCopy-on-Writeï¼‰
   */
  async addFile(sourcePath: string, androidPath: string, commandId: string): Promise<string> {
    // 1. è®¡ç®—æ–‡ä»¶hash
    const buffer = await fs.promises.readFile(sourcePath);
    const hash = crypto.createHash('sha256').update(buffer).digest('hex');

    // 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
    const poolPath = path.join(this.poolDir, `${hash}${path.extname(sourcePath)}`);
    if (!fs.existsSync(poolPath)) {
      await fs.promises.copyFile(sourcePath, poolPath);
      console.log(`[FilePool] New file added: ${hash.substring(0, 8)}`);
    } else {
      console.log(`[FilePool] File dedup: ${hash.substring(0, 8)}`);
    }

    // 3. å¢åŠ å¼•ç”¨è®¡æ•°
    this.addReference(hash, commandId);

    return hash;
  }

  /**
   * å¢åŠ å¼•ç”¨è®¡æ•°
   */
  addReference(hash: string, commandId: string): void {
    if (!this.refCount[hash]) {
      this.refCount[hash] = {
        count: 0,
        referencedBy: new Set()
      };
    }

    this.refCount[hash].referencedBy.add(commandId);
    this.refCount[hash].count = this.refCount[hash].referencedBy.size;
  }

  /**
   * å‡å°‘å¼•ç”¨è®¡æ•°
   */
  removeReference(hash: string, commandId: string): void {
    if (!this.refCount[hash]) return;

    this.refCount[hash].referencedBy.delete(commandId);
    this.refCount[hash].count = this.refCount[hash].referencedBy.size;

    // å¼•ç”¨å½’é›¶ï¼Œè®°å½•æ—¶é—´ï¼ˆç”¨äºå»¶è¿ŸGCï¼‰
    if (this.refCount[hash].count === 0) {
      this.refCount[hash].zeroRefTimestamp = Date.now();
    }
  }

  /**
   * è·å–æ–‡ä»¶è·¯å¾„
   */
  getFilePath(hash: string): string | null {
    const meta = this.metadata.get(hash);
    if (!meta) return null;

    const poolPath = path.join(this.poolDir, `${hash}${path.extname(meta.originalName)}`);
    return fs.existsSync(poolPath) ? poolPath : null;
  }

  /**
   * åƒåœ¾å›æ”¶
   */
  async garbageCollect(): Promise<GCReport> {
    const report = { deletedFiles: 0, reclaimedBytes: 0 };
    const now = Date.now();
    const gcDelay = 30 * 60 * 1000; // 30åˆ†é’Ÿ

    for (const [hash, meta] of this.metadata.entries()) {
      if (this.refCount[hash]?.count === 0) {
        const zeroRefSince = this.refCount[hash].zeroRefTimestamp || 0;

        // é›¶å¼•ç”¨è¶…è¿‡30åˆ†é’Ÿæ‰åˆ é™¤
        if (now - zeroRefSince > gcDelay) {
          const poolPath = path.join(this.poolDir, `${hash}${path.extname(meta.originalName)}`);

          if (fs.existsSync(poolPath)) {
            await fs.promises.unlink(poolPath);
            this.metadata.delete(hash);
            delete this.refCount[hash];

            report.deletedFiles++;
            report.reclaimedBytes += meta.size;
          }
        }
      }
    }

    return report;
  }
}

/**
 * ===== æ–‡ä»¶æ“ä½œå‘½ä»¤ =====
 */

/**
 * æ›¿æ¢èµ„æºå‘½ä»¤
 */
class ReplaceAssetCommand implements ICommand {
  readonly id: string;
  readonly type = 'REPLACE_ASSET';
  readonly description: string;
  readonly timestamp: number;

  private assetKey: string;
  private oldHash: string;
  private newHash: string;

  constructor(
    private schemaManager: SchemaManager,
    private filePool: FilePoolManager,
    assetKey: string,
    newFilePath: string
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.assetKey = assetKey;
    this.description = `æ›¿æ¢èµ„æº ${assetKey}`;

    // ä¿å­˜æ—§hash
    const currentAsset = schemaManager.getState().assets.images.get(assetKey);
    this.oldHash = currentAsset?.hash || '';
  }

  async execute(): Promise<void> {
    // 1. æ·»åŠ æ–°æ–‡ä»¶åˆ°æ± ï¼ˆæ–‡ä»¶IOï¼‰
    const currentAsset = this.schemaManager.getState().assets.images.get(this.assetKey);
    this.newHash = await this.filePool.addFile(newFilePath, currentAsset!.androidPath, this.id);

    // 2. ä¿®æ”¹Schemaä¸­çš„å¼•ç”¨ï¼ˆåªæ”¹å­—ç¬¦ä¸²ï¼‰
    this.schemaManager.update((draft) => {
      const asset = draft.assets.images.get(this.assetKey);
      if (asset) {
        asset.hash = this.newHash;
      }
    });

    // 3. è°ƒæ•´å¼•ç”¨è®¡æ•°
    this.filePool.removeReference(this.oldHash, this.id);
  }

  undo(): void {
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜å­˜åœ¨
    const filePath = this.filePool.getFilePath(this.oldHash);
    if (!filePath) {
      throw new Error(`æ— æ³•æ’¤é”€ï¼šæ–‡ä»¶å·²è¢«æ¸…ç† (hash: ${this.oldHash.substring(0, 8)})`);
    }

    // æ¢å¤æ—§hash
    this.schemaManager.update((draft) => {
      const asset = draft.assets.images.get(this.assetKey);
      if (asset) {
        asset.hash = this.oldHash;
      }
    });

    // è°ƒæ•´å¼•ç”¨è®¡æ•°
    this.filePool.addReference(this.oldHash, this.id);
    this.filePool.removeReference(this.newHash, this.id);
  }

  redo(): void {
    this.schemaManager.update((draft) => {
      const asset = draft.assets.images.get(this.assetKey);
      if (asset) {
        asset.hash = this.newHash;
      }
    });

    this.filePool.removeReference(this.oldHash, this.id);
    this.filePool.addReference(this.newHash, this.id);
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      assetKey: this.assetKey,
      oldHash: this.oldHash,
      newHash: this.newHash,
      timestamp: this.timestamp
    };
  }
}

/**
 * æ·»åŠ èµ„æºå‘½ä»¤
 */
class AddAssetCommand implements ICommand {
  readonly id: string;
  readonly type = 'ADD_ASSET';
  readonly description: string;
  readonly timestamp: number;

  private assetKey: string;
  private hash: string;
  private androidPath: string;

  constructor(
    private schemaManager: SchemaManager,
    private filePool: FilePoolManager,
    assetKey: string,
    sourcePath: string,
    androidPath: string
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.assetKey = assetKey;
    this.androidPath = androidPath;
    this.description = `æ·»åŠ èµ„æº ${assetKey}`;
  }

  async execute(): Promise<void> {
    this.hash = await this.filePool.addFile(sourcePath, this.androidPath, this.id);

    this.schemaManager.update((draft) => {
      draft.assets.images.set(this.assetKey, {
        hash: this.hash,
        androidPath: this.androidPath
      });
    });
  }

  undo(): void {
    this.schemaManager.update((draft) => {
      draft.assets.images.delete(this.assetKey);
    });
    this.filePool.removeReference(this.hash, this.id);
  }

  redo(): void {
    this.schemaManager.update((draft) => {
      draft.assets.images.set(this.assetKey, {
        hash: this.hash,
        androidPath: this.androidPath
      });
    });
    this.filePool.addReference(this.hash, this.id);
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      assetKey: this.assetKey,
      hash: this.hash,
      androidPath: this.androidPath,
      timestamp: this.timestamp
    };
  }
}

/**
 * åˆ é™¤èµ„æºå‘½ä»¤
 */
class DeleteAssetCommand implements ICommand {
  readonly id: string;
  readonly type = 'DELETE_ASSET';
  readonly description: string;
  readonly timestamp: number;

  private assetKey: string;
  private deletedAsset: ImageAssetRef;

  constructor(
    private schemaManager: SchemaManager,
    private filePool: FilePoolManager,
    assetKey: string
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.assetKey = assetKey;
    this.description = `åˆ é™¤èµ„æº ${assetKey}`;

    const asset = schemaManager.getState().assets.images.get(assetKey);
    this.deletedAsset = asset ? { ...asset } : { hash: '', androidPath: '' };
  }

  execute(): void {
    this.schemaManager.update((draft) => {
      draft.assets.images.delete(this.assetKey);
    });
    this.filePool.removeReference(this.deletedAsset.hash, this.id);
  }

  undo(): void {
    this.schemaManager.update((draft) => {
      draft.assets.images.set(this.assetKey, this.deletedAsset);
    });
    this.filePool.addReference(this.deletedAsset.hash, this.id);
  }

  redo(): void {
    this.execute();
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      assetKey: this.assetKey,
      deletedAsset: this.deletedAsset,
      timestamp: this.timestamp
    };
  }
}

/**
 * ===== è‡ªåŠ¨åƒåœ¾å›æ”¶ =====
 */
class AutoGarbageCollector {
  private filePool: FilePoolManager;
  private gcInterval = 5 * 60 * 1000; // 5åˆ†é’Ÿ
  private maxZeroRefFiles = 50;

  start(): void {
    setInterval(async () => {
      const stats = this.filePool.getStats();

      if (stats.zeroRefFiles > this.maxZeroRefFiles) {
        const report = await this.filePool.garbageCollect();
        console.log(`[AutoGC] Deleted ${report.deletedFiles} files, reclaimed ${(report.reclaimedBytes / 1024 / 1024).toFixed(2)} MB`);
      }
    }, this.gcInterval);
  }
}

/**
 * ===== é¡¹ç›®åŠ è½½ï¼šé‡å»ºå¼•ç”¨è®¡æ•° =====
 */
class ProjectLoader {
  /**
   * ä»ä¿å­˜çš„å†å²é‡å»ºå¼•ç”¨è®¡æ•°
   */
  private async rebuildRefCount(historyData: any, filePool: FilePoolManager): Promise<void> {
    filePool.clearRefCount();

    // éå†UndoStack
    for (const cmdData of historyData.undoStack) {
      this.registerFileReferences(cmdData, filePool);
    }

    // éå†RedoStack
    for (const cmdData of historyData.redoStack) {
      this.registerFileReferences(cmdData, filePool);
    }

    await filePool.saveRefCount();
  }

  /**
   * ä»å‘½ä»¤æ•°æ®ä¸­æå–æ–‡ä»¶å¼•ç”¨
   */
  private registerFileReferences(cmdData: any, filePool: FilePoolManager): void {
    switch (cmdData.type) {
      case 'ADD_ASSET':
        filePool.addReference(cmdData.hash, cmdData.id);
        break;

      case 'REPLACE_ASSET':
        filePool.addReference(cmdData.newHash, cmdData.id);
        if (cmdData.oldHash) {
          filePool.addReference(cmdData.oldHash, cmdData.id);
        }
        break;

      case 'DELETE_ASSET':
        filePool.addReference(cmdData.deletedAsset.hash, cmdData.id);
        break;
    }
  }
}
```

**æ ¸å¿ƒæœºåˆ¶æ€»ç»“**ï¼š

| æœºåˆ¶             | å®ç°æ–¹å¼              | è§£å†³çš„é—®é¢˜                   |
| ---------------- | --------------------- | ---------------------------- |
| **å†…å®¹å¯»å€å­˜å‚¨** | SHA256 hash å‘½å      | è‡ªåŠ¨å»é‡ï¼Œç‰ˆæœ¬è¿½è¸ª           |
| **å¼•ç”¨è®¡æ•°**     | commandId â†’ hash æ˜ å°„ | ç²¾ç¡®çŸ¥é“æ–‡ä»¶ä½•æ—¶å¯åˆ é™¤       |
| **å»¶è¿Ÿ GC**      | é›¶å¼•ç”¨ä¿ç•™ 30 åˆ†é’Ÿ    | æ”¯æŒçŸ­æœŸæ’¤é”€                 |
| **å¼•ç”¨é‡å»º**     | åŠ è½½æ—¶éå†å†å²å‘½ä»¤    | æ¢å¤å¼•ç”¨è®¡æ•°                 |
| **æ–‡ä»¶å»é‡**     | ç›¸åŒå†…å®¹åªå­˜ä¸€ä»½      | èŠ‚çœç©ºé—´ï¼ˆå¤šä¸ªç‰ˆæœ¬ç”¨åŒä¸€å›¾ï¼‰ |

**æ€§èƒ½æ•°æ®**ï¼š

```
æ“ä½œ          è€—æ—¶         è¯´æ˜
æ·»åŠ æ–‡ä»¶    100ms      æ–‡ä»¶IOï¼ˆå¼‚æ­¥ï¼Œä¸»è¿›ç¨‹ï¼‰
æ›¿æ¢æ–‡ä»¶    < 1ms      åªæ”¹å¼•ç”¨å­—ç¬¦ä¸²
åˆ é™¤æ–‡ä»¶    < 1ms      åªæ”¹å¼•ç”¨å­—ç¬¦ä¸²
æ’¤é”€/é‡åš   < 1ms      åˆ‡æ¢hashå¼•ç”¨
GCæ¸…ç†      10-50ms    åˆ é™¤é›¶å¼•ç”¨æ–‡ä»¶
```

**å†…å­˜å ç”¨å¯¹æ¯”**ï¼š

```
åªå­˜å¼•ç”¨ï¼š    ~130KBï¼ˆXML JSON + hashå¼•ç”¨ï¼‰
åŠ è½½æ–‡ä»¶å†…å®¹ï¼š ~60MBï¼ˆ30å¼ å›¾ç‰‡ï¼‰
èŠ‚çœæ¯”ä¾‹ï¼š    99.8%
```

---

#### 6. æ“ä½œåˆå¹¶ä¸è·¯å¾„æ£€æµ‹æœºåˆ¶

**æ ¸å¿ƒé—®é¢˜**ï¼š

- ç”¨æˆ·è¿ç»­æ‹–åŠ¨æ»‘å—ï¼Œ16ms å†…äº§ç”Ÿå¤šä¸ªä¿®æ”¹åŒä¸€å±æ€§çš„æ“ä½œ
- å¦‚ä½•åˆ¤å®šè¿™äº›æ“ä½œå¯ä»¥åˆå¹¶ï¼Ÿ
- å¦‚ä½•å¿«é€Ÿå®šä½ JSON ä¸­è¦ä¿®æ”¹çš„å±æ€§ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šåŸºäº Immer.js Patch çš„è·¯å¾„æ£€æµ‹ä¸æ™ºèƒ½åˆå¹¶

```typescript
/**
 * ===== Immer Patch ç»“æ„ =====
 */
interface ImmerPatch {
  op: 'replace' | 'add' | 'remove';
  path: string[]; // è·¯å¾„æ•°ç»„ ["button1", "style", "color"]
  value?: any;
}

/**
 * ç¤ºä¾‹ï¼šä¿®æ”¹æŒ‰é’®é¢œè‰²ç”Ÿæˆçš„Patch
 */
const examplePatch: ImmerPatch = {
  op: 'replace',
  path: ['button1', 'style', 'color'],
  value: '#ff0099'
};

/**
 * ===== è·¯å¾„å·¥å…·ç±» =====
 */
class PatchPathUtil {
  /**
   * è·¯å¾„è½¬å­—ç¬¦ä¸²ï¼ˆç”¨äºå¿«é€Ÿæ¯”è¾ƒï¼‰
   */
  static pathToString(path: string[]): string {
    return '/' + path.join('/');
    // ['button1', 'style', 'color'] â†’ "/button1/style/color"
  }

  /**
   * æ£€æŸ¥ä¸¤ä¸ªè·¯å¾„æ˜¯å¦ç›¸åŒ
   */
  static isSamePath(path1: string[], path2: string[]): boolean {
    if (path1.length !== path2.length) return false;
    return path1.every((key, i) => key === path2[i]);
  }

  /**
   * æ£€æŸ¥è·¯å¾„æ˜¯å¦å†²çª
   *
   * å†²çªå®šä¹‰ï¼š
   * 1. å®Œå…¨ç›¸åŒï¼š['a', 'b'] å’Œ ['a', 'b']
   * 2. çˆ¶å­å…³ç³»ï¼š['a'] å’Œ ['a', 'b']
   */
  static hasConflict(path1: string[], path2: string[]): boolean {
    const minLen = Math.min(path1.length, path2.length);

    for (let i = 0; i < minLen; i++) {
      if (path1[i] !== path2[i]) return false;
    }

    return true; // æœ‰çˆ¶å­å…³ç³»æˆ–å®Œå…¨ç›¸åŒ
  }

  /**
   * è·¯å¾„æ˜¯å¦ä¸ºå¦ä¸€ä¸ªè·¯å¾„çš„ç¥–å…ˆ
   */
  static isAncestorOf(ancestorPath: string[], descendantPath: string[]): boolean {
    if (ancestorPath.length >= descendantPath.length) return false;

    for (let i = 0; i < ancestorPath.length; i++) {
      if (ancestorPath[i] !== descendantPath[i]) return false;
    }

    return true;
  }
}

/**
 * ===== Patchåˆå¹¶å¼•æ“ =====
 */
class PatchMerger {
  /**
   * æ‰¹é‡åˆå¹¶Patchæ•°ç»„
   *
   * ç­–ç•¥ï¼šåŒè·¯å¾„çš„replaceæ“ä½œï¼Œåªä¿ç•™æœ€åä¸€ä¸ª
   */
  mergePatches(patches: ImmerPatch[]): ImmerPatch[] {
    if (patches.length <= 1) return patches;

    // ä½¿ç”¨MapæŒ‰è·¯å¾„åˆ†ç»„
    const pathMap = new Map<string, ImmerPatch>();

    for (const patch of patches) {
      const pathKey = PatchPathUtil.pathToString(patch.path);

      if (patch.op === 'replace') {
        // replaceæ“ä½œï¼šåè€…è¦†ç›–å‰è€…
        pathMap.set(pathKey, patch);
      } else if (patch.op === 'add') {
        // addæ“ä½œï¼šå¦‚æœä¹‹å‰æœ‰removeï¼ŒæŠµæ¶ˆ
        const existing = pathMap.get(pathKey);
        if (existing && existing.op === 'remove') {
          pathMap.delete(pathKey); // æŠµæ¶ˆ
        } else {
          pathMap.set(pathKey, patch);
        }
      } else if (patch.op === 'remove') {
        // removeæ“ä½œï¼šå¦‚æœä¹‹å‰æœ‰addï¼ŒæŠµæ¶ˆ
        const existing = pathMap.get(pathKey);
        if (existing && existing.op === 'add') {
          pathMap.delete(pathKey); // æŠµæ¶ˆ
        } else {
          pathMap.set(pathKey, patch);
        }
      }
    }

    return Array.from(pathMap.values());
  }

  /**
   * æ™ºèƒ½åˆå¹¶ï¼šè§£å†³çˆ¶å­è·¯å¾„å†²çª
   *
   * ç¤ºä¾‹ï¼š
   * - å…ˆä¿®æ”¹ ['button1'] ï¼ˆæ•´ä¸ªå¯¹è±¡ï¼‰
   * - åä¿®æ”¹ ['button1', 'color'] ï¼ˆå¯¹è±¡çš„å±æ€§ï¼‰
   * ç»“æœï¼šä¿ç•™åè€…ï¼ˆæ›´å…·ä½“ï¼‰
   */
  smartMerge(patches: ImmerPatch[]): ImmerPatch[] {
    // 1. å…ˆæŒ‰è·¯å¾„åˆå¹¶åŒè·¯å¾„æ“ä½œ
    const merged = this.mergePatches(patches);

    // 2. è§£å†³çˆ¶å­è·¯å¾„å†²çª
    const result: ImmerPatch[] = [];

    for (let i = 0; i < merged.length; i++) {
      let shouldKeep = true;

      for (let j = 0; j < merged.length; j++) {
        if (i === j) continue;

        // å¦‚æœiæ˜¯jçš„ç¥–å…ˆï¼Œåˆ™ä¸¢å¼ƒiï¼ˆä¿ç•™æ›´å…·ä½“çš„ï¼‰
        if (PatchPathUtil.isAncestorOf(merged[i].path, merged[j].path)) {
          shouldKeep = false;
          break;
        }
      }

      if (shouldKeep) {
        result.push(merged[i]);
      }
    }

    return result;
  }
}

/**
 * ===== Commandå±‚çš„åˆå¹¶å®ç° =====
 */
class UpdatePropertyCommand implements IMergeableCommand {
  readonly id: string;
  readonly type = 'UPDATE_PROPERTY';
  readonly description: string;
  readonly timestamp: number;
  readonly mergeWindow = 500;

  private patches: ImmerPatch[] = [];
  private inversePatches: ImmerPatch[] = [];
  private targetPaths: Set<string> = new Set();

  constructor(
    private schemaManager: SchemaManager,
    private patchMerger: PatchMerger
  ) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
  }

  execute(): void {
    const [nextState, patches, inversePatches] = produce(
      this.schemaManager.getState(),
      (draft) => {
        // ç”¨æˆ·çš„ä¿®æ”¹é€»è¾‘
      },
      (p, ip) => [p, ip]
    );

    this.patches = patches;
    this.inversePatches = inversePatches;

    // æå–è·¯å¾„ä¿¡æ¯ï¼ˆç”¨äºåˆå¹¶åˆ¤æ–­ï¼‰
    this.targetPaths = new Set(patches.map((p) => PatchPathUtil.pathToString(p.path)));

    this.schemaManager.setState(nextState);
  }

  undo(): void {
    this.schemaManager.applyPatches(this.inversePatches);
  }

  redo(): void {
    this.schemaManager.applyPatches(this.patches);
  }

  /**
   * åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆå¹¶
   */
  canMerge(command: ICommand): boolean {
    if (!(command instanceof UpdatePropertyCommand)) return false;

    // 1. æ£€æŸ¥æ—¶é—´çª—å£
    if (command.timestamp - this.timestamp > this.mergeWindow) {
      return false;
    }

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰è·¯å¾„é‡å 
    return Array.from(command.targetPaths).some((path) => this.targetPaths.has(path));
  }

  /**
   * åˆå¹¶å¦ä¸€ä¸ªå‘½ä»¤
   */
  merge(command: ICommand): void {
    if (!(command instanceof UpdatePropertyCommand)) return;

    // 1. åˆå¹¶Patches
    const allPatches = [...this.patches, ...command.patches];
    this.patches = this.patchMerger.smartMerge(allPatches);

    // 2. inversePatchesä¿æŒä¸å˜ï¼ˆæ¢å¤åˆ°æœ€åˆçŠ¶æ€ï¼‰

    // 3. æ›´æ–°å…ƒä¿¡æ¯
    this.timestamp = command.timestamp;
    this.targetPaths = new Set([...this.targetPaths, ...command.targetPaths]);
    this.description = `æ‰¹é‡ä¿®æ”¹ (${this.targetPaths.size}ä¸ªå±æ€§)`;
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      patches: this.patches,
      inversePatches: this.inversePatches,
      timestamp: this.timestamp
    };
  }
}

/**
 * ===== æ‰¹é‡æ›´æ–°ç®¡ç†å™¨ =====
 */
class BatchUpdateManager {
  private pendingPatches: ImmerPatch[] = [];
  private patchMerger = new PatchMerger();
  private flushTimer: NodeJS.Timeout | null = null;

  /**
   * æ·»åŠ Patchåˆ°é˜Ÿåˆ—
   */
  addPatch(patch: ImmerPatch): void {
    this.pendingPatches.push(patch);
    this.scheduleFlush();
  }

  /**
   * è°ƒåº¦åˆ·æ–°ï¼ˆ16ms = 1å¸§ï¼‰
   */
  private scheduleFlush(): void {
    if (this.flushTimer) {
      clearTimeout(this.flushTimer);
    }

    this.flushTimer = setTimeout(() => {
      this.flush();
    }, 16);
  }

  /**
   * åˆ·æ–°ï¼šåˆå¹¶å¹¶åº”ç”¨æ‰€æœ‰Patches
   */
  private flush(): void {
    if (this.pendingPatches.length === 0) return;

    console.log(`[BatchUpdate] Flushing ${this.pendingPatches.length} patches...`);

    // åˆå¹¶Patches
    const mergedPatches = this.patchMerger.smartMerge(this.pendingPatches);

    console.log(
      `[BatchUpdate] Merged to ${mergedPatches.length} patches (${((1 - mergedPatches.length / this.pendingPatches.length) * 100).toFixed(
        1
      )}% reduction)`
    );

    // åˆ›å»ºå¹¶æ‰§è¡Œå‘½ä»¤
    const command = new BatchedUpdateCommand(mergedPatches, this.schemaManager);
    historyManager.execute(command);

    // æ¸…ç©ºé˜Ÿåˆ—
    this.pendingPatches = [];
    this.flushTimer = null;
  }

  /**
   * å¼ºåˆ¶ç«‹å³åˆ·æ–°
   */
  forceFlush(): void {
    if (this.flushTimer) {
      clearTimeout(this.flushTimer);
      this.flushTimer = null;
    }
    this.flush();
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
/**
 * åœºæ™¯1ï¼šç”¨æˆ·æ‹–åŠ¨æ»‘å—ï¼ˆè¿ç»­ä¿®æ”¹åŒä¸€å±æ€§ï¼‰
 */
const batchManager = new BatchUpdateManager();

// 16mså†…è§¦å‘4æ¬¡
batchManager.addPatch({
  op: 'replace',
  path: ['button1', 'style', 'color'],
  value: '#ff0000'
});
batchManager.addPatch({
  op: 'replace',
  path: ['button1', 'style', 'color'],
  value: '#ff0033'
});
batchManager.addPatch({
  op: 'replace',
  path: ['button1', 'style', 'color'],
  value: '#ff0066'
});
batchManager.addPatch({
  op: 'replace',
  path: ['button1', 'style', 'color'],
  value: '#ff0099'
});

// è‡ªåŠ¨åˆå¹¶ä¸º1ä¸ªpatch: color â†’ #ff0099
// å†å²è®°å½•åªæœ‰1æ¡

/**
 * åœºæ™¯2ï¼šæ‰¹é‡å¯¹é½ï¼ˆä¿®æ”¹å¤šä¸ªç»„ä»¶ï¼‰
 */
editor.transaction('æ‰¹é‡å¯¹é½', () => {
  ['button1', 'button2', 'button3'].forEach((id) => {
    batchManager.addPatch({
      op: 'replace',
      path: [id, 'x'],
      value: 100
    });
  });
});

// ç»“æœï¼š3ä¸ªpatchï¼ˆä¸åŒè·¯å¾„ï¼Œä¸åˆå¹¶ï¼‰
// å†å²è®°å½•ï¼š1æ¡ï¼ˆåŒ…å«3ä¸ªpatchï¼‰
```

**åˆå¹¶åˆ¤å®šæ¡ä»¶**ï¼š

```typescript
function canMerge(cmd1, cmd2): boolean {
  return (
    // 1. æ—¶é—´çª—å£ï¼ˆ500mså†…ï¼‰
    cmd2.timestamp - cmd1.timestamp < 500 &&
    // 2. è·¯å¾„ç›¸åŒ
    PatchPathUtil.isSamePath(cmd1.path, cmd2.path) &&
    // 3. æ“ä½œç±»å‹ç›¸åŒ
    cmd1.op === cmd2.op &&
    // 4. åªåˆå¹¶replaceæ“ä½œ
    cmd1.op === 'replace'
  );
}
```

**å¿«é€ŸæŸ¥æ‰¾æœºåˆ¶**ï¼š

```typescript
// Immerçš„Patchç›´æ¥åŒ…å«ç²¾ç¡®è·¯å¾„
const patch = {
  path: ['button1', 'style', 'color'], // â† ç²¾ç¡®å®šä½
  value: '#ff0099'
};

// åº”ç”¨æ—¶O(n)å¤æ‚åº¦ï¼Œn=è·¯å¾„æ·±åº¦
let target = draft;
for (const key of patch.path.slice(0, -1)) {
  target = target[key];
}
target[patch.path[patch.path.length - 1]] = patch.value;
```

**æ€§èƒ½æ•°æ®**ï¼š

| åœºæ™¯                   | æ— åˆå¹¶             | æœ‰åˆå¹¶                | æ”¹å–„  |
| ---------------------- | ------------------ | --------------------- | ----- |
| **è¿ç»­ä¿®æ”¹ 100 æ¬¡**    | 100 æ¡å†å²<br>20KB | 1 æ¡å†å²<br>200 bytes | 99% â†“ |
| **æ‰¹é‡ä¿®æ”¹ 50 ä¸ªç»„ä»¶** | 50 æ¡å†å²          | 1 æ¡å†å²              | 98% â†“ |
| **åˆå¹¶ç®—æ³•è€—æ—¶**       | -                  | 2ms (1000 ä¸ª patch)   | O(n)  |

---

#### 7. Command Factoryï¼ˆå·¥å‚æ¨¡å¼ï¼‰

```typescript
/**
 * å‘½ä»¤å·¥å‚ - ç”¨äºåˆ›å»ºå’Œååºåˆ—åŒ–å‘½ä»¤
 */
class CommandFactory {
  private schemaManager: SchemaManager;
  private fileManager: FileManager;

  constructor(schemaManager: SchemaManager, fileManager: FileManager) {
    this.schemaManager = schemaManager;
    this.fileManager = fileManager;
  }

  /**
   * ä»åºåˆ—åŒ–æ•°æ®åˆ›å»ºå‘½ä»¤
   */
  create(data: Record<string, any>): ICommand {
    switch (data.type) {
      case 'UPDATE_PROPERTY':
        return new UpdatePropertyCommand(this.schemaManager, data.componentId, data.propertyPath, data.newValue, data.oldValue);

      case 'ADD_COMPONENT':
        return new AddComponentCommand(this.schemaManager, data.component, data.parentId);

      case 'DELETE_COMPONENT':
        return new DeleteComponentCommand(this.schemaManager, data.componentId);

      case 'TEXT_INPUT':
        return new TextInputCommand(this.schemaManager, data.componentId, data.fieldPath, data.text);

      case 'BATCH_OPERATION':
        const batch = new BatchOperationCommand(data.description);
        data.commands.forEach((cmdData: any) => {
          batch.addCommand(this.create(cmdData));
        });
        return batch;

      case 'REPLACE_FILE':
        return new ReplaceFileCommand(this.schemaManager, data.componentId, data.filePath, data.oldFileHash, data.newFileHash, this.fileManager);

      default:
        throw new Error(`Unknown command type: ${data.type}`);
    }
  }
}
```

---

#### 6. ä¸ Electron é›†æˆï¼ˆæŒä¹…åŒ–ï¼‰

```typescript
/**
 * å†å²æŒä¹…åŒ–ç®¡ç†å™¨ï¼ˆElectronï¼‰
 */
class HistoryPersistence {
  private tempDir: string;

  constructor() {
    // ä½¿ç”¨ Electron app.getPath('temp')
    this.tempDir = path.join(app.getPath('temp'), 'theme-editor-history');
    this.ensureTempDir();
  }

  /**
   * ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
   */
  private ensureTempDir(): void {
    if (!fs.existsSync(this.tempDir)) {
      fs.mkdirSync(this.tempDir, { recursive: true });
    }
  }

  /**
   * ä¿å­˜å†å²åˆ°ç£ç›˜
   */
  async save(history: HistoryManager, projectId: string): Promise<void> {
    const filePath = path.join(this.tempDir, `${projectId}.json`);
    const data = history.serialize();

    await fs.promises.writeFile(filePath, data, 'utf-8');
  }

  /**
   * ä»ç£ç›˜åŠ è½½å†å²
   */
  async load(projectId: string, commandFactory: CommandFactory): Promise<HistoryManager | null> {
    const filePath = path.join(this.tempDir, `${projectId}.json`);

    if (!fs.existsSync(filePath)) {
      return null;
    }

    const data = await fs.promises.readFile(filePath, 'utf-8');
    return HistoryManager.deserialize(data, commandFactory);
  }

  /**
   * æ¸…ç†ä¸´æ—¶å†å²æ–‡ä»¶
   */
  async cleanup(projectId: string): Promise<void> {
    const filePath = path.join(this.tempDir, `${projectId}.json`);

    if (fs.existsSync(filePath)) {
      await fs.promises.unlink(filePath);
    }
  }

  /**
   * æ¸…ç†æ‰€æœ‰è¿‡æœŸçš„å†å²æ–‡ä»¶ï¼ˆè¶…è¿‡ 7 å¤©ï¼‰
   */
  async cleanupExpired(): Promise<void> {
    const files = await fs.promises.readdir(this.tempDir);
    const now = Date.now();
    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7å¤©

    for (const file of files) {
      const filePath = path.join(this.tempDir, file);
      const stats = await fs.promises.stat(filePath);

      if (now - stats.mtimeMs > maxAge) {
        await fs.promises.unlink(filePath);
      }
    }
  }
}
```

---

#### 7. å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

```typescript
/**
 * ä¸»ç¼–è¾‘å™¨ç±» - é›†æˆæ‰€æœ‰æ¨¡å—
 */
class ThemeEditor {
  private schemaManager: SchemaManager;
  private historyManager: HistoryManager;
  private fileManager: FileManager;
  private commandFactory: CommandFactory;
  private persistence: HistoryPersistence;

  constructor(initialSchema: Schema) {
    // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
    this.schemaManager = new SchemaManager(initialSchema);
    this.fileManager = new FileManager();
    this.commandFactory = new CommandFactory(this.schemaManager, this.fileManager);

    this.historyManager = new HistoryManager({
      maxHistorySize: 100,
      snapshotInterval: 20,
      enableAutoMerge: true
    });

    this.persistence = new HistoryPersistence();

    // è¿æ¥ HistoryManager å’Œ SchemaManager
    this.historyManager.on('capture-state', () => {
      return this.schemaManager.cloneState();
    });

    this.historyManager.on('restore-state', (state) => {
      this.schemaManager.setState(state);
    });

    // ç›‘å¬å†å²çŠ¶æ€å˜åŒ–
    this.historyManager.on('state-change', (state) => {
      this.updateUI(state);
    });
  }

  /**
   * ä¿®æ”¹ç»„ä»¶å±æ€§
   */
  updateComponentProperty(componentId: string, propertyPath: string, value: any): void {
    const oldValue = this.schemaManager.getProperty(`components.${componentId}.${propertyPath}`);

    const command = new UpdatePropertyCommand(this.schemaManager, componentId, propertyPath, value, oldValue);

    this.historyManager.execute(command);
  }

  /**
   * æ·»åŠ ç»„ä»¶
   */
  addComponent(component: ComponentSchema, parentId?: string): void {
    const command = new AddComponentCommand(this.schemaManager, component, parentId);

    this.historyManager.execute(command);
  }

  /**
   * åˆ é™¤ç»„ä»¶
   */
  deleteComponent(componentId: string): void {
    const command = new DeleteComponentCommand(this.schemaManager, componentId);

    this.historyManager.execute(command);
  }

  /**
   * æ‰¹é‡æ“ä½œ
   */
  batchUpdate(operations: Array<() => ICommand>): void {
    const batch = new BatchOperationCommand('æ‰¹é‡ç¼–è¾‘');

    operations.forEach((op) => {
      batch.addCommand(op());
    });

    this.historyManager.execute(batch);
  }

  /**
   * æ’¤é”€
   */
  undo(steps: number = 1): void {
    this.historyManager.undo(steps);
  }

  /**
   * é‡åš
   */
  redo(steps: number = 1): void {
    this.historyManager.redo(steps);
  }

  /**
   * ä¿å­˜å†å²åˆ°ç£ç›˜
   */
  async saveHistory(projectId: string): Promise<void> {
    await this.persistence.save(this.historyManager, projectId);
  }

  /**
   * åŠ è½½å†å²
   */
  async loadHistory(projectId: string): Promise<void> {
    const history = await this.persistence.load(projectId, this.commandFactory);

    if (history) {
      this.historyManager = history;
    }
  }

  /**
   * æ›´æ–° UIï¼ˆé€šçŸ¥æ¸²æŸ“å±‚ï¼‰
   */
  private updateUI(historyState: HistoryState): void {
    // è§¦å‘ UI æ›´æ–°ï¼ˆVue/React å“åº”å¼æ›´æ–°ï¼‰
    window.dispatchEvent(
      new CustomEvent('history-state-change', {
        detail: historyState
      })
    );
  }
}
```

---

### å†…å­˜ä¼˜åŒ–ç­–ç•¥

#### 1. Immer.js ç»“æ„å…±äº«

```typescript
// âŒ å®Œæ•´æ‹·è´ï¼ˆæ—§æ–¹æ¡ˆï¼‰
const snapshot = JSON.parse(JSON.stringify(schema)); // 5MB â†’ 5MB

// âœ… ç»“æ„å…±äº«ï¼ˆæ–°æ–¹æ¡ˆï¼‰
const [nextState, patches] = produce(
  schema,
  (draft) => {
    draft.components['header'].style.color = '#ff0000';
  },
  (p, ip) => [p, ip]
);

// patches å¤§å°: ~200 bytes
// {
//   "op": "replace",
//   "path": "/components/header/style/color",
//   "value": "#ff0000"
// }
```

**å†…å­˜å ç”¨å¯¹æ¯”**:

- 10 æ­¥å®Œæ•´å¿«ç…§: 50MB
- 10 æ­¥ Patches: ~2KBï¼ˆå‡å°‘ 99.996%ï¼‰

---

#### 2. å‘¨æœŸå¿«ç…§ + Patches æ··åˆ

```typescript
// æ¯ 20 ä¸ªæ“ä½œå­˜ä¸€ä¸ªå®Œæ•´å¿«ç…§
// å…¶ä»–æ“ä½œåªå­˜ Patches

// ç¤ºä¾‹ï¼š100 æ­¥å†å²
// - å¿«ç…§: ç¬¬ 0, 20, 40, 60, 80, 100 æ­¥ï¼ˆ6 ä¸ªå¿«ç…§ = 30MBï¼‰
// - Patches: å…¶ä»– 94 æ­¥ï¼ˆ~18.8KBï¼‰
// æ€»å†…å­˜: ~30MBï¼ˆæ¯” 500MB å‡å°‘ 94%ï¼‰

// æ’¤é”€ 50 æ­¥ï¼š
// 1. æ‰¾åˆ°æœ€è¿‘å¿«ç…§ï¼ˆç¬¬ 40 æ­¥ï¼‰
// 2. æ¢å¤å¿«ç…§ï¼ˆ0msï¼‰
// 3. é‡æ”¾ 40-50 çš„ 10 ä¸ª Patchesï¼ˆ< 10msï¼‰
// æ€»è€—æ—¶: < 10ms
```

---

#### 3. å¤§æ–‡ä»¶å¼•ç”¨å­˜å‚¨

```typescript
// âŒ å­˜å‚¨æ–‡ä»¶å†…å®¹
class BadFileCommand {
  private fileContent: Buffer; // 10MB å›¾ç‰‡
}

// âœ… åªå­˜å‚¨æ–‡ä»¶ hash
class GoodFileCommand {
  private fileHash: string; // 64 bytes SHA256

  undo() {
    // ä»ä¸´æ—¶ç›®å½•æ¢å¤
    const content = fileManager.getFile(this.fileHash);
  }
}
```

---

### æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡                | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹å–„                 |
| ------------------- | ------ | ------ | -------------------- |
| **å•æ¬¡æ’¤é”€å»¶è¿Ÿ**    | 120ms  | 8ms    | âš¡ 15x faster        |
| **å•æ¬¡é‡åšå»¶è¿Ÿ**    | 120ms  | 8ms    | âš¡ 15x faster        |
| **100 æ­¥å†å²å†…å­˜**  | 500MB  | 30MB   | ğŸ“¦ 94% less          |
| **æ“ä½œåˆå¹¶ç‡**      | 0%     | 85%    | ğŸ”— 85% fewer records |
| **å¤§é‡æ’¤é”€(50 æ­¥)** | 6s     | 50ms   | âš¡ 120x faster       |
| **å†å²åºåˆ—åŒ–**      | ä¸å¯è¡Œ | < 1s   | âœ… å¯è¡Œ              |

---

## âš¡ 8. æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥ï¼ˆç±»ä¼¼ React Batchingï¼‰

### é—®é¢˜åˆ†æ

ç”¨æˆ·é¢‘ç¹æ“ä½œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼š

```typescript
// âŒ é—®é¢˜ï¼šæ¯æ¬¡æ“ä½œéƒ½è§¦å‘é‡æ–°æ¸²æŸ“
editor.updateComponentProperty('header', 'style.color', '#ff0000'); // æ¸²æŸ“ 1
editor.updateComponentProperty('header', 'style.fontSize', '16px'); // æ¸²æŸ“ 2
editor.updateComponentProperty('header', 'style.padding', '10px'); // æ¸²æŸ“ 3
// è¿ç»­ 30 æ¬¡æ‹–åŠ¨æ»‘å— â†’ 30 æ¬¡æ¸²æŸ“ï¼ˆ16ms * 30 = 480msï¼‰
```

**æ€§èƒ½ç“¶é¢ˆ**ï¼š

1. æ¯æ¬¡ Schema å˜æ›´éƒ½è§¦å‘ç›‘å¬å™¨
2. ç›‘å¬å™¨é€šçŸ¥ UI æ¡†æ¶é‡æ–°æ¸²æŸ“
3. è™šæ‹Ÿ DOM diff + çœŸå® DOM æ›´æ–°è€—æ—¶
4. æµè§ˆå™¨é‡æ’ï¼ˆreflowï¼‰å’Œé‡ç»˜ï¼ˆrepaintï¼‰

---

### æ–¹æ¡ˆ 1: å¾®ä»»åŠ¡é˜Ÿåˆ— + requestAnimationFrame

**æ ¸å¿ƒæ€è·¯**ï¼šæ”¶é›†ä¸€å¸§å†…çš„æ‰€æœ‰å˜æ›´ï¼Œåœ¨ä¸‹ä¸€å¸§ç»Ÿä¸€æ¸²æŸ“

```typescript
/**
 * æ‰¹é‡æ›´æ–°ç®¡ç†å™¨ï¼ˆå€Ÿé‰´ React Schedulerï¼‰
 */
class BatchUpdateScheduler {
  private pendingUpdates: Set<() => void> = new Set();
  private isScheduled = false;

  /**
   * è°ƒåº¦æ›´æ–°ï¼ˆä¸ç«‹å³æ‰§è¡Œï¼‰
   */
  scheduleUpdate(callback: () => void): void {
    this.pendingUpdates.add(callback);

    if (!this.isScheduled) {
      this.isScheduled = true;
      requestAnimationFrame(() => this.flush());
    }
  }

  /**
   * å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰å¾…å¤„ç†æ›´æ–°
   */
  flush(): void {
    if (this.pendingUpdates.size === 0) return;

    const updates = Array.from(this.pendingUpdates);
    this.pendingUpdates.clear();
    this.isScheduled = false;

    // æ‰¹é‡æ‰§è¡Œæ‰€æœ‰æ›´æ–°
    updates.forEach((callback) => callback());
  }

  /**
   * å–æ¶ˆå¾…å¤„ç†æ›´æ–°
   */
  cancel(callback: () => void): void {
    this.pendingUpdates.delete(callback);
  }
}
```

**é›†æˆåˆ° SchemaManager**ï¼š

```typescript
class SchemaManager {
  private state: Schema;
  private listeners: Set<(state: Schema) => void> = new Set();
  private batchScheduler = new BatchUpdateScheduler();

  // æ–°å¢ï¼šæ‰¹é‡æ›´æ–°æ¨¡å¼æ ‡å¿—
  private isBatching = false;
  private pendingNotifications = false;

  /**
   * è®¾ç½®æ–°çŠ¶æ€ï¼ˆæ”¯æŒæ‰¹é‡æ¨¡å¼ï¼‰
   */
  setState(newState: Schema): void {
    this.state = newState;

    if (this.isBatching) {
      // æ‰¹é‡æ¨¡å¼ï¼šæ ‡è®°éœ€è¦é€šçŸ¥ï¼Œä½†ä¸ç«‹å³æ‰§è¡Œ
      this.pendingNotifications = true;
    } else {
      // æ­£å¸¸æ¨¡å¼ï¼šç«‹å³é€šçŸ¥
      this.notifyListeners();
    }
  }

  /**
   * é€šçŸ¥ç›‘å¬å™¨ï¼ˆå¯èƒ½è¢«å»¶è¿Ÿï¼‰
   */
  private notifyListeners(): void {
    this.batchScheduler.scheduleUpdate(() => {
      this.listeners.forEach((listener) => listener(this.state));
    });
  }

  /**
   * å¼€å¯æ‰¹é‡æ›´æ–°æ¨¡å¼
   */
  startBatch(): void {
    this.isBatching = true;
    this.pendingNotifications = false;
  }

  /**
   * ç»“æŸæ‰¹é‡æ›´æ–°å¹¶åˆ·æ–°
   */
  endBatch(): void {
    this.isBatching = false;

    if (this.pendingNotifications) {
      this.notifyListeners();
      this.pendingNotifications = false;
    }
  }

  /**
   * æ‰¹é‡æ‰§è¡Œå¤šä¸ªæ“ä½œï¼ˆè‡ªåŠ¨ç®¡ç†æ‰¹å¤„ç†ï¼‰
   */
  batch(fn: () => void): void {
    this.startBatch();
    try {
      fn();
    } finally {
      this.endBatch();
    }
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// âœ… æ–¹æ¡ˆ 1ï¼šæ‰‹åŠ¨æ‰¹é‡æ›´æ–°
editor.schemaManager.startBatch();
editor.updateComponentProperty('header', 'style.color', '#ff0000');
editor.updateComponentProperty('header', 'style.fontSize', '16px');
editor.updateComponentProperty('header', 'style.padding', '10px');
editor.schemaManager.endBatch();
// åªè§¦å‘ 1 æ¬¡æ¸²æŸ“ï¼ˆåœ¨ä¸‹ä¸€å¸§ï¼‰

// âœ… æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ batch åŒ…è£…å‡½æ•°
editor.schemaManager.batch(() => {
  editor.updateComponentProperty('header', 'style.color', '#ff0000');
  editor.updateComponentProperty('header', 'style.fontSize', '16px');
  editor.updateComponentProperty('header', 'style.padding', '10px');
});
// åªè§¦å‘ 1 æ¬¡æ¸²æŸ“
```

---

### æ–¹æ¡ˆ 2: Transaction äº‹åŠ¡æ¨¡å¼

**æ ¸å¿ƒæ€è·¯**ï¼šåƒæ•°æ®åº“äº‹åŠ¡ä¸€æ ·ï¼Œcommit æ—¶æ‰åº”ç”¨å˜æ›´

```typescript
/**
 * äº‹åŠ¡ç®¡ç†å™¨ï¼ˆDatabase-like Transactionï¼‰
 */
class TransactionManager {
  private activeTransaction: Transaction | null = null;

  /**
   * å¼€å§‹äº‹åŠ¡
   */
  beginTransaction(description: string = 'äº‹åŠ¡æ“ä½œ'): Transaction {
    if (this.activeTransaction) {
      throw new Error('å·²å­˜åœ¨æ´»è·ƒäº‹åŠ¡');
    }

    this.activeTransaction = new Transaction(description);
    return this.activeTransaction;
  }

  /**
   * æäº¤äº‹åŠ¡
   */
  commit(): void {
    if (!this.activeTransaction) {
      throw new Error('æ²¡æœ‰æ´»è·ƒäº‹åŠ¡');
    }

    this.activeTransaction.commit();
    this.activeTransaction = null;
  }

  /**
   * å›æ»šäº‹åŠ¡
   */
  rollback(): void {
    if (!this.activeTransaction) {
      throw new Error('æ²¡æœ‰æ´»è·ƒäº‹åŠ¡');
    }

    this.activeTransaction.rollback();
    this.activeTransaction = null;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
   */
  isInTransaction(): boolean {
    return this.activeTransaction !== null;
  }

  /**
   * è·å–å½“å‰äº‹åŠ¡
   */
  getCurrentTransaction(): Transaction | null {
    return this.activeTransaction;
  }
}

/**
 * äº‹åŠ¡å¯¹è±¡
 */
class Transaction {
  private commands: ICommand[] = [];
  private description: string;

  constructor(description: string) {
    this.description = description;
  }

  /**
   * æ·»åŠ å‘½ä»¤åˆ°äº‹åŠ¡
   */
  addCommand(command: ICommand): void {
    this.commands.push(command);
  }

  /**
   * æäº¤äº‹åŠ¡ï¼ˆæ‰§è¡Œæ‰€æœ‰å‘½ä»¤ï¼‰
   */
  commit(): void {
    // åˆ›å»ºæ‰¹é‡æ“ä½œå‘½ä»¤
    const batchCommand = new BatchOperationCommand(this.description);
    this.commands.forEach((cmd) => batchCommand.addCommand(cmd));

    // ä¸€æ¬¡æ€§æ‰§è¡Œ
    batchCommand.execute();

    // æ·»åŠ åˆ°å†å²ç®¡ç†å™¨
    historyManager.undoStack.push(batchCommand);
  }

  /**
   * å›æ»šäº‹åŠ¡ï¼ˆä¸¢å¼ƒæ‰€æœ‰å‘½ä»¤ï¼‰
   */
  rollback(): void {
    this.commands = [];
  }

  /**
   * è·å–å‘½ä»¤æ•°é‡
   */
  getCommandCount(): number {
    return this.commands.length;
  }
}
```

**é›†æˆåˆ° ThemeEditor**ï¼š

```typescript
class ThemeEditor {
  private transactionManager = new TransactionManager();

  /**
   * ä¿®æ”¹ç»„ä»¶å±æ€§ï¼ˆæ”¯æŒäº‹åŠ¡æ¨¡å¼ï¼‰
   */
  updateComponentProperty(componentId: string, propertyPath: string, value: any): void {
    const command = new UpdatePropertyCommand(this.schemaManager, componentId, propertyPath, value);

    // æ£€æŸ¥æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
    if (this.transactionManager.isInTransaction()) {
      this.transactionManager.getCurrentTransaction()!.addCommand(command);
    } else {
      this.historyManager.execute(command);
    }
  }

  /**
   * å¼€å§‹äº‹åŠ¡
   */
  beginTransaction(description?: string): void {
    this.transactionManager.beginTransaction(description);
    this.schemaManager.startBatch(); // åŒæ—¶å¼€å¯æ‰¹é‡æ›´æ–°
  }

  /**
   * æäº¤äº‹åŠ¡
   */
  commitTransaction(): void {
    this.transactionManager.commit();
    this.schemaManager.endBatch(); // ç»“æŸæ‰¹é‡æ›´æ–°ï¼Œè§¦å‘æ¸²æŸ“
  }

  /**
   * å›æ»šäº‹åŠ¡
   */
  rollbackTransaction(): void {
    this.transactionManager.rollback();
    this.schemaManager.endBatch();
  }

  /**
   * åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
   */
  transaction(description: string, fn: () => void): void {
    this.beginTransaction(description);
    try {
      fn();
      this.commitTransaction();
    } catch (error) {
      this.rollbackTransaction();
      throw error;
    }
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// âœ… äº‹åŠ¡æ¨¡å¼ï¼š30 æ¬¡æ‹–åŠ¨åªè§¦å‘ 1 æ¬¡æ¸²æŸ“ + 1 æ¡å†å²è®°å½•
editor.transaction('è°ƒæ•´ Header æ ·å¼', () => {
  editor.updateComponentProperty('header', 'style.color', '#ff0000');
  editor.updateComponentProperty('header', 'style.fontSize', '16px');
  editor.updateComponentProperty('header', 'style.padding', '10px');
});

// å¦‚æœä¸­é€”å‡ºé”™ï¼Œè‡ªåŠ¨å›æ»šï¼Œä¸å½±å“ Schema å’Œå†å²
```

---

### æ–¹æ¡ˆ 3: æ™ºèƒ½é˜²æŠ–/èŠ‚æµï¼ˆé’ˆå¯¹è¿ç»­æ“ä½œï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šæ£€æµ‹è¿ç»­æ“ä½œæ¨¡å¼ï¼Œè‡ªåŠ¨å»¶è¿Ÿæ¸²æŸ“

```typescript
/**
 * æ™ºèƒ½æ¸²æŸ“è°ƒåº¦å™¨ï¼ˆAuto-detect continuous operationsï¼‰
 */
class SmartRenderScheduler {
  private lastUpdateTime = 0;
  private updateCount = 0;
  private continuousThreshold = 3; // è¿ç»­ 3 æ¬¡æ“ä½œåˆ¤å®šä¸º"è¿ç»­æ¨¡å¼"
  private continuousWindow = 200; // 200ms å†…çš„æ“ä½œç®—è¿ç»­
  private debounceTimer: number | null = null;

  /**
   * è°ƒåº¦æ¸²æŸ“ï¼ˆè‡ªåŠ¨æ£€æµ‹æ¨¡å¼ï¼‰
   */
  scheduleRender(callback: () => void): void {
    const now = Date.now();
    const timeSinceLastUpdate = now - this.lastUpdateTime;

    // æ£€æµ‹æ˜¯å¦ä¸ºè¿ç»­æ“ä½œ
    if (timeSinceLastUpdate < this.continuousWindow) {
      this.updateCount++;
    } else {
      this.updateCount = 1;
    }

    this.lastUpdateTime = now;

    // å¦‚æœæ£€æµ‹åˆ°è¿ç»­æ“ä½œï¼Œä½¿ç”¨é˜²æŠ–
    if (this.updateCount >= this.continuousThreshold) {
      this.debouncedRender(callback);
    } else {
      // éè¿ç»­æ“ä½œï¼Œç«‹å³æ¸²æŸ“
      callback();
    }
  }

  /**
   * é˜²æŠ–æ¸²æŸ“ï¼ˆè¿ç»­æ“ä½œæ—¶ï¼‰
   */
  private debouncedRender(callback: () => void): void {
    if (this.debounceTimer !== null) {
      clearTimeout(this.debounceTimer);
    }

    this.debounceTimer = window.setTimeout(() => {
      callback();
      this.debounceTimer = null;
      this.updateCount = 0; // é‡ç½®è®¡æ•°å™¨
    }, 100); // 100ms é˜²æŠ–
  }

  /**
   * å¼ºåˆ¶ç«‹å³æ¸²æŸ“
   */
  flushRender(callback: () => void): void {
    if (this.debounceTimer !== null) {
      clearTimeout(this.debounceTimer);
      this.debounceTimer = null;
    }
    callback();
    this.updateCount = 0;
  }
}
```

**é›†æˆç¤ºä¾‹**ï¼š

```typescript
class SchemaManager {
  private smartScheduler = new SmartRenderScheduler();

  private notifyListeners(): void {
    this.smartScheduler.scheduleRender(() => {
      this.listeners.forEach((listener) => listener(this.state));
    });
  }

  // ç”¨æˆ·åœæ­¢æ“ä½œæ—¶ï¼ˆå¦‚ mouseupï¼‰ï¼Œå¼ºåˆ¶åˆ·æ–°
  forceRender(): void {
    this.smartScheduler.flushRender(() => {
      this.listeners.forEach((listener) => listener(this.state));
    });
  }
}
```

**UI é›†æˆç¤ºä¾‹**ï¼š

```typescript
// åœ¨é¢œè‰²é€‰æ‹©å™¨ç»„ä»¶ä¸­
class ColorPicker {
  handleSliderChange(value: string) {
    // æ‹–åŠ¨æ—¶ï¼šæ™ºèƒ½è°ƒåº¦ï¼ˆè‡ªåŠ¨é˜²æŠ–ï¼‰
    editor.updateComponentProperty('header', 'style.color', value);
  }

  handleSliderEnd(value: string) {
    // æ¾å¼€é¼ æ ‡ï¼šå¼ºåˆ¶ç«‹å³æ¸²æŸ“
    editor.schemaManager.forceRender();
  }
}
```

---

### æ–¹æ¡ˆ 4: ç©ºé—²è°ƒåº¦ï¼ˆIdle Schedulingï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šç”¨æˆ·äº¤äº’æ—¶æš‚åœæ‰¹é‡ä»»åŠ¡ï¼Œåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´å¤„ç†ï¼Œä¿è¯ UI å“åº”ä¼˜å…ˆ

**é—®é¢˜åœºæ™¯**ï¼š

```typescript
// ç”¨æˆ·æ­£åœ¨æ‹–æ‹½ç»„ä»¶ï¼ŒåŒæ—¶åå°æœ‰ 100 ä¸ªå¾…æ¸²æŸ“çš„ä»»åŠ¡
// å¦‚æœè¿™äº›ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹ â†’ æ‹–æ‹½ä¼šå¡é¡¿
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `requestIdleCallback` åœ¨æµè§ˆå™¨ç©ºé—²æ—¶å¤„ç†ä½ä¼˜å…ˆçº§ä»»åŠ¡

```typescript
/**
 * ç©ºé—²è°ƒåº¦å™¨ï¼ˆåŸºäº requestIdleCallbackï¼‰
 */
class IdleScheduler {
  private taskQueue: Array<() => void> = [];
  private isProcessing = false;
  private idleCallbackId: number | null = null;

  /**
   * æ·»åŠ ä½ä¼˜å…ˆçº§ä»»åŠ¡åˆ°é˜Ÿåˆ—
   */
  scheduleTask(task: () => void, priority: 'high' | 'low' = 'low'): void {
    if (priority === 'high') {
      // é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼šç«‹å³æ‰§è¡Œ
      task();
    } else {
      // ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼šåŠ å…¥é˜Ÿåˆ—
      this.taskQueue.push(task);
      this.scheduleIdleWork();
    }
  }

  /**
   * è°ƒåº¦ç©ºé—²å·¥ä½œ
   */
  private scheduleIdleWork(): void {
    if (this.isProcessing) return;

    this.isProcessing = true;

    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ requestIdleCallback
    if ('requestIdleCallback' in window) {
      this.idleCallbackId = requestIdleCallback(
        (deadline) => this.processTasksInIdle(deadline),
        { timeout: 1000 } // æœ€å¤š 1 ç§’åå¼ºåˆ¶æ‰§è¡Œ
      );
    } else {
      // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ setTimeout
      setTimeout(() => this.processTasksInIdle(), 0);
    }
  }

  /**
   * åœ¨ç©ºé—²æ—¶é—´å¤„ç†ä»»åŠ¡
   */
  private processTasksInIdle(deadline?: IdleDeadline): void {
    // åœ¨æœ‰å‰©ä½™æ—¶é—´ AND æœ‰å¾…å¤„ç†ä»»åŠ¡æ—¶ï¼ŒæŒç»­å¤„ç†
    while (
      this.taskQueue.length > 0 &&
      (deadline ? deadline.timeRemaining() > 1 : true) // è‡³å°‘ä¿ç•™ 1ms
    ) {
      const task = this.taskQueue.shift();
      if (task) {
        try {
          task();
        } catch (error) {
          console.error('[IdleScheduler] Task error:', error);
        }
      }
    }

    // å¦‚æœè¿˜æœ‰ä»»åŠ¡ï¼Œç»§ç»­è°ƒåº¦
    if (this.taskQueue.length > 0) {
      this.isProcessing = false;
      this.scheduleIdleWork();
    } else {
      this.isProcessing = false;
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡
   */
  clear(): void {
    this.taskQueue = [];
    if (this.idleCallbackId !== null) {
      cancelIdleCallback(this.idleCallbackId);
      this.idleCallbackId = null;
    }
    this.isProcessing = false;
  }

  /**
   * å¼ºåˆ¶ç«‹å³æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
   */
  flush(): void {
    while (this.taskQueue.length > 0) {
      const task = this.taskQueue.shift();
      if (task) task();
    }
    this.isProcessing = false;
  }

  /**
   * è·å–é˜Ÿåˆ—é•¿åº¦
   */
  getQueueSize(): number {
    return this.taskQueue.length;
  }
}
```

---

**é›†æˆåˆ° SchemaManager**ï¼š

```typescript
class SchemaManager {
  private idleScheduler = new IdleScheduler();

  /**
   * é€šçŸ¥ç›‘å¬å™¨ï¼ˆæ”¯æŒä¼˜å…ˆçº§ï¼‰
   */
  private notifyListeners(priority: 'high' | 'low' = 'low'): void {
    const notifyTask = () => {
      this.listeners.forEach((listener) => listener(this.state));
    };

    this.idleScheduler.scheduleTask(notifyTask, priority);
  }

  /**
   * è®¾ç½®æ–°çŠ¶æ€ï¼ˆæ”¯æŒä¼˜å…ˆçº§ï¼‰
   */
  setState(newState: Schema, priority?: 'high' | 'low'): void {
    this.state = newState;
    this.notifyListeners(priority);
  }

  /**
   * ç”¨æˆ·äº¤äº’æ—¶ï¼šæ¸…ç©ºä½ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—
   */
  onUserInteractionStart(): void {
    // ç”¨æˆ·å¼€å§‹äº¤äº’ï¼ˆå¦‚ mousedown, touchstartï¼‰
    // æš‚åœæ‰€æœ‰ä½ä¼˜å…ˆçº§æ¸²æŸ“ä»»åŠ¡
    console.log('[SchemaManager] User interaction started, pausing low-priority tasks');
  }

  /**
   * ç”¨æˆ·äº¤äº’ç»“æŸï¼šæ¢å¤ä»»åŠ¡å¤„ç†
   */
  onUserInteractionEnd(): void {
    // ç”¨æˆ·ç»“æŸäº¤äº’ï¼ˆå¦‚ mouseup, touchendï¼‰
    // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡
    console.log('[SchemaManager] User interaction ended, flushing tasks');
    this.idleScheduler.flush();
  }
}
```

---

**UI äº‹ä»¶ç›‘å¬é›†æˆ**ï¼š

```typescript
class ThemeEditor {
  private isUserInteracting = false;

  constructor(initialSchema: Schema) {
    // ... å…¶ä»–åˆå§‹åŒ–

    // ç›‘å¬å…¨å±€ç”¨æˆ·äº¤äº’äº‹ä»¶
    this.setupInteractionListeners();
  }

  /**
   * è®¾ç½®äº¤äº’ç›‘å¬å™¨
   */
  private setupInteractionListeners(): void {
    // é¼ æ ‡äº‹ä»¶
    document.addEventListener('mousedown', () => this.handleInteractionStart());
    document.addEventListener('mouseup', () => this.handleInteractionEnd());

    // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
    document.addEventListener('touchstart', () => this.handleInteractionStart());
    document.addEventListener('touchend', () => this.handleInteractionEnd());

    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', () => this.handleInteractionStart());
    document.addEventListener('keyup', () => this.handleInteractionEnd());
  }

  /**
   * ç”¨æˆ·å¼€å§‹äº¤äº’
   */
  private handleInteractionStart(): void {
    if (this.isUserInteracting) return;
    this.isUserInteracting = true;
    this.schemaManager.onUserInteractionStart();
  }

  /**
   * ç”¨æˆ·ç»“æŸäº¤äº’
   */
  private handleInteractionEnd(): void {
    // å»¶è¿Ÿ 100ms åˆ¤å®šäº¤äº’ç»“æŸï¼ˆé¿å…å¿«é€Ÿç‚¹å‡»è¯¯è§¦å‘ï¼‰
    setTimeout(() => {
      this.isUserInteracting = false;
      this.schemaManager.onUserInteractionEnd();
    }, 100);
  }
}
```

---

**é«˜çº§ï¼šä½¿ç”¨ Scheduler APIï¼ˆå®éªŒæ€§ï¼‰**

```typescript
/**
 * ä½¿ç”¨æµè§ˆå™¨ Scheduler APIï¼ˆæ›´ç²¾ç¡®çš„ä¼˜å…ˆçº§æ§åˆ¶ï¼‰
 */
class AdvancedScheduler {
  /**
   * è°ƒåº¦ä»»åŠ¡ï¼ˆæ”¯æŒå¤šç§ä¼˜å…ˆçº§ï¼‰
   */
  async scheduleTask(task: () => void, priority: 'user-blocking' | 'user-visible' | 'background'): Promise<void> {
    if ('scheduler' in window && 'postTask' in (window as any).scheduler) {
      // ä½¿ç”¨å®éªŒæ€§ Scheduler API
      await (window as any).scheduler.postTask(task, { priority });
    } else {
      // é™çº§æ–¹æ¡ˆ
      if (priority === 'user-blocking') {
        task(); // ç«‹å³æ‰§è¡Œ
      } else if (priority === 'user-visible') {
        requestAnimationFrame(task);
      } else {
        requestIdleCallback(task);
      }
    }
  }

  /**
   * æ£€æµ‹ç”¨æˆ·è¾“å…¥ï¼ˆFacebook isInputPending APIï¼‰
   */
  shouldYield(): boolean {
    if ('scheduler' in window && 'yield' in (window as any).scheduler) {
      // ä½¿ç”¨ isInputPending æ£€æµ‹æ˜¯å¦æœ‰å¾…å¤„ç†çš„ç”¨æˆ·è¾“å…¥
      return (navigator as any).scheduling?.isInputPending() || false;
    }
    return false;
  }

  /**
   * ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ
   */
  async yieldToMain(): Promise<void> {
    if ('scheduler' in window && 'yield' in (window as any).scheduler) {
      await (window as any).scheduler.yield();
    } else {
      // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ MessageChannel
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = () => resolve();
        channel.port2.postMessage(null);
      });
    }
  }
}
```

---

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// åœºæ™¯ 1: æ‰¹é‡æ›´æ–° 1000 ä¸ªç»„ä»¶ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
editor.transaction('æ‰¹é‡å¯¼å…¥ç»„ä»¶', async () => {
  const scheduler = new AdvancedScheduler();

  for (let i = 0; i < 1000; i++) {
    editor.addComponent(components[i]);

    // æ¯ 50 ä¸ªç»„ä»¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦è®©å‡ºæ§åˆ¶æƒ
    if (i % 50 === 0 && scheduler.shouldYield()) {
      await scheduler.yieldToMain(); // è®©å‡ºæ§åˆ¶æƒç»™ç”¨æˆ·äº¤äº’
    }
  }
});

// åœºæ™¯ 2: ç”¨æˆ·æ­£åœ¨æ‹–æ‹½ï¼Œåå°ä»»åŠ¡è‡ªåŠ¨æš‚åœ
// - ç”¨æˆ· mousedown â†’ handleInteractionStart() â†’ æš‚åœä½ä¼˜å…ˆçº§ä»»åŠ¡
// - ç”¨æˆ· mouseup â†’ handleInteractionEnd() â†’ æ¢å¤ä»»åŠ¡å¤„ç†

// åœºæ™¯ 3: ç´§æ€¥ä»»åŠ¡ï¼ˆå¦‚æ¨¡æ€æ¡†æ˜¾ç¤ºï¼‰ç«‹å³æ‰§è¡Œ
editor.schemaManager.setState(newState, 'high'); // é«˜ä¼˜å…ˆçº§ï¼Œç«‹å³æ¸²æŸ“
```

---

**æ€§èƒ½å¯¹æ¯”**ï¼š

| åœºæ™¯                   | æ— è°ƒåº¦                     | RAF Batching               | ç©ºé—²è°ƒåº¦                | æ”¹å–„                |
| ---------------------- | -------------------------- | -------------------------- | ----------------------- | ------------------- |
| **æ‰¹é‡å¯¼å…¥ 1000 ç»„ä»¶** | é˜»å¡ UI 5s<br>ç”¨æˆ·æ— æ³•æ“ä½œ | é˜»å¡ UI 5s<br>åˆ†å¸§ä½†ä»é˜»å¡ | ä¸é˜»å¡ UI<br>å¯éšæ—¶ä¸­æ–­ | âœ… ç”¨æˆ·ä½“éªŒè´¨çš„é£è·ƒ |
| **æ‹–æ‹½ + åå°æ¸²æŸ“**    | å¡é¡¿ä¸¥é‡<br>30 FPS         | è½»å¾®å¡é¡¿<br>50 FPS         | æµç•…<br>60 FPS          | âœ… å®Œå…¨æµç•…         |
| **å¤§å‹ Schema ä¿å­˜**   | é˜»å¡ 2s<br>ç•Œé¢å†»ç»“        | é˜»å¡ 2s                    | åå°å¤„ç†<br>ä¸å½±å“äº¤äº’  | âœ… æ— æ„ŸçŸ¥           |

---

**å…¼å®¹æ€§ä¸é™çº§**ï¼š

```typescript
/**
 * ç‰¹æ€§æ£€æµ‹ä¸é™çº§ç­–ç•¥
 */
class SchedulerCompat {
  /**
   * æ£€æµ‹ API æ”¯æŒæƒ…å†µ
   */
  static detectSupport() {
    return {
      requestIdleCallback: 'requestIdleCallback' in window,
      schedulerAPI: 'scheduler' in window && 'postTask' in (window as any).scheduler,
      isInputPending: 'scheduling' in navigator && 'isInputPending' in (navigator as any).scheduling
    };
  }

  /**
   * è‡ªåŠ¨é€‰æ‹©æœ€ä½³ API
   */
  static scheduleIdleWork(task: () => void): void {
    const support = this.detectSupport();

    if (support.schedulerAPI) {
      // æœ€ä½³ï¼šä½¿ç”¨ Scheduler API
      (window as any).scheduler.postTask(task, { priority: 'background' });
    } else if (support.requestIdleCallback) {
      // æ¬¡ä¼˜ï¼šä½¿ç”¨ requestIdleCallback
      requestIdleCallback(task, { timeout: 1000 });
    } else {
      // é™çº§ï¼šä½¿ç”¨ setTimeout
      setTimeout(task, 0);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
SchedulerCompat.scheduleIdleWork(() => {
  console.log('åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œ');
});
```

---

### æ–¹æ¡ˆ 5: æ’¤é”€/é‡åšæ“ä½œæ‰¹å¤„ç†ï¼ˆé’ˆå¯¹é¢‘ç¹ç‚¹å‡»ï¼‰

#### æ ¸å¿ƒé—®é¢˜

ç”¨æˆ·å¿«é€Ÿè¿ç»­ç‚¹å‡»æ’¤é”€/é‡åšæŒ‰é’®æ—¶ï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼š

```typescript
// âŒ é—®é¢˜åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿç‚¹å‡»æ’¤é”€æŒ‰é’® 30 æ¬¡
// æ—¶é—´çº¿ï¼š
// 0ms:    ç‚¹å‡» â†’ undo(1) â†’ åº”ç”¨ Patch â†’ è§¦å‘æ¸²æŸ“
// 100ms:  ç‚¹å‡» â†’ undo(1) â†’ åº”ç”¨ Patch â†’ è§¦å‘æ¸²æŸ“
// 200ms:  ç‚¹å‡» â†’ undo(1) â†’ åº”ç”¨ Patch â†’ è§¦å‘æ¸²æŸ“
// ... 30 æ¬¡

// æ€§èƒ½é—®é¢˜ï¼š
// 1. 30 æ¬¡ç‹¬ç«‹çš„æ’¤é”€æ“ä½œï¼ˆæ¯æ¬¡ ~10msï¼‰
// 2. 30 æ¬¡æ¸²æŸ“ï¼ˆæ¯æ¬¡ ~16msï¼‰
// 3. 30 æ¬¡çŠ¶æ€å˜æ›´äº‹ä»¶
// 4. æ— æ³•åˆ©ç”¨å¿«ç…§ä¼˜åŒ–ï¼ˆå› ä¸ºæ¯æ¬¡åªæ’¤é”€ 1 æ­¥ï¼‰
// 5. UI å‡ºç°"é—ªçƒ"ï¼ˆçŠ¶æ€å¿«é€Ÿå˜åŒ–ï¼‰
// æ€»è€—æ—¶ï¼š30 Ã— (10 + 16) = 780ms
```

**å…³é”®æ´å¯Ÿ**ï¼š

- ç°æœ‰çš„ `undo(steps)` æ–¹æ³•æ”¯æŒä¸€æ¬¡æ€§æ’¤é”€å¤šæ­¥ï¼Œå¹¶åœ¨ `steps > 10` æ—¶ä½¿ç”¨å¿«ç…§ä¼˜åŒ–
- ä½†ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œæ¯æ¬¡è°ƒç”¨çš„æ˜¯ `undo(1)`ï¼Œæ— æ³•è§¦å‘æ‰¹é‡ä¼˜åŒ–
- éœ€è¦åœ¨ UI å±‚æ”¶é›†è¿ç»­ç‚¹å‡»ï¼Œè½¬æ¢ä¸ºæ‰¹é‡æ“ä½œ

---

#### è§£å†³æ–¹æ¡ˆï¼šæ‰¹å¤„ç† + é˜²æŠ–

**æ ¸å¿ƒæ€è·¯**ï¼š

1. åœ¨çŸ­æ—¶é—´çª—å£ï¼ˆ150msï¼‰å†…æ”¶é›†æ‰€æœ‰æ’¤é”€/é‡åšè¯·æ±‚
2. çª—å£ç»“æŸæ—¶ï¼Œæ‰¹é‡æ‰§è¡Œç´¯ç§¯çš„æ“ä½œ
3. åªè§¦å‘ä¸€æ¬¡æ¸²æŸ“
4. å¯ä»¥åˆ©ç”¨å¿«ç…§ä¼˜åŒ–ï¼ˆå½“ç´¯ç§¯æ­¥æ•° > 10ï¼‰

```typescript
/**
 * æ’¤é”€/é‡åšæ‰¹å¤„ç†ç®¡ç†å™¨
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. æ”¶é›†çŸ­æ—¶é—´å†…çš„è¿ç»­æ’¤é”€/é‡åšè¯·æ±‚
 * 2. æ‰¹é‡æ‰§è¡Œï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°
 * 3. æ”¯æŒå¿«ç…§ä¼˜åŒ–
 */
class UndoRedoBatchManager {
  /** å¾…æ‰§è¡Œçš„æ’¤é”€æ­¥æ•° */
  private pendingUndoCount = 0;

  /** å¾…æ‰§è¡Œçš„é‡åšæ­¥æ•° */
  private pendingRedoCount = 0;

  /** æ‰¹å¤„ç†å®šæ—¶å™¨ */
  private flushTimer: number | null = null;

  /** æ‰¹å¤„ç†æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰ */
  private readonly batchWindow = 150;

  /** æœ€å°æ‰¹å¤„ç†é˜ˆå€¼ï¼ˆå°äºæ­¤å€¼ä¸æ‰¹å¤„ç†ï¼‰ */
  private readonly minBatchSize = 3;

  /**
   * è°ƒåº¦æ’¤é”€æ“ä½œï¼ˆæ”¶é›†è¯·æ±‚ï¼‰
   */
  scheduleUndo(historyManager: HistoryManager): void {
    // å¦‚æœæœ‰å¾…æ‰§è¡Œçš„é‡åšï¼Œå…ˆæ¸…ç©ºï¼ˆæ’¤é”€å’Œé‡åšä¸èƒ½æ··åˆï¼‰
    if (this.pendingRedoCount > 0) {
      this.flushRedo(historyManager);
    }

    this.pendingUndoCount++;
    this.scheduleBatchFlush(historyManager);

    console.log(`[UndoRedoBatch] Scheduled undo, pending: ${this.pendingUndoCount}`);
  }

  /**
   * è°ƒåº¦é‡åšæ“ä½œï¼ˆæ”¶é›†è¯·æ±‚ï¼‰
   */
  scheduleRedo(historyManager: HistoryManager): void {
    // å¦‚æœæœ‰å¾…æ‰§è¡Œçš„æ’¤é”€ï¼Œå…ˆæ¸…ç©º
    if (this.pendingUndoCount > 0) {
      this.flushUndo(historyManager);
    }

    this.pendingRedoCount++;
    this.scheduleBatchFlush(historyManager);

    console.log(`[UndoRedoBatch] Scheduled redo, pending: ${this.pendingRedoCount}`);
  }

  /**
   * è°ƒåº¦æ‰¹æ¬¡åˆ·æ–°ï¼ˆé˜²æŠ–ï¼‰
   */
  private scheduleBatchFlush(historyManager: HistoryManager): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆé˜²æŠ–æ•ˆæœï¼‰
    if (this.flushTimer !== null) {
      clearTimeout(this.flushTimer);
    }

    // è®¾ç½®æ–°çš„å®šæ—¶å™¨
    this.flushTimer = window.setTimeout(() => {
      this.flushBatch(historyManager);
    }, this.batchWindow);
  }

  /**
   * åˆ·æ–°æ‰¹æ¬¡ï¼ˆæ‰§è¡Œç´¯ç§¯çš„æ“ä½œï¼‰
   */
  private flushBatch(historyManager: HistoryManager): void {
    this.flushUndo(historyManager);
    this.flushRedo(historyManager);
    this.flushTimer = null;
  }

  /**
   * æ‰§è¡Œç´¯ç§¯çš„æ’¤é”€æ“ä½œ
   */
  private flushUndo(historyManager: HistoryManager): void {
    if (this.pendingUndoCount === 0) return;

    const count = this.pendingUndoCount;
    console.log(`[UndoRedoBatch] Flushing ${count} undo operations`);

    // ä¸€æ¬¡æ€§æ‰§è¡Œå¤šæ­¥æ’¤é”€
    // âœ… å½“ count > 10 æ—¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨å¿«ç…§ä¼˜åŒ–
    historyManager.undo(count);

    this.pendingUndoCount = 0;
  }

  /**
   * æ‰§è¡Œç´¯ç§¯çš„é‡åšæ“ä½œ
   */
  private flushRedo(historyManager: HistoryManager): void {
    if (this.pendingRedoCount === 0) return;

    const count = this.pendingRedoCount;
    console.log(`[UndoRedoBatch] Flushing ${count} redo operations`);

    historyManager.redo(count);

    this.pendingRedoCount = 0;
  }

  /**
   * ç«‹å³åˆ·æ–°ï¼ˆç”¨æˆ·åœæ­¢ç‚¹å‡»æˆ–åˆ‡æ¢æ“ä½œæ—¶ï¼‰
   */
  flush(historyManager: HistoryManager): void {
    if (this.flushTimer !== null) {
      clearTimeout(this.flushTimer);
      this.flushTimer = null;
    }
    this.flushBatch(historyManager);
  }

  /**
   * è·å–å¾…å¤„ç†çš„æ“ä½œæ•°
   */
  getPendingCount(): { undo: number; redo: number } {
    return {
      undo: this.pendingUndoCount,
      redo: this.pendingRedoCount
    };
  }
}
```

---

#### é›†æˆåˆ° HistoryManager

```typescript
class HistoryManager extends EventEmitter {
  /** æ’¤é”€æ ˆ */
  private undoStack: ICommand[] = [];

  /** é‡åšæ ˆ */
  private redoStack: ICommand[] = [];

  /** æ‰¹å¤„ç†ç®¡ç†å™¨ */
  private batchManager = new UndoRedoBatchManager();

  /**
   * æ’¤é”€ï¼ˆæ”¯æŒæ‰¹å¤„ç†ï¼ŒUI å±‚è°ƒç”¨ï¼‰
   */
  undoWithBatch(): void {
    this.batchManager.scheduleUndo(this);
  }

  /**
   * é‡åšï¼ˆæ”¯æŒæ‰¹å¤„ç†ï¼ŒUI å±‚è°ƒç”¨ï¼‰
   */
  redoWithBatch(): void {
    this.batchManager.scheduleRedo(this);
  }

  /**
   * ç«‹å³åˆ·æ–°æ‰¹å¤„ç†ï¼ˆç”¨æˆ·åˆ‡æ¢æ“ä½œæ—¶è°ƒç”¨ï¼‰
   */
  flushBatch(): void {
    this.batchManager.flush(this);
  }

  /**
   * æ’¤é”€æ“ä½œï¼ˆå†…éƒ¨æ–¹æ³•ï¼Œæ”¯æŒæ‰¹é‡ï¼‰
   */
  undo(steps: number = 1): void {
    if (!this.canUndo()) return;

    const actualSteps = Math.min(steps, this.undoStack.length);

    console.log(`[History] Undo ${actualSteps} steps`);

    // âœ… å¤§é‡æ’¤é”€æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨å¿«ç…§æ¢å¤
    if (actualSteps > 10) {
      this.undoWithSnapshot(actualSteps);
    } else {
      // æ­£å¸¸é€ä¸ªæ’¤é”€
      for (let i = 0; i < actualSteps; i++) {
        this.undoOne();
      }
    }

    // âš ï¸ å…³é”®ï¼šåªè§¦å‘ä¸€æ¬¡çŠ¶æ€å˜æ›´ï¼ˆæ— è®ºæ’¤é”€å¤šå°‘æ­¥ï¼‰
    this.emitStateChange();
  }

  /**
   * é‡åšæ“ä½œï¼ˆå†…éƒ¨æ–¹æ³•ï¼Œæ”¯æŒæ‰¹é‡ï¼‰
   */
  redo(steps: number = 1): void {
    if (!this.canRedo()) return;

    const actualSteps = Math.min(steps, this.redoStack.length);

    console.log(`[History] Redo ${actualSteps} steps`);

    for (let i = 0; i < actualSteps; i++) {
      const command = this.redoStack.pop();
      if (!command) break;

      command.redo();
      this.undoStack.push(command);
      this.logCommand('REDO', command);
    }

    // åªè§¦å‘ä¸€æ¬¡çŠ¶æ€å˜æ›´
    this.emitStateChange();
  }

  // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
}
```

---

#### UI å±‚é›†æˆ

**1. æŒ‰é’®ç‚¹å‡»äº‹ä»¶**

```typescript
// æ’¤é”€æŒ‰é’®
const undoButton = document.getElementById('undo-btn');
undoButton.addEventListener('click', () => {
  // âœ… ä½¿ç”¨æ‰¹å¤„ç†ç‰ˆæœ¬
  editor.historyManager.undoWithBatch();

  // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆç«‹å³åé¦ˆï¼‰
  updateUndoRedoButtons();
});

// é‡åšæŒ‰é’®
const redoButton = document.getElementById('redo-btn');
redoButton.addEventListener('click', () => {
  editor.historyManager.redoWithBatch();
  updateUndoRedoButtons();
});

/**
 * æ›´æ–°æ’¤é”€/é‡åšæŒ‰é’®çŠ¶æ€
 */
function updateUndoRedoButtons(): void {
  const state = editor.historyManager.getState();
  const pending = editor.historyManager.batchManager.getPendingCount();

  // æŒ‰é’®å¯ç”¨æ€§
  undoButton.disabled = !state.canUndo && pending.undo === 0;
  redoButton.disabled = !state.canRedo && pending.redo === 0;

  // æ˜¾ç¤ºå¾…å¤„ç†æ•°é‡ï¼ˆå¯é€‰ï¼‰
  if (pending.undo > 0) {
    undoButton.textContent = `æ’¤é”€ (${pending.undo})`;
  } else {
    undoButton.textContent = 'æ’¤é”€';
  }

  if (pending.redo > 0) {
    redoButton.textContent = `é‡åš (${pending.redo})`;
  } else {
    redoButton.textContent = 'é‡åš';
  }
}
```

**2. å¿«æ·é”®æ”¯æŒ**

```typescript
document.addEventListener('keydown', (e) => {
  // Ctrl+Z / Cmd+Z: æ’¤é”€
  if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
    e.preventDefault();
    editor.historyManager.undoWithBatch();
    updateUndoRedoButtons();
  }

  // Ctrl+Shift+Z / Cmd+Shift+Z: é‡åš
  // æˆ– Ctrl+Y / Cmd+Y: é‡åš
  if (((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) || ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
    e.preventDefault();
    editor.historyManager.redoWithBatch();
    updateUndoRedoButtons();
  }
});
```

**3. ç”¨æˆ·åˆ‡æ¢æ“ä½œæ—¶ç«‹å³åˆ·æ–°**

```typescript
// ç”¨æˆ·å¼€å§‹ç¼–è¾‘æ—¶ï¼Œç«‹å³åˆ·æ–°å¾…å¤„ç†çš„æ’¤é”€/é‡åš
editor.on('before-edit', () => {
  editor.historyManager.flushBatch();
});

// ç¤ºä¾‹ï¼šç”¨æˆ·ç‚¹å‡»ç”»å¸ƒå¼€å§‹ç¼–è¾‘
canvas.addEventListener('mousedown', () => {
  editor.historyManager.flushBatch();
});

// ç¤ºä¾‹ï¼šç”¨æˆ·æ‰“å¼€å±æ€§é¢æ¿
propertyPanel.addEventListener(
  'focus',
  () => {
    editor.historyManager.flushBatch();
  },
  true
);
```

---

#### å¢å¼ºï¼šæ¸²æŸ“èŠ‚æµ

ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼Œå¯ä»¥å¯¹æ¸²æŸ“è¿›è¡ŒèŠ‚æµï¼š

```typescript
/**
 * æ’¤é”€/é‡åšæ¸²æŸ“èŠ‚æµå™¨
 *
 * ç¡®ä¿å³ä½¿æ‰¹å¤„ç†å¤±è´¥ï¼Œæ¸²æŸ“é¢‘ç‡ä¹Ÿä¸ä¼šè¿‡é«˜
 */
class UndoRedoRenderThrottler {
  private lastRenderTime = 0;
  private readonly minRenderInterval = 50; // æœ€å°æ¸²æŸ“é—´éš” 50ms
  private pendingRender: (() => void) | null = null;
  private renderTimer: number | null = null;

  /**
   * èŠ‚æµæ¸²æŸ“
   */
  scheduleRender(callback: () => void): void {
    const now = Date.now();
    const timeSinceLastRender = now - this.lastRenderTime;

    if (timeSinceLastRender >= this.minRenderInterval) {
      // è·ç¦»ä¸Šæ¬¡æ¸²æŸ“å·²è¶…è¿‡é—´éš”ï¼Œç«‹å³æ¸²æŸ“
      this.executeRender(callback);
    } else {
      // ä¿å­˜å¾…æ¸²æŸ“å›è°ƒ
      this.pendingRender = callback;

      // å¦‚æœå·²æœ‰å®šæ—¶å™¨ï¼Œä¸é‡å¤è®¾ç½®
      if (this.renderTimer !== null) return;

      // è°ƒåº¦ä¸‹æ¬¡æ¸²æŸ“
      const delay = this.minRenderInterval - timeSinceLastRender;
      this.renderTimer = window.setTimeout(() => {
        if (this.pendingRender) {
          this.executeRender(this.pendingRender);
        }
      }, delay);
    }
  }

  /**
   * æ‰§è¡Œæ¸²æŸ“
   */
  private executeRender(callback: () => void): void {
    callback();
    this.lastRenderTime = Date.now();
    this.pendingRender = null;
    this.renderTimer = null;
  }

  /**
   * ç«‹å³åˆ·æ–°å¾…å¤„ç†çš„æ¸²æŸ“
   */
  flush(): void {
    if (this.renderTimer !== null) {
      clearTimeout(this.renderTimer);
      this.renderTimer = null;
    }

    if (this.pendingRender) {
      this.executeRender(this.pendingRender);
    }
  }
}
```

**é›†æˆåˆ° SchemaManager**ï¼š

```typescript
class SchemaManager {
  private renderThrottler = new UndoRedoRenderThrottler();

  /**
   * é€šçŸ¥ç›‘å¬å™¨ï¼ˆå¸¦èŠ‚æµï¼‰
   */
  private notifyListeners(): void {
    this.renderThrottler.scheduleRender(() => {
      this.listeners.forEach((listener) => listener(this.state));
    });
  }
}
```

---

#### æ€§èƒ½å¯¹æ¯”

**åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿç‚¹å‡»æ’¤é”€æŒ‰é’® 30 æ¬¡**

| æŒ‡æ ‡               | æ— ä¼˜åŒ–      | æ‰¹å¤„ç†      | æ‰¹å¤„ç†+èŠ‚æµ |
| ------------------ | ----------- | ----------- | ----------- |
| **æ’¤é”€æ‰§è¡Œæ¬¡æ•°**   | 30 æ¬¡       | 1 æ¬¡        | 1 æ¬¡        |
| **Patch åº”ç”¨æ¬¡æ•°** | 30 æ¬¡       | 1-10 æ¬¡\*   | 1-10 æ¬¡\*   |
| **æ¸²æŸ“æ¬¡æ•°**       | 30 æ¬¡       | 1 æ¬¡        | 1 æ¬¡        |
| **çŠ¶æ€å˜æ›´äº‹ä»¶**   | 30 æ¬¡       | 1 æ¬¡        | 1 æ¬¡        |
| **å¿«ç…§ä¼˜åŒ–**       | âŒ æ— æ³•åˆ©ç”¨ | âœ… è‡ªåŠ¨è§¦å‘ | âœ… è‡ªåŠ¨è§¦å‘ |
| **æ€»è€—æ—¶**         | ~780ms      | ~50ms       | ~50ms       |
| **UI é—ªçƒ**        | âœ… ä¸¥é‡     | âŒ æ—        | âŒ æ—        |
| **ç”¨æˆ·ä½“éªŒ**       | â­â­        | â­â­â­â­â­  | â­â­â­â­â­  |

\* å½“æ’¤é”€æ­¥æ•° > 10 æ—¶ï¼Œä½¿ç”¨å¿«ç…§æ¢å¤ + éƒ¨åˆ†é‡æ”¾ï¼ŒPatch åº”ç”¨æ¬¡æ•°å¤§å¹…å‡å°‘

---

#### å®é™…æµ‹è¯•æ•°æ®

```typescript
// æµ‹è¯•åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿç‚¹å‡»æ’¤é”€æŒ‰é’® 50 æ¬¡

// æ— ä¼˜åŒ–ï¼š
// [0ms]    Undo 1 step (10ms)
// [10ms]   Render (16ms)
// [26ms]   Undo 1 step (10ms)
// [36ms]   Render (16ms)
// ... 50 æ¬¡
// [1300ms] å®Œæˆ
// æ€»è€—æ—¶: 1300ms
// ç”¨æˆ·æ„ŸçŸ¥: å¡é¡¿ä¸¥é‡ï¼ŒUI é—ªçƒ

// æ‰¹å¤„ç†ä¼˜åŒ–ï¼š
// [0ms]    Schedule undo (< 1ms)
// [100ms]  Schedule undo (< 1ms)
// [200ms]  Schedule undo (< 1ms)
// ... 50 æ¬¡ç‚¹å‡»
// [5000ms] ç”¨æˆ·åœæ­¢ç‚¹å‡»
// [5150ms] Flush batch: undo 50 steps
//          - æ‰¾åˆ°å¿«ç…§ï¼ˆç¬¬ 40 æ­¥ï¼‰
//          - æ¢å¤å¿«ç…§ (5ms)
//          - é‡æ”¾ 40-0 çš„å‘½ä»¤ (20ms)
//          - è§¦å‘ 1 æ¬¡æ¸²æŸ“ (16ms)
// [5191ms] å®Œæˆ
// æ€»è€—æ—¶: 41msï¼ˆä»åˆ·æ–°å¼€å§‹è®¡ç®—ï¼‰
// ç”¨æˆ·æ„ŸçŸ¥: æµç•…ï¼Œæ— é—ªçƒ
```

---

#### è¾¹ç•Œæƒ…å†µå¤„ç†

**1. ç”¨æˆ·åœ¨æ‰¹å¤„ç†çª—å£å†…åˆ‡æ¢æ“ä½œ**

```typescript
// åœºæ™¯ï¼šç”¨æˆ·ç‚¹å‡» 5 æ¬¡æ’¤é”€ï¼Œç„¶åç«‹å³å¼€å§‹ç¼–è¾‘
// 0ms:   ç‚¹å‡»æ’¤é”€ Ã— 5
// 100ms: ç‚¹å‡»ç”»å¸ƒå¼€å§‹ç¼–è¾‘

// å¤„ç†ï¼š
canvas.addEventListener('mousedown', () => {
  // ç«‹å³åˆ·æ–°å¾…å¤„ç†çš„æ’¤é”€
  editor.historyManager.flushBatch();
  // æ­¤æ—¶ 5 æ¬¡æ’¤é”€ä¼šç«‹å³æ‰§è¡Œ
});
```

**2. æ’¤é”€å’Œé‡åšæ··åˆç‚¹å‡»**

```typescript
// åœºæ™¯ï¼šç”¨æˆ·ç‚¹å‡» 3 æ¬¡æ’¤é”€ï¼Œç„¶åç‚¹å‡» 2 æ¬¡é‡åš
// 0ms:   ç‚¹å‡»æ’¤é”€ Ã— 3
// 200ms: ç‚¹å‡»é‡åš Ã— 2

// å¤„ç†ï¼š
scheduleRedo(historyManager: HistoryManager): void {
  // å¦‚æœæœ‰å¾…æ‰§è¡Œçš„æ’¤é”€ï¼Œå…ˆæ¸…ç©º
  if (this.pendingUndoCount > 0) {
    this.flushUndo(historyManager);  // ç«‹å³æ‰§è¡Œ 3 æ¬¡æ’¤é”€
  }

  this.pendingRedoCount++;
  this.scheduleBatchFlush(historyManager);
}
```

**3. æ‰¹å¤„ç†çª—å£è¿‡é•¿å¯¼è‡´å»¶è¿Ÿæ„Ÿ**

```typescript
// ä¼˜åŒ–ï¼šåŠ¨æ€è°ƒæ•´æ‰¹å¤„ç†çª—å£
class UndoRedoBatchManager {
  private batchWindow = 150; // åˆå§‹å€¼

  private adjustBatchWindow(clickInterval: number): void {
    // å¦‚æœç”¨æˆ·ç‚¹å‡»å¾ˆå¿«ï¼ˆ< 50msï¼‰ï¼Œç¼©çŸ­çª—å£
    if (clickInterval < 50) {
      this.batchWindow = 100;
    }
    // å¦‚æœç”¨æˆ·ç‚¹å‡»è¾ƒæ…¢ï¼ˆ> 200msï¼‰ï¼Œå»¶é•¿çª—å£
    else if (clickInterval > 200) {
      this.batchWindow = 200;
    }
  }
}
```

---

#### å¯é€‰å¢å¼ºï¼šè¿›åº¦åé¦ˆ

å¯¹äºå¤§é‡æ’¤é”€/é‡åšæ“ä½œï¼Œå¯ä»¥æ˜¾ç¤ºè¿›åº¦æç¤ºï¼š

```typescript
class HistoryManager {
  undo(steps: number = 1): void {
    if (!this.canUndo()) return;

    const actualSteps = Math.min(steps, this.undoStack.length);

    // å¦‚æœæ­¥æ•°è¾ƒå¤šï¼Œæ˜¾ç¤ºè¿›åº¦æç¤º
    if (actualSteps > 20) {
      this.showProgressToast(`æ­£åœ¨æ’¤é”€ ${actualSteps} æ­¥æ“ä½œ...`);
    }

    // æ‰§è¡Œæ’¤é”€
    if (actualSteps > 10) {
      this.undoWithSnapshot(actualSteps);
    } else {
      for (let i = 0; i < actualSteps; i++) {
        this.undoOne();
      }
    }

    this.emitStateChange();

    // éšè—è¿›åº¦æç¤º
    if (actualSteps > 20) {
      this.hideProgressToast();
    }
  }

  private showProgressToast(message: string): void {
    // æ˜¾ç¤ºéé˜»å¡å¼æç¤º
    window.dispatchEvent(
      new CustomEvent('show-toast', {
        detail: { message, type: 'info' }
      })
    );
  }

  private hideProgressToast(): void {
    window.dispatchEvent(new CustomEvent('hide-toast'));
  }
}
```

---

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ                        | é€‚ç”¨åœºæ™¯              | ä¼˜ç‚¹                                                                               | ç¼ºç‚¹                                                  | æ¨èåº¦     |
| --------------------------- | --------------------- | ---------------------------------------------------------------------------------- | ----------------------------------------------------- | ---------- |
| **æ–¹æ¡ˆ 1: RAF Batching**    | é€šç”¨åœºæ™¯              | âœ… è‡ªåŠ¨å¯¹é½æµè§ˆå™¨å¸§ç‡<br>âœ… å®ç°ç®€å•<br>âœ… ç±»ä¼¼ React 18                           | âš ï¸ éœ€è¦æ‰‹åŠ¨åŒ…è£…<br>âš ï¸ ä»å¯èƒ½é˜»å¡ UI                   | â­â­â­â­â­ |
| **æ–¹æ¡ˆ 2: Transaction**     | å¤æ‚æ‰¹é‡æ“ä½œ          | âœ… è¯­ä¹‰æ¸…æ™°<br>âœ… æ”¯æŒå›æ»š<br>âœ… åŸå­æ€§ä¿è¯                                        | âš ï¸ éœ€è¦æ˜¾å¼ç®¡ç†<br>âš ï¸ ä»£ç ä¾µå…¥æ€§å¼º                    | â­â­â­â­   |
| **æ–¹æ¡ˆ 3: æ™ºèƒ½é˜²æŠ–**        | è¿ç»­æ“ä½œï¼ˆæ»‘å—/æ‹–æ‹½ï¼‰ | âœ… é›¶é…ç½®<br>âœ… è‡ªåŠ¨æ£€æµ‹                                                           | âš ï¸ å¯èƒ½æœ‰å»¶è¿Ÿæ„Ÿ<br>âš ï¸ éœ€è¦é¢å¤– flush                  | â­â­â­â­   |
| **æ–¹æ¡ˆ 4: ç©ºé—²è°ƒåº¦**        | å¤§æ‰¹é‡ä»»åŠ¡+ç”¨æˆ·äº¤äº’   | âœ… æ°¸ä¸é˜»å¡ UI<br>âœ… å¯ä¸­æ–­/æ¢å¤<br>âœ… ä¼˜å…ˆä¿è¯äº¤äº’æµç•…                            | âš ï¸ å®ç°å¤æ‚<br>âš ï¸ å…¼å®¹æ€§éœ€å¤„ç†<br>âš ï¸ ä»»åŠ¡å¯èƒ½å»¶è¿Ÿæ‰§è¡Œ | â­â­â­â­â­ |
| **æ–¹æ¡ˆ 5: æ’¤é”€/é‡åšæ‰¹å¤„ç†** | é¢‘ç¹ç‚¹å‡»æ’¤é”€/é‡åšæŒ‰é’® | âœ… å¤§å¹…æå‡æ€§èƒ½ï¼ˆå¿« 15 å€ï¼‰<br>âœ… æ—  UI é—ªçƒ<br>âœ… è‡ªåŠ¨åˆ©ç”¨å¿«ç…§ä¼˜åŒ–<br>âœ… å®ç°ç®€å• | âš ï¸ æœ‰è½»å¾®å»¶è¿Ÿï¼ˆ150msï¼‰<br>âš ï¸ éœ€è¦å¤„ç†æ“ä½œåˆ‡æ¢         | â­â­â­â­â­ |
| **ç»„åˆæ–¹æ¡ˆ**                | ç”Ÿäº§ç¯å¢ƒ              | âœ… è¦†ç›–æ‰€æœ‰åœºæ™¯                                                                    | âš ï¸ å¤æ‚åº¦é«˜                                           | â­â­â­â­â­ |

---

### æ¨èç»„åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

```typescript
class ThemeEditor {
  // æ–¹æ¡ˆ 1: åŸºç¡€æ‰¹é‡æ›´æ–°ï¼ˆé»˜è®¤å¼€å¯ï¼‰
  private batchScheduler = new BatchUpdateScheduler();

  // æ–¹æ¡ˆ 2: äº‹åŠ¡æ”¯æŒï¼ˆæŒ‰éœ€ä½¿ç”¨ï¼‰
  private transactionManager = new TransactionManager();

  // æ–¹æ¡ˆ 3: æ™ºèƒ½è°ƒåº¦ï¼ˆè‡ªåŠ¨ä¼˜åŒ–ï¼‰
  private smartScheduler = new SmartRenderScheduler();

  // æ–¹æ¡ˆ 5: æ’¤é”€/é‡åšæ‰¹å¤„ç†ï¼ˆæ–°å¢ï¼‰
  // æ³¨ï¼šå·²é›†æˆåˆ° HistoryManager å†…éƒ¨ï¼Œæ— éœ€å•ç‹¬åˆå§‹åŒ–

  /**
   * è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥
   */
  updateComponentProperty(componentId: string, propertyPath: string, value: any, options?: { immediate?: boolean }): void {
    const command = new UpdatePropertyCommand(this.schemaManager, componentId, propertyPath, value);

    // 1. å¦‚æœåœ¨äº‹åŠ¡ä¸­ â†’ æ·»åŠ åˆ°äº‹åŠ¡
    if (this.transactionManager.isInTransaction()) {
      this.transactionManager.getCurrentTransaction()!.addCommand(command);
      return;
    }

    // 2. å¦‚æœè¯·æ±‚ç«‹å³æ‰§è¡Œ â†’ è·³è¿‡æ‰¹å¤„ç†
    if (options?.immediate) {
      this.historyManager.execute(command);
      this.schemaManager.forceRender();
      return;
    }

    // 3. é»˜è®¤ï¼šä½¿ç”¨æ™ºèƒ½è°ƒåº¦ï¼ˆè‡ªåŠ¨æ‰¹å¤„ç† + é˜²æŠ–ï¼‰
    this.historyManager.execute(command);
    // SchemaManager å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨ smartScheduler
  }
}
```

**å®é™…ä½¿ç”¨**ï¼š

```typescript
// åœºæ™¯ 1: æ‹–åŠ¨æ»‘å—ï¼ˆè‡ªåŠ¨ä¼˜åŒ–ï¼‰
onSliderDrag(value) {
  editor.updateComponentProperty('header', 'color', value);
  // è‡ªåŠ¨é˜²æŠ–ï¼Œåªåœ¨æ¾æ‰‹æ—¶æ¸²æŸ“
}

// åœºæ™¯ 2: æ‰¹é‡ä¿®æ”¹ï¼ˆæ˜¾å¼äº‹åŠ¡ï¼‰
editor.transaction('æ‰¹é‡å¯¹é½', () => {
  components.forEach(comp => {
    editor.updateComponentProperty(comp.id, 'x', alignedX);
  });
});
// æ‰€æœ‰ä¿®æ”¹å®Œæˆåä¸€æ¬¡æ€§æ¸²æŸ“ + ä¸€æ¡å†å²è®°å½•

// åœºæ™¯ 3: ç«‹å³ç”Ÿæ•ˆï¼ˆè·³è¿‡ä¼˜åŒ–ï¼‰
editor.updateComponentProperty('modal', 'visible', true, { immediate: true });
// ç«‹å³æ˜¾ç¤ºå¼¹çª—ï¼Œä¸ç­‰å¾…ä¸‹ä¸€å¸§

// åœºæ™¯ 4: æ’¤é”€/é‡åšï¼ˆæ‰¹å¤„ç†ä¼˜åŒ–ï¼‰
// UI å±‚ï¼šæŒ‰é’®ç‚¹å‡»
undoButton.onclick = () => editor.historyManager.undoWithBatch();
redoButton.onclick = () => editor.historyManager.redoWithBatch();

// å¿«æ·é”®ï¼šCtrl+Z / Ctrl+Y
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
    e.preventDefault();
    editor.historyManager.undoWithBatch();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
    e.preventDefault();
    editor.historyManager.redoWithBatch();
  }
});

// ç”¨æˆ·åˆ‡æ¢æ“ä½œæ—¶ï¼Œç«‹å³åˆ·æ–°æ‰¹å¤„ç†
canvas.addEventListener('mousedown', () => {
  editor.historyManager.flushBatch();
});
```

---

### æ€§èƒ½æå‡é¢„æœŸ

| åœºæ™¯                     | æœªä¼˜åŒ–                            | RAF Batching        | Transaction       | æ™ºèƒ½é˜²æŠ–            | æ’¤é”€/é‡åšæ‰¹å¤„ç†                              |
| ------------------------ | --------------------------------- | ------------------- | ----------------- | ------------------- | -------------------------------------------- |
| **æ‹–åŠ¨æ»‘å— 30 æ¬¡**       | 30 æ¬¡æ¸²æŸ“<br>~480ms               | 1 æ¬¡æ¸²æŸ“<br>~16ms   | 1 æ¬¡æ¸²æŸ“<br>~16ms | 1 æ¬¡æ¸²æŸ“<br>~16ms   | -                                            |
| **æ‰¹é‡å¯¹é½ 10 ä¸ªç»„ä»¶**   | 10 æ¬¡æ¸²æŸ“<br>~160ms               | 1 æ¬¡æ¸²æŸ“<br>~16ms   | 1 æ¬¡æ¸²æŸ“<br>~16ms | 1-2 æ¬¡æ¸²æŸ“<br>~32ms | -                                            |
| **è¿ç»­è¾“å…¥æ–‡æœ¬ 20 å­—ç¬¦** | 20 æ¬¡æ¸²æŸ“<br>~320ms               | 2-3 æ¬¡æ¸²æŸ“<br>~48ms | 1 æ¬¡æ¸²æŸ“<br>~16ms | 1-2 æ¬¡æ¸²æŸ“<br>~32ms | -                                            |
| **å¿«é€Ÿç‚¹å‡»æ’¤é”€ 30 æ¬¡**   | 30 æ¬¡æ‰§è¡Œ<br>30 æ¬¡æ¸²æŸ“<br>~780ms  | -                   | -                 | -                   | 1 æ¬¡æ‰§è¡Œ<br>1 æ¬¡æ¸²æŸ“<br>~50ms                |
| **å¿«é€Ÿç‚¹å‡»æ’¤é”€ 50 æ¬¡**   | 50 æ¬¡æ‰§è¡Œ<br>50 æ¬¡æ¸²æŸ“<br>~1300ms | -                   | -                 | -                   | 1 æ¬¡æ‰§è¡Œ<br>1 æ¬¡æ¸²æŸ“<br>~41ms<br>âœ… åˆ©ç”¨å¿«ç…§ |

**ç»“è®º**ï¼š

- âš¡ **æ¸²æŸ“æ¬¡æ•°å‡å°‘ 85-97%**
- âš¡ **UI å“åº”å»¶è¿Ÿé™ä½ 90%+**
- âš¡ **æ’¤é”€/é‡åšæ€§èƒ½æå‡ 15-30 å€**
- âœ… **ç”¨æˆ·ä½“éªŒæå‡ï¼šæ— å¡é¡¿æ„Ÿï¼Œæ— é—ªçƒ**

---

## ğŸ¯ 9. æ“ä½œåˆå¹¶/æŠ˜å ä¼˜åŒ–ï¼ˆOperation Collapsingï¼‰

### æ ¸å¿ƒé—®é¢˜

åœ¨æ‰¹é‡æ“ä½œæˆ–äº‹åŠ¡ä¸­ï¼Œç”¨æˆ·å¯èƒ½äº§ç”Ÿç›¸äº’æŠµæ¶ˆçš„æ“ä½œï¼š

```typescript
// é—®é¢˜ç¤ºä¾‹ï¼š3 ä¸ªæ“ä½œï¼Œæœ€ç»ˆçŠ¶æ€ä¸å˜
editor.updateComponentProperty('header', 'x', 100); // x: 0 â†’ 100
editor.updateComponentProperty('header', 'x', 50); // x: 100 â†’ 50
editor.updateComponentProperty('header', 'x', 0); // x: 50 â†’ 0
// ç»“æœï¼šx ä» 0 å›åˆ° 0ï¼Œä½†å ç”¨ 3 ä¸ªå†å²è®°å½•
```

**æœŸæœ›è¡Œä¸º**ï¼š

- æ£€æµ‹åˆ°æœ€ç»ˆçŠ¶æ€ == åˆå§‹çŠ¶æ€ â†’ **ä¸äº§ç”Ÿå†å²è®°å½•**
- å‡å°‘ Patch æ•°é‡ â†’ **é™ä½å†…å­˜å ç”¨**
- ç®€åŒ–æ’¤é”€æ ˆ â†’ **æå‡ç”¨æˆ·ä½“éªŒ**

---

### æ–¹æ¡ˆï¼šåŸºäº Immer.js çš„ Patch åˆå¹¶

**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œåˆå¹¶æ‰€æœ‰ Patchesï¼Œç”Ÿæˆæœ€ç»ˆçŠ¶æ€ Diff

```typescript
/**
 * äº‹åŠ¡ç®¡ç†å™¨ - æ”¯æŒ Patch åˆå¹¶
 */
class Transaction {
  private allPatches: Patch[] = [];
  private allInversePatches: Patch[] = [];
  private initialState: Schema;

  constructor(schemaManager: SchemaManager, description: string) {
    this.description = description;
    // ä¿å­˜äº‹åŠ¡å¼€å§‹æ—¶çš„çŠ¶æ€
    this.initialState = schemaManager.cloneState();
  }

  /**
   * æ·»åŠ å‘½ä»¤åˆ°äº‹åŠ¡ï¼ˆæ”¶é›† Patchesï¼‰
   */
  addCommand(command: ICommand): void {
    // æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä¸è§¦å‘æ¸²æŸ“
    command.execute();

    // æ”¶é›† Patchesï¼ˆå¦‚æœå‘½ä»¤æ”¯æŒï¼‰
    if (command instanceof UpdatePropertyCommand) {
      this.allPatches.push(...command.patches);
      this.allInversePatches.push(...command.inversePatches);
    }
  }

  /**
   * æäº¤äº‹åŠ¡ - å…³é”®ï¼šåˆå¹¶ Patches
   */
  commit(schemaManager: SchemaManager, historyManager: HistoryManager): void {
    // 1. è·å–äº‹åŠ¡ç»“æŸæ—¶çš„æœ€ç»ˆçŠ¶æ€
    const finalState = schemaManager.getState();

    // 2. è®¡ç®—åˆå§‹çŠ¶æ€ â†’ æœ€ç»ˆçŠ¶æ€çš„ Diff
    const [, mergedPatches, mergedInversePatches] = produce(
      this.initialState,
      (draft) => {
        // ä½¿ç”¨ Immer é‡æ–°è®¡ç®—ä» initial â†’ final çš„ Patches
        Object.assign(draft, finalState);
      },
      (p, ip) => [null, p, ip]
    );

    // 3. æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å˜æ›´
    if (mergedPatches.length === 0) {
      console.log('[Transaction] No changes detected, skip history');
      return; // æ²¡æœ‰å˜æ›´ï¼Œä¸æ·»åŠ å†å²è®°å½•
    }

    // 4. åˆ›å»ºå•ä¸ªæ‰¹é‡å‘½ä»¤ï¼ˆä½¿ç”¨åˆå¹¶åçš„ Patchesï¼‰
    const batchCommand = new BatchOperationCommandOptimized(this.description, this.initialState, finalState, mergedPatches, mergedInversePatches);

    // 5. æ·»åŠ åˆ°å†å²ç®¡ç†å™¨
    historyManager.undoStack.push(batchCommand);
    historyManager.redoStack = [];
    historyManager.emitStateChange();
  }
}
```

---

### ä¼˜åŒ–çš„æ‰¹é‡å‘½ä»¤å®ç°

```typescript
/**
 * ä¼˜åŒ–çš„æ‰¹é‡å‘½ä»¤ - ç›´æ¥å­˜å‚¨åˆå¹¶åçš„ Patches
 */
class BatchOperationCommandOptimized implements ICommand {
  readonly id: string;
  readonly type = 'BATCH_OPTIMIZED';
  readonly description: string;
  readonly timestamp: number;

  private initialState: Schema;
  private finalState: Schema;
  private patches: Patch[];
  private inversePatches: Patch[];

  constructor(description: string, initialState: Schema, finalState: Schema, patches: Patch[], inversePatches: Patch[]) {
    this.id = `${Date.now()}-${Math.random()}`;
    this.timestamp = Date.now();
    this.description = description;
    this.initialState = initialState;
    this.finalState = finalState;
    this.patches = patches;
    this.inversePatches = inversePatches;
  }

  execute(): void {
    // åº”ç”¨åˆå¹¶åçš„ Patches
    schemaManager.applyPatches(this.patches);
  }

  undo(): void {
    // åº”ç”¨é€†å‘ Patches
    schemaManager.applyPatches(this.inversePatches);
  }

  redo(): void {
    this.execute();
  }

  serialize(): Record<string, any> {
    return {
      type: this.type,
      description: this.description,
      patches: this.patches,
      inversePatches: this.inversePatches,
      timestamp: this.timestamp
    };
  }
}
```

---

### é›†æˆåˆ° ThemeEditor

```typescript
class ThemeEditor {
  /**
   * äº‹åŠ¡æ‰§è¡Œï¼ˆè‡ªåŠ¨åˆå¹¶ Patchesï¼‰
   */
  transaction(description: string, fn: () => void): void {
    const transaction = new Transaction(this.schemaManager, description);

    this.schemaManager.startBatch(); // å¼€å¯æ‰¹é‡æ›´æ–°ï¼ˆå»¶è¿Ÿæ¸²æŸ“ï¼‰

    try {
      // ç”¨æˆ·æ“ä½œåœ¨è¿™é‡Œæ‰§è¡Œ
      fn();

      // æäº¤äº‹åŠ¡ï¼ˆå†…éƒ¨ä¼šåˆå¹¶ Patchesï¼‰
      transaction.commit(this.schemaManager, this.historyManager);
    } catch (error) {
      // å›æ»šäº‹åŠ¡
      this.schemaManager.setState(transaction.initialState);
      throw error;
    } finally {
      this.schemaManager.endBatch(); // ç»“æŸæ‰¹é‡æ›´æ–°ï¼Œè§¦å‘ä¸€æ¬¡æ¸²æŸ“
    }
  }
}
```

---

### ä½¿ç”¨ç¤ºä¾‹ä¸æ•ˆæœ

#### ç¤ºä¾‹ 1: å®Œå…¨æŠµæ¶ˆçš„æ“ä½œ

```typescript
// ç”¨æˆ·åœ¨é¢œè‰²é€‰æ‹©å™¨ä¸­åå¤è°ƒæ•´ï¼Œæœ€ç»ˆå›åˆ°åŸç‚¹
editor.transaction('è°ƒæ•´é¢œè‰²', () => {
  editor.updateComponentProperty('header', 'style.color', '#ff0000');
  editor.updateComponentProperty('header', 'style.color', '#00ff00');
  editor.updateComponentProperty('header', 'style.color', '#0000ff');
  editor.updateComponentProperty('header', 'style.color', '#ff0000'); // å›åˆ°åˆå§‹å€¼
});

// ç»“æœï¼š
// - æ£€æµ‹åˆ°æœ€ç»ˆçŠ¶æ€ == åˆå§‹çŠ¶æ€
// - mergedPatches.length === 0
// - ä¸äº§ç”Ÿå†å²è®°å½•ï¼ˆç”¨æˆ·æ— éœ€æ’¤é”€ï¼‰
```

#### ç¤ºä¾‹ 2: éƒ¨åˆ†æŠµæ¶ˆçš„æ“ä½œ

```typescript
editor.transaction('æ‰¹é‡è°ƒæ•´', () => {
  editor.updateComponentProperty('header', 'x', 100);
  editor.updateComponentProperty('header', 'y', 200);
  editor.updateComponentProperty('header', 'x', 0); // x å›åˆ°åŸå€¼
  editor.updateComponentProperty('header', 'y', 250); // y æŒç»­å˜åŒ–
});

// ç»“æœï¼š
// - åˆå¹¶ååªæœ‰ y çš„ Patch
// - patches = [{ op: 'replace', path: '/header/y', value: 250 }]
// - å†å²è®°å½•åªä¿å­˜ 1 ä¸ªæœ‰æ•ˆå˜æ›´ï¼ˆy: 200 â†’ 250ï¼‰
```

#### ç¤ºä¾‹ 3: æ‰¹é‡å¯¹é½ï¼ˆæ— æŠµæ¶ˆï¼‰

```typescript
editor.transaction('æ‰¹é‡å¯¹é½åˆ° x=100', () => {
  components.forEach((comp) => {
    editor.updateComponentProperty(comp.id, 'x', 100);
  });
});

// ç»“æœï¼š
// - 10 ä¸ªç»„ä»¶çš„ x åæ ‡éƒ½æ”¹å˜
// - åˆå¹¶åæœ‰ 10 ä¸ª Patch
// - patches = [
//     { op: 'replace', path: '/comp1/x', value: 100 },
//     { op: 'replace', path: '/comp2/x', value: 100 },
//     ...
//   ]
// - äº§ç”Ÿ 1 æ¡å†å²è®°å½•ï¼ˆåŒ…å« 10 ä¸ªåˆå¹¶åçš„ Patchï¼‰
```

---

### å†…å­˜å’Œæ€§èƒ½ä¼˜åŠ¿

#### å¯¹æ¯”ï¼šæ— ä¼˜åŒ– vs. Patch åˆå¹¶

| åœºæ™¯                   | æ— ä¼˜åŒ–                  | Patch åˆå¹¶                    | æ”¹å–„         |
| ---------------------- | ----------------------- | ----------------------------- | ------------ |
| **é¢œè‰²åå¤è°ƒæ•´ 10 æ¬¡** | 10 ä¸ª Command<br>~2KB   | 0 ä¸ª Command<br>0 bytes       | âœ… 100% èŠ‚çœ |
| **æ‰¹é‡å¯¹é½ 100 ç»„ä»¶**  | 100 ä¸ª Command<br>~20KB | 1 ä¸ª Command<br>~2KB          | âœ… 90% èŠ‚çœ  |
| **å¤æ‚ç¼–è¾‘ 30 æ­¥æ“ä½œ** | 30 ä¸ª Command<br>~6KB   | 5-10 ä¸ªæœ‰æ•ˆ Command<br>~1.5KB | âœ… 75% èŠ‚çœ  |

#### æ€§èƒ½æ•°æ®ï¼ˆå®æµ‹é¢„æœŸï¼‰

```typescript
// åœºæ™¯ï¼šæ‹–åŠ¨æ»‘å— 100 æ¬¡ï¼Œæœ€ç»ˆå›åˆ°åˆå§‹å€¼
// æ— ä¼˜åŒ–ï¼š
// - å†å²è®°å½•ï¼š100 ä¸ª UpdatePropertyCommand
// - å†…å­˜å ç”¨ï¼š~20KB
// - æ’¤é”€æ“ä½œï¼š100 æ¬¡æ’¤é”€æ‰èƒ½å›åˆ°åˆå§‹çŠ¶æ€

// Patch åˆå¹¶ï¼š
// - å†å²è®°å½•ï¼š0 ä¸ªï¼ˆæ£€æµ‹åˆ°æ— å˜æ›´ï¼‰
// - å†…å­˜å ç”¨ï¼š0 bytes
// - æ’¤é”€æ“ä½œï¼šæ— éœ€æ’¤é”€ï¼ˆå› ä¸ºæ²¡æœ‰å†å²è®°å½•ï¼‰

// æ—¶é—´å¯¹æ¯”ï¼š
const start = performance.now();
transaction.commit(); // åˆå¹¶ 100 ä¸ª Patches
const end = performance.now();
// è€—æ—¶ï¼š< 5msï¼ˆImmer.js çš„ produce éå¸¸é«˜æ•ˆï¼‰
```

---

### é«˜çº§ä¼˜åŒ–ï¼šè·¯å¾„çº§åˆ«çš„ Patch å»é‡

å¦‚æœåŒä¸€ä¸ªè·¯å¾„è¢«å¤šæ¬¡ä¿®æ”¹ï¼Œåªä¿ç•™æœ€åä¸€æ¬¡ï¼š

```typescript
/**
 * ç®€åŒ– Patches - åŒä¸€è·¯å¾„åªä¿ç•™æœ€åä¸€æ¬¡ä¿®æ”¹
 */
function simplifyPatches(patches: Patch[]): Patch[] {
  const pathMap = new Map<string, Patch>();

  patches.forEach((patch) => {
    const key = patch.path;

    if (patch.op === 'replace' || patch.op === 'add') {
      // åŒä¸€è·¯å¾„çš„ replace/add æ“ä½œï¼Œåè€…è¦†ç›–å‰è€…
      pathMap.set(key, patch);
    } else if (patch.op === 'remove') {
      // åˆ é™¤æ“ä½œï¼šå¦‚æœä¹‹å‰æœ‰ addï¼Œåˆ™ä¸¤è€…æŠµæ¶ˆ
      if (pathMap.has(key) && pathMap.get(key)!.op === 'add') {
        pathMap.delete(key);
      } else {
        pathMap.set(key, patch);
      }
    }
  });

  return Array.from(pathMap.values());
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// åŸå§‹ Patchesï¼ˆ100 æ¬¡ä¿®æ”¹åŒä¸€è·¯å¾„ï¼‰
const rawPatches = [
  { op: 'replace', path: '/header/color', value: '#ff0000' },
  { op: 'replace', path: '/header/color', value: '#ff0001' },
  // ... 98 more
  { op: 'replace', path: '/header/color', value: '#ff00ff' }
];

// ç®€åŒ–å
const simplified = simplifyPatches(rawPatches);
// ç»“æœï¼šåªä¿ç•™æœ€åä¸€ä¸ª
// [{ op: 'replace', path: '/header/color', value: '#ff00ff' }]

// å†…å­˜èŠ‚çœï¼š100 ä¸ª Patch â†’ 1 ä¸ª Patchï¼ˆ99% å‡å°‘ï¼‰
```

---

### å®ç°æ£€æŸ¥æ¸…å•

**æ ¸å¿ƒç»„ä»¶**ï¼š

- âœ… Transaction ç±»æ”¯æŒ Patch æ”¶é›†
- âœ… commit() æ–¹æ³•å®ç° Patch åˆå¹¶é€»è¾‘
- âœ… æ£€æµ‹é›¶å˜æ›´ï¼ˆmergedPatches.length === 0ï¼‰
- âœ… BatchOperationCommandOptimized å­˜å‚¨åˆå¹¶å Patches
- âœ… å¯é€‰ï¼šsimplifyPatches() è·¯å¾„çº§å»é‡

**æ€§èƒ½è¦æ±‚**ï¼š

- âš¡ Patch åˆå¹¶è€—æ—¶ < 10msï¼ˆå³ä½¿ 100 ä¸ª Patchesï¼‰
- ğŸ“¦ å†…å­˜å ç”¨å‡å°‘ 70-100%ï¼ˆè§†åœºæ™¯ï¼‰
- ğŸ”„ ä¸å½±å“æ­£å¸¸æ’¤é”€/é‡åšåŠŸèƒ½

**æµ‹è¯•åœºæ™¯**ï¼š

1. **å®Œå…¨æŠµæ¶ˆ**ï¼šx: 0â†’100â†’0ï¼ŒéªŒè¯ä¸äº§ç”Ÿå†å²è®°å½•
2. **éƒ¨åˆ†æŠµæ¶ˆ**ï¼šx å’Œ y åŒæ—¶ä¿®æ”¹ï¼Œx å›åˆ°åŸå€¼ï¼ŒéªŒè¯åªè®°å½• y çš„å˜æ›´
3. **æ‰¹é‡æ“ä½œ**ï¼š100 ä¸ªç»„ä»¶å¯¹é½ï¼ŒéªŒè¯åˆå¹¶ä¸º 1 æ¡å†å²
4. **æ’¤é”€/é‡åš**ï¼šéªŒè¯åˆå¹¶åçš„å‘½ä»¤å¯ä»¥æ­£ç¡®æ’¤é”€å’Œé‡åš

---

### æœ€ä½³å®è·µå»ºè®®

1. **é»˜è®¤å¼€å¯ Patch åˆå¹¶**ï¼šæ‰€æœ‰äº‹åŠ¡/æ‰¹é‡æ“ä½œéƒ½åº”è¯¥ä½¿ç”¨åˆå¹¶é€»è¾‘
2. **å¯é€‰è·¯å¾„çº§å»é‡**ï¼šå¦‚æœæ€§èƒ½è¶³å¤Ÿï¼Œå¯ä»¥è·³è¿‡ï¼ˆImmer çš„ produce å·²ç»å¾ˆé«˜æ•ˆï¼‰
3. **å¼€å‘æ¨¡å¼æ—¥å¿—**ï¼šè®°å½•åˆå¹¶å‰åçš„ Patch æ•°é‡ï¼Œç›‘æ§ä¼˜åŒ–æ•ˆæœ
4. **è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼š
   - ç©ºäº‹åŠ¡ï¼ˆfn ä¸­æ²¡æœ‰ä»»ä½•æ“ä½œï¼‰â†’ ä¸äº§ç”Ÿå†å²
   - å¼‚å¸¸å›æ»š â†’ æ¢å¤åˆ° initialState
   - åµŒå¥—äº‹åŠ¡ â†’ è­¦å‘Šæˆ–æŠ¥é”™ï¼ˆä¸æ”¯æŒï¼‰

---

## ğŸ” 10. å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: è°ƒæ•´ç»„ä»¶é¢œè‰²

```
ç”¨æˆ·æ“ä½œ:
1. ç‚¹å‡»é¢œè‰²é€‰æ‹©å™¨
2. æ‹–åŠ¨è‰²ç›¸æ»‘å—ï¼ˆè§¦å‘ 30 æ¬¡ä¿®æ”¹ï¼‰
3. æ¾å¼€é¼ æ ‡

æœŸæœ›è¡Œä¸º:
- 30 æ¬¡ä¿®æ”¹åˆå¹¶ä¸º 1 ä¸ªå†å²è®°å½•
- æ’¤é”€æ—¶ä¸€æ­¥æ¢å¤åˆ°åˆå§‹é¢œè‰²

æŠ€æœ¯å®ç°:
- RAF æ‰¹å¤„ç† + Map è‡ªåŠ¨å»é‡
- 30 ä¸ªå‘½ä»¤ â†’ 1 ä¸ªå‘½ä»¤ï¼ˆ97% å‡å°‘ï¼‰
```

### åœºæ™¯ 2: è¿ç»­ç¼–è¾‘å¤šä¸ªç»„ä»¶

```
ç”¨æˆ·æ“ä½œ:
1. ä¿®æ”¹ Header ç»„ä»¶èƒŒæ™¯è‰²
2. ä¿®æ”¹ Header å­—ä½“å¤§å°
3. æ·»åŠ ä¸€ä¸ª Button ç»„ä»¶
4. ä¿®æ”¹ Button æ–‡æ¡ˆ

æœŸæœ›è¡Œä¸º:
- 4 ä¸ªç‹¬ç«‹å†å²è®°å½•
- å¯ä»¥å•ç‹¬æ’¤é”€æ¯ä¸€æ­¥

æŠ€æœ¯å®ç°:
- ä¸åŒç±»å‹çš„æ“ä½œä¸åˆå¹¶
- ç»“æ„æ€§æ“ä½œï¼ˆæ·»åŠ ç»„ä»¶ï¼‰ç«‹å³åˆ·æ–°æ‰¹æ¬¡
```

### åœºæ™¯ 3: å¤§é‡æ’¤é”€

```
ç”¨æˆ·æ“ä½œ:
1. æ‰§è¡Œäº† 50 æ­¥ç¼–è¾‘æ“ä½œ
2. ç‚¹å‡» "æ’¤é”€" æŒ‰é’® 30 æ¬¡

æœŸæœ›è¡Œä¸º:
- å‰ 29 æ¬¡å¿«é€Ÿæ’¤é”€ï¼ˆ< 10ms æ¯æ¬¡ï¼‰
- åˆ©ç”¨å‘¨æœŸå¿«ç…§åŠ é€Ÿæ¢å¤

æŠ€æœ¯å®ç°:
- undo(steps > 10) è‡ªåŠ¨ä½¿ç”¨å¿«ç…§ä¼˜åŒ–
- æ‰¾åˆ°æœ€è¿‘å¿«ç…§ â†’ æ¢å¤ â†’ é‡æ”¾éƒ¨åˆ†å‘½ä»¤
```

### åœºæ™¯ 4: å¿«é€Ÿè¿ç»­ç‚¹å‡»æ’¤é”€æŒ‰é’®ï¼ˆæ–°å¢ï¼‰

```
ç”¨æˆ·æ“ä½œ:
1. æ‰§è¡Œäº† 50 æ­¥ç¼–è¾‘æ“ä½œ
2. å¿«é€Ÿè¿ç»­ç‚¹å‡» "æ’¤é”€" æŒ‰é’® 30 æ¬¡ï¼ˆæ¯æ¬¡é—´éš” 100msï¼‰

æœŸæœ›è¡Œä¸º:
- æ—  UI é—ªçƒ
- æµç•…çš„æ’¤é”€ä½“éªŒ
- è‡ªåŠ¨åˆ©ç”¨å¿«ç…§ä¼˜åŒ–

æŠ€æœ¯å®ç°:
- æ’¤é”€/é‡åšæ‰¹å¤„ç†ï¼ˆæ–¹æ¡ˆ 5ï¼‰
- 150ms æ‰¹å¤„ç†çª—å£æ”¶é›†ç‚¹å‡»
- 30 æ¬¡ç‚¹å‡» â†’ 1 æ¬¡æ‰§è¡Œ undo(30)
- è‡ªåŠ¨è§¦å‘å¿«ç…§ä¼˜åŒ–ï¼ˆ30 > 10ï¼‰
- åªè§¦å‘ 1 æ¬¡æ¸²æŸ“

æ€§èƒ½å¯¹æ¯”:
- æ— ä¼˜åŒ–: 30 æ¬¡æ‰§è¡Œ + 30 æ¬¡æ¸²æŸ“ = ~780ms
- æ‰¹å¤„ç†: 1 æ¬¡æ‰§è¡Œ + 1 æ¬¡æ¸²æŸ“ = ~50ms
- æå‡: 15.6 å€
```

### åœºæ™¯ 5: æ–‡ä»¶æ›¿æ¢

```
ç”¨æˆ·æ“ä½œ:
1. ä¸Šä¼ æ–°çš„èƒŒæ™¯å›¾ç‰‡ï¼ˆ10MBï¼‰
2. æ’¤é”€ä¸Šä¼ 
3. é‡åšä¸Šä¼ 

æœŸæœ›è¡Œä¸º:
- ä¸å­˜å‚¨å›¾ç‰‡å†…å®¹åˆ°å†…å­˜
- ä»…è®°å½•æ–‡ä»¶è·¯å¾„å’Œ hash
- ä»ä¸´æ—¶ç›®å½•æ¢å¤æ—§æ–‡ä»¶

æŠ€æœ¯å®ç°:
- æ–‡ä»¶æ± ç®¡ç†ï¼ˆFilePoolManagerï¼‰
- å†…å®¹å¯»å€å­˜å‚¨ï¼ˆhash å‘½åï¼‰
- å¼•ç”¨è®¡æ•°ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- 30 åˆ†é’Ÿå»¶è¿Ÿ GC
```

### åœºæ™¯ 6: æ‰¹é‡å¯¼å…¥ä¸»é¢˜åŠ¨ç”»

```
ç”¨æˆ·æ“ä½œ:
1. æ‰¹é‡å¯¼å…¥ 30 å¼ å……ç”µåŠ¨ç”»å¸§
2. é¢„è§ˆæ•ˆæœä¸æ»¡æ„
3. ç‚¹å‡»æ’¤é”€

æœŸæœ›è¡Œä¸º:
- 30 ä¸ªæ–‡ä»¶ + 30 ä¸ª XML ä¿®æ”¹ â†’ 1 æ¡å†å²è®°å½•
- æ’¤é”€æ—¶ä¸€æ­¥åˆ é™¤æ•´ä¸ªåŠ¨ç”»
- æ–‡ä»¶æ± è‡ªåŠ¨ç®¡ç† 30 ä¸ªæ–‡ä»¶çš„å¼•ç”¨

æŠ€æœ¯å®ç°:
- äº‹åŠ¡æ¨¡å¼ï¼ˆTransactionï¼‰
- æ‰¹é‡æ“ä½œåˆå¹¶ä¸º 1 ä¸ª BatchOperationCommand
- æ–‡ä»¶å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç»´æŠ¤
```

---

## ğŸ›¡ï¸ 11. é™çº§ä¸å®¹é”™ç­–ç•¥ï¼ˆæ–°å¢ï¼‰

> æœ¬ç« èŠ‚ä¸ºæ–°å¢å†…å®¹ï¼Œæä¾›åœ¨æç«¯æƒ…å†µä¸‹ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„é™çº§æ–¹æ¡ˆã€‚

### 11.1 Immer æ€§èƒ½é™çº§æ–¹æ¡ˆ

**é—®é¢˜åœºæ™¯**: Immer åœ¨æå¤§å‹ Schemaï¼ˆ>20MBï¼‰æˆ–æ·±å±‚åµŒå¥—ï¼ˆ>15å±‚ï¼‰æ—¶å¯èƒ½æ€§èƒ½ä¸è¾¾æ ‡

**è§£å†³æ–¹æ¡ˆ**: è‡ªåŠ¨ç›‘æ§ + é™çº§åˆ°å¿«ç…§æ¨¡å¼

```typescript
class HybridHistoryManager {
  private useImmer = true;
  private performanceMonitor = {
    avgPatchTime: 0,
    sampleCount: 0,
    degradeThreshold: 20, // ms
    samples: [] as number[]
  };

  execute(command: ICommand): void {
    const startTime = performance.now();

    if (this.useImmer) {
      // å°è¯•ä½¿ç”¨ Immer Patch æ¨¡å¼
      try {
        command.execute();

        // ç›‘æ§æ€§èƒ½
        const duration = performance.now() - startTime;
        this.updatePerformanceMetrics(duration);

        // æ€§èƒ½ä¸è¾¾æ ‡ï¼Œé™çº§
        if (this.shouldDegrade()) {
          console.warn('[History] Immer performance degraded, switching to snapshot mode');
          this.degradeToSnapshotMode();
        }
      } catch (error) {
        console.error('[History] Immer execution failed, degrading', error);
        this.degradeToSnapshotMode();
        // é‡è¯•ä¸€æ¬¡
        this.executeWithSnapshot(command);
      }
    } else {
      // å·²é™çº§ä¸ºå¿«ç…§æ¨¡å¼
      this.executeWithSnapshot(command);
    }

    this.undoStack.push(command);
    this.emitStateChange();
  }

  private updatePerformanceMetrics(duration: number): void {
    const { samples } = this.performanceMonitor;

    samples.push(duration);
    if (samples.length > 100) {
      samples.shift(); // ä¿æŒæœ€è¿‘100ä¸ªæ ·æœ¬
    }

    // è®¡ç®—ç§»åŠ¨å¹³å‡
    this.performanceMonitor.avgPatchTime = samples.reduce((sum, val) => sum + val, 0) / samples.length;
    this.performanceMonitor.sampleCount = samples.length;
  }

  private shouldDegrade(): boolean {
    const { avgPatchTime, sampleCount, degradeThreshold } = this.performanceMonitor;

    // éœ€è¦è‡³å°‘20ä¸ªæ ·æœ¬æ‰åˆ¤æ–­
    if (sampleCount < 20) return false;

    // å¹³å‡æ—¶é—´è¶…è¿‡é˜ˆå€¼
    if (avgPatchTime > degradeThreshold) {
      console.warn(`[History] Avg patch time: ${avgPatchTime.toFixed(2)}ms > ${degradeThreshold}ms`);
      return true;
    }

    return false;
  }

  private degradeToSnapshotMode(): void {
    this.useImmer = false;
    this.config.snapshotInterval = 1; // æ¯æ­¥éƒ½ä¿å­˜å¿«ç…§

    this.emit('mode-change', {
      mode: 'snapshot',
      reason: 'immer-performance',
      avgPatchTime: this.performanceMonitor.avgPatchTime
    });

    // é€šçŸ¥ç”¨æˆ·
    this.notifyUser({
      type: 'warning',
      title: 'æ€§èƒ½ä¼˜åŒ–',
      message: 'æ£€æµ‹åˆ°å¤§å‹Schemaï¼Œå·²åˆ‡æ¢åˆ°å…¼å®¹æ¨¡å¼ã€‚åŠŸèƒ½æ­£å¸¸ï¼Œä½†å†…å­˜å ç”¨ä¼šç•¥æœ‰å¢åŠ ã€‚'
    });
  }

  private executeWithSnapshot(command: ICommand): void {
    // å¿«ç…§æ¨¡å¼ï¼šä¿å­˜å®Œæ•´çŠ¶æ€
    const snapshot = this.cloneState(this.schemaManager.getState());
    (command as any).snapshot = snapshot;
    (command as any).useSnapshot = true;
    command.execute();
  }

  /**
   * æ”¯æŒè¿è¡Œæ—¶é‡æ–°å¯ç”¨ Immerï¼ˆç”¨äºæµ‹è¯•ï¼‰
   */
  tryUpgradeToImmer(): boolean {
    if (this.useImmer) return true;

    console.log('[History] Attempting to upgrade to Immer mode...');

    // é‡ç½®æ€§èƒ½ç›‘æ§
    this.performanceMonitor = {
      avgPatchTime: 0,
      sampleCount: 0,
      degradeThreshold: 20,
      samples: []
    };

    this.useImmer = true;
    this.config.snapshotInterval = 20; // æ¢å¤å‘¨æœŸå¿«ç…§

    return true;
  }
}
```

**é™çº§æ•ˆæœå¯¹æ¯”**:

| æ¨¡å¼          | å†…å­˜å ç”¨         | æ€§èƒ½          | ç¨³å®šæ€§         |
| ------------- | ---------------- | ------------- | -------------- |
| **Immeræ¨¡å¼** | ä½ï¼ˆ50KB/100æ­¥ï¼‰ | å¿«ï¼ˆ<5msï¼‰    | æ­£å¸¸Schemaé€‚ç”¨ |
| **å¿«ç…§æ¨¡å¼**  | é«˜ï¼ˆ50MB/100æ­¥ï¼‰ | ä¸­ï¼ˆ10-20msï¼‰ | ä»»ä½•Schemaé€‚ç”¨ |

---

### 11.2 å†…å­˜ç›‘æ§ä¸è‡ªåŠ¨æ¸…ç†

**é—®é¢˜åœºæ™¯**: é•¿æ—¶é—´ç¼–è¾‘å¯¼è‡´å†…å­˜æŒç»­å¢é•¿ï¼Œå¯èƒ½å¼•å‘OOM

**è§£å†³æ–¹æ¡ˆ**: åˆ†çº§ç›‘æ§ + è‡ªåŠ¨æ¸…ç†

```typescript
class MemoryGuard {
  private warningThreshold = 400 * 1024 * 1024;  // 400MB
  private criticalThreshold = 480 * 1024 * 1024; // 480MB
  private checkInterval = 10000; // 10ç§’

  private historyManager: HistoryManager;
  private filePool: FilePoolManager;
  private monitorTimer: NodeJS.Timeout | null = null;

  constructor(historyManager: HistoryManager, filePool: FilePoolManager) {
    this.historyManager = historyManager;
    this.filePool = filePool;
  }

  /**
   * å¯åŠ¨å†…å­˜ç›‘æ§
   */
  startMonitoring(): void {
    if (this.monitorTimer) return;

    console.log('[MemoryGuard] Monitoring started');

    this.monitorTimer = setInterval(() => {
      this.checkMemory();
    }, this.checkInterval);

    // è¿›ç¨‹é€€å‡ºå‰åœæ­¢ç›‘æ§
    process.on('exit', () => this.stopMonitoring());
  }

  stopMonitoring(): void {
    if (this.monitorTimer) {
      clearInterval(this.monitorTimer);
      this.monitorTimer = null;
      console.log('[MemoryGuard] Monitoring stopped');
    }
  }

  private checkMemory(): void {
    const usage = process.memoryUsage();
    const heapUsed = usage.heapUsed;
    const heapTotal = usage.heap Total;
    const external = usage.external;

    console.log(`[MemoryGuard] Heap: ${(heapUsed / 1024 / 1024).toFixed(1)}MB / ${(heapTotal / 1024 / 1024).toFixed(1)}MB, External: ${(external / 1024 / 1024).toFixed(1)}MB`);

    if (heapUsed > this.criticalThreshold) {
      this.handleCriticalMemory(heapUsed);
    } else if (heapUsed > this.warningThreshold) {
      this.handleWarningMemory(heapUsed);
    }
  }

  /**
   * è­¦å‘Šçº§åˆ«ï¼šæ¸©å’Œæ¸…ç†
   */
  private handleWarningMemory(heapUsed: number): void {
    console.warn(`[MemoryGuard] âš ï¸ High memory usage: ${(heapUsed / 1024 / 1024).toFixed(1)}MB`);

    // 1. è£å‰ªå†å²è®°å½•ï¼ˆä¿ç•™æœ€è¿‘50æ­¥ï¼‰
    const beforeCount = this.historyManager.getUndoStack().length;
    this.historyManager.trimHistory(50);
    const afterCount = this.historyManager.getUndoStack().length;

    console.log(`[MemoryGuard] Trimmed history: ${beforeCount} â†’ ${afterCount}`);

    // 2. è§¦å‘æ–‡ä»¶æ± GCï¼ˆä¸­ç­‰å‹åŠ›ï¼‰
    this.filePool.tieredGC('medium').then(report => {
      console.log(`[MemoryGuard] GC: deleted ${report.deletedFiles} files, reclaimed ${(report.reclaimedBytes / 1024 / 1024).toFixed(1)}MB`);
    });

    // 3. æ¸…ç†æ—§å¿«ç…§ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
    this.historyManager.trimSnapshots(3);

    // 4. æ‰‹åŠ¨è§¦å‘V8åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (global.gc) {
      global.gc();
      console.log('[MemoryGuard] Manual GC triggered');
    }
  }

  /**
   * å±é™©çº§åˆ«ï¼šæ¿€è¿›æ¸…ç†
   */
  private handleCriticalMemory(heapUsed: number): void {
    console.error(`[MemoryGuard] ğŸš¨ CRITICAL memory usage: ${(heapUsed / 1024 / 1024).toFixed(1)}MB`);

    // 1. æ¸…ç©ºå†å²è®°å½•ï¼ˆä»…ä¿ç•™æœ€è¿‘20æ­¥ï¼‰
    this.historyManager.clear();
    this.historyManager.maxHistorySize = 20;

    console.log('[MemoryGuard] History cleared, max size set to 20');

    // 2. ç´§æ€¥æ¸…ç†æ–‡ä»¶æ± ï¼ˆé«˜å‹åŠ›ï¼Œå¿½ç•¥ä¿æŠ¤æœŸï¼‰
    this.filePool.tieredGC('high').then(report => {
      console.log(`[MemoryGuard] Emergency GC: deleted ${report.deletedFiles} files, reclaimed ${(report.reclaimedBytes / 1024 / 1024).toFixed(1)}MB`);
    });

    // 3. æ¸…ç©ºæ‰€æœ‰å¿«ç…§
    this.historyManager.clearSnapshots();

    // 4. å¼ºåˆ¶V8 GC
    if (global.gc) {
      global.gc();
      global.gc(); // è¿ç»­ä¸¤æ¬¡
    }

    // 5. é€šçŸ¥ç”¨æˆ·
    this.notifyUser({
      type: 'error',
      title: 'å†…å­˜ä¸è¶³',
      message: 'å†å²è®°å½•å·²è¢«æ¸…ç†ä»¥é‡Šæ”¾å†…å­˜ã€‚å»ºè®®ä¿å­˜é¡¹ç›®å¹¶é‡å¯ç¼–è¾‘å™¨ã€‚',
      persistent: true,
      actions: [
        { label: 'ä¿å­˜é¡¹ç›®', onClick: () => this.saveProject() },
        { label: 'ç»§ç»­ç¼–è¾‘', onClick: () => {} }
      ]
    });
  }

  /**
   * è·å–å½“å‰å†…å­˜çŠ¶æ€
   */
  getMemoryStatus(): {
    level: 'normal' | 'warning' | 'critical';
    heapUsed: number;
    heapTotal: number;
    percentage: number;
  } {
    const usage = process.memoryUsage();
    const heapUsed = usage.heapUsed;
    const heapTotal = usage.heapTotal;
    const percentage = (heapUsed / heapTotal) * 100;

    let level: 'normal' | 'warning' | 'critical' = 'normal';
    if (heapUsed > this.criticalThreshold) {
      level = 'critical';
    } else if (heapUsed > this.warningThreshold) {
      level = 'warning';
    }

    return { level, heapUsed, heapTotal, percentage };
  }
}

// æ–‡ä»¶æ± åˆ†çº§GC
class FilePoolManager {
  /**
   * åˆ†çº§ GC ç­–ç•¥ï¼š
   * - low: >30åˆ†é’Ÿé›¶å¼•ç”¨åˆ é™¤
   * - medium: >10åˆ†é’Ÿé›¶å¼•ç”¨åˆ é™¤
   * - high: >3åˆ†é’Ÿé›¶å¼•ç”¨åˆ é™¤
   */
  async tieredGC(pressure: 'low' | 'medium' | 'high'): Promise<GCReport> {
    const now = Date.now();
    const report: GCReport = { deletedFiles: 0, reclaimedBytes: 0 };

    let ageThreshold: number;
    switch (pressure) {
      case 'high':
        ageThreshold = 3 * 60 * 1000; // 3åˆ†é’Ÿ
        break;
      case 'medium':
        ageThreshold = 10 * 60 * 1000; // 10åˆ†é’Ÿ
        break;
      case 'low':
      default:
        ageThreshold = 30 * 60 * 1000; // 30åˆ†é’Ÿ
    }

    for (const [hash, ref] of Object.entries(this.refCount)) {
      if (ref.count > 0) continue;

      const zeroRefSince = ref.zeroRefTimestamp || 0;
      const age = now - zeroRefSince;

      if (age > ageThreshold) {
        const meta = this.metadata.get(hash);
        if (meta) {
          await this.deleteFile(hash);
          report.deletedFiles++;
          report.reclaimedBytes += meta.size;
        }
      }
    }

    console.log(`[FilePool] Tiered GC (${pressure}): deleted ${report.deletedFiles} files, ${(report.reclaimedBytes / 1024 / 1024).toFixed(1)}MB`);

    return report;
  }

  private async deleteFile(hash: string): Promise<void> {
    const meta = this.metadata.get(hash);
    if (!meta) return;

    const poolPath = path.join(this.poolDir, `${hash}${path.extname(meta.originalName)}`);

    if (fs.existsSync(poolPath)) {
      await fs.promises.unlink(poolPath);
      this.metadata.delete(hash);
      delete this.refCount[hash];
    }
  }
}
```

**ç›‘æ§æ•ˆæœ**:

| å†…å­˜çº§åˆ« | è§¦å‘æ¡ä»¶  | æ¸…ç†ç­–ç•¥              | ç”¨æˆ·å½±å“         |
| -------- | --------- | --------------------- | ---------------- |
| **æ­£å¸¸** | <400MB    | æ—                     | æ—                |
| **è­¦å‘Š** | 400-480MB | ä¿ç•™50æ­¥å†å² + ä¸­ç­‰GC | è½»å¾®ï¼ˆå†å²å˜çŸ­ï¼‰ |
| **å±é™©** | >480MB    | ä¿ç•™20æ­¥å†å² + æ¿€è¿›GC | æ˜æ˜¾ï¼ˆéœ€é‡å¯ï¼‰   |

---

### 11.3 å›æ»šç­–ç•¥

**é—®é¢˜åœºæ™¯**: æ–°æ–¹æ¡ˆä¸Šçº¿åå¯èƒ½å‡ºç°æœªé¢„æœŸçš„é—®é¢˜ï¼Œéœ€è¦å¿«é€Ÿå›é€€

**è§£å†³æ–¹æ¡ˆ**: é…ç½®åŒ–åˆ‡æ¢ + è¿è¡Œæ—¶çƒ­åˆ‡æ¢

```typescript
/**
 * é…ç½®æ–‡ä»¶ç»“æ„
 */
interface EditorConfig {
  history: {
    mode: 'modern' | 'legacy'; // modern = æ–°æ–¹æ¡ˆï¼Œlegacy = æ—§å¿«ç…§æ–¹æ¡ˆ
    maxHistorySize: number;
    snapshotInterval: number;
    enableAutoMerge: boolean;
    degradeThreshold: number;
  };
}

/**
 * æ”¯æŒæ–°æ—§æ–¹æ¡ˆåˆ‡æ¢çš„ HistoryManager
 */
class HistoryManagerV2 {
  private mode: 'modern' | 'legacy';
  private config: EditorConfig['history'];

  constructor(config: EditorConfig['history']) {
    this.config = config;
    this.mode = config.mode;

    console.log(`[History] Initialized in ${this.mode} mode`);
  }

  execute(command: ICommand): void {
    if (this.mode === 'legacy') {
      this.legacyExecute(command);
    } else {
      this.modernExecute(command);
    }
  }

  /**
   * æ—§æ–¹æ¡ˆï¼šå®Œæ•´å¿«ç…§æ¨¡å¼
   */
  private legacyExecute(command: ICommand): void {
    // ä¿å­˜å®Œæ•´å¿«ç…§
    const snapshot = JSON.parse(JSON.stringify(this.schemaManager.getState()));
    (command as any).snapshot = snapshot;
    (command as any).useLegacy = true;

    command.execute();
    this.undoStack.push(command);
    this.redoStack = [];
  }

  /**
   * æ–°æ–¹æ¡ˆï¼šCommand + Immer Patch
   */
  private modernExecute(command: ICommand): void {
    // å°è¯•åˆå¹¶
    if (this.config.enableAutoMerge && this.tryMergeCommand(command)) {
      return;
    }

    // æ‰§è¡Œå‘½ä»¤
    command.execute();
    this.undoStack.push(command);
    this.redoStack = [];

    // å‘¨æœŸå¿«ç…§
    this.saveSnapshotIfNeeded();
  }

  undo(steps: number = 1): void {
    if (this.mode === 'legacy') {
      this.legacyUndo(steps);
    } else {
      this.modernUndo(steps);
    }
  }

  private legacyUndo(steps: number): void {
    for (let i = 0; i < steps; i++) {
      const command = this.undoStack.pop();
      if (!command) break;

      // æ¢å¤å¿«ç…§
      const snapshot = (command as any).snapshot;
      if (snapshot) {
        this.schemaManager.setState(snapshot);
      }

      this.redoStack.push(command);
    }
  }

  private modernUndo(steps: number): void {
    // ä½¿ç”¨å¿«ç…§ä¼˜åŒ–
    if (steps > 10) {
      this.undoWithSnapshot(steps);
    } else {
      for (let i = 0; i < steps; i++) {
        this.undoOne();
      }
    }
  }

  /**
   * è¿è¡Œæ—¶åˆ‡æ¢æ¨¡å¼ï¼ˆç”¨äºç°åº¦æµ‹è¯•ï¼‰
   */
  switchMode(newMode: 'modern' | 'legacy'): void {
    if (this.mode === newMode) return;

    console.log(`[History] Switching from ${this.mode} to ${newMode} mode`);

    // æ¸…ç©ºå½“å‰å†å²ï¼Œé¿å…æ¨¡å¼æ··åˆå¯¼è‡´çš„é—®é¢˜
    this.clear();

    this.mode = newMode;
    this.config.mode = newMode;

    this.emit('mode-switched', { from: this.mode, to: newMode });
  }

  /**
   * è·å–å½“å‰æ¨¡å¼
   */
  getMode(): 'modern' | 'legacy' {
    return this.mode;
  }
}

// é…ç½®ç¤ºä¾‹
const config: EditorConfig = {
  history: {
    mode: 'modern', // é»˜è®¤ä½¿ç”¨æ–°æ–¹æ¡ˆ
    maxHistorySize: 100,
    snapshotInterval: 20,
    enableAutoMerge: true,
    degradeThreshold: 20
  }
};

// è¿è¡Œæ—¶å›é€€ç¤ºä¾‹
function emergencyRollback(editor: ThemeEditor): void {
  console.warn('[Emergency] Rolling back to legacy mode');

  editor.historyManager.switchMode('legacy');

  // é€šçŸ¥ç”¨æˆ·
  showNotification({
    type: 'warning',
    title: 'ç³»ç»Ÿåˆ‡æ¢åˆ°å…¼å®¹æ¨¡å¼',
    message: 'æ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜ï¼Œå·²åˆ‡æ¢åˆ°ç¨³å®šçš„å…¼å®¹æ¨¡å¼ã€‚'
  });
}
```

**å›æ»šæ—¶æœº**:

| åœºæ™¯           | è§¦å‘æ¡ä»¶     | å›æ»šæ–¹å¼   | æ¢å¤æ—¶é—´ |
| -------------- | ------------ | ---------- | -------- |
| **å¼€å‘æµ‹è¯•**   | æ‰‹åŠ¨åˆ‡æ¢     | é…ç½®æ–‡ä»¶   | é‡å¯åº”ç”¨ |
| **ç”Ÿäº§é—®é¢˜**   | é”™è¯¯ç‡>5%    | è¿è¡Œæ—¶åˆ‡æ¢ | ç«‹å³ç”Ÿæ•ˆ |
| **æ€§èƒ½ä¸è¾¾æ ‡** | è‡ªåŠ¨é™çº§è§¦å‘ | è‡ªåŠ¨åˆ‡æ¢   | ç«‹å³ç”Ÿæ•ˆ |

---

### 11.4 åŠ¨æ€å¿«ç…§ç­–ç•¥

**é—®é¢˜åœºæ™¯**: å›ºå®š20æ­¥å¿«ç…§é—´éš”ä¸é€‚åº”æ‰€æœ‰åœºæ™¯ï¼ˆå¤§Schemaå¿«ç…§å¼€é”€å¤§ï¼‰

**è§£å†³æ–¹æ¡ˆ**: åŸºäºå†…å­˜å‹åŠ›åŠ¨æ€è°ƒæ•´é—´éš”

```typescript
class AdaptiveSnapshotStrategy {
  private lastSnapshotMemory = 0;
  private baseInterval = 20;
  private currentInterval = 20;
  private minInterval = 10;
  private maxInterval = 50;

  /**
   * åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ›å»ºå¿«ç…§
   */
  shouldCreateSnapshot(currentStep: number): boolean {
    if (currentStep % this.currentInterval === 0) {
      // è®°å½•å¿«ç…§æ—¶çš„å†…å­˜
      const currentMemory = process.memoryUsage().heapUsed;
      this.adjustInterval(currentMemory);
      this.lastSnapshotMemory = currentMemory;
      return true;
    }
    return false;
  }

  /**
   * æ ¹æ®å†…å­˜å¢é•¿åŠ¨æ€è°ƒæ•´é—´éš”
   */
  private adjustInterval(currentMemory: number): void {
    if (this.lastSnapshotMemory === 0) return;

    const memGrowth = currentMemory - this.lastSnapshotMemory;
    const growthMB = memGrowth / 1024 / 1024;

    console.log(`[AdaptiveSnapshot] Memory growth: ${growthMB.toFixed(1)}MB since last snapshot`);

    // å†…å­˜å¢é•¿æ…¢ï¼ˆ<5MBï¼‰ï¼Œå»¶é•¿é—´éš”
    if (growthMB < 5) {
      this.currentInterval = Math.min(this.maxInterval, this.currentInterval + 5);
      console.log(`[AdaptiveSnapshot] Low growth, increasing interval to ${this.currentInterval}`);
    }

    // å†…å­˜å¢é•¿å¿«ï¼ˆ>10MBï¼‰ï¼Œç¼©çŸ­é—´éš”
    if (growthMB > 10) {
      this.currentInterval = Math.max(this.minInterval, this.currentInterval - 5);
      console.log(`[AdaptiveSnapshot] High growth, decreasing interval to ${this.currentInterval}`);
    }

    // å†…å­˜å¢é•¿éå¸¸å¿«ï¼ˆ>20MBï¼‰ï¼Œç«‹å³å¿«ç…§
    if (growthMB > 20) {
      this.currentInterval = this.minInterval;
      console.warn(`[AdaptiveSnapshot] Very high growth, forcing min interval ${this.minInterval}`);
    }
  }

  /**
   * é‡ç½®ç­–ç•¥ï¼ˆç”¨äºæ¨¡å¼åˆ‡æ¢åï¼‰
   */
  reset(): void {
    this.currentInterval = this.baseInterval;
    this.lastSnapshotMemory = 0;
  }

  /**
   * è·å–å½“å‰é—´éš”
   */
  getCurrentInterval(): number {
    return this.currentInterval;
  }
}
```

**åŠ¨æ€è°ƒæ•´æ•ˆæœ**:

| åœºæ™¯         | å†…å­˜å¢é•¿    | å¿«ç…§é—´éš”è°ƒæ•´   | æ•ˆæœ         |
| ------------ | ----------- | -------------- | ------------ |
| **è½»é‡ç¼–è¾‘** | <5MB/20æ­¥   | 20 â†’ 30 â†’ 40æ­¥ | å‡å°‘å¿«ç…§å¼€é”€ |
| **æ­£å¸¸ç¼–è¾‘** | 5-10MB/20æ­¥ | ä¿æŒ20æ­¥       | å¹³è¡¡         |
| **é‡åº¦ç¼–è¾‘** | >10MB/20æ­¥  | 20 â†’ 15 â†’ 10æ­¥ | åŠ é€Ÿæ’¤é”€     |
| **æç«¯åœºæ™¯** | >20MB/20æ­¥  | å¼ºåˆ¶10æ­¥       | ä¿è¯æ€§èƒ½     |

---

### 11.5 å®¹é”™æ€»ç»“

| ç­–ç•¥             | è§¦å‘æ¡ä»¶       | æ•ˆæœ            | ç”¨æˆ·å½±å“         |
| ---------------- | -------------- | --------------- | ---------------- |
| **Immeré™çº§**    | Patchè€—æ—¶>20ms | åˆ‡æ¢å¿«ç…§æ¨¡å¼    | è½»å¾®ï¼ˆå†…å­˜å¢åŠ ï¼‰ |
| **å†…å­˜è­¦å‘Šæ¸…ç†** | å †å†…å­˜>400MB   | ä¿ç•™50æ­¥å†å²    | è½»å¾®ï¼ˆå†å²å˜çŸ­ï¼‰ |
| **å†…å­˜å±é™©æ¸…ç†** | å †å†…å­˜>480MB   | ä¿ç•™20æ­¥å†å²    | æ˜æ˜¾ï¼ˆéœ€é‡å¯ï¼‰   |
| **å›æ»šæ—§æ–¹æ¡ˆ**   | é”™è¯¯ç‡>5%      | è¿è¡Œæ—¶åˆ‡æ¢      | æ— ï¼ˆé€æ˜åˆ‡æ¢ï¼‰   |
| **åŠ¨æ€å¿«ç…§**     | å†…å­˜å¢é•¿å¼‚å¸¸   | è°ƒæ•´é—´éš”10-50æ­¥ | æ—                |

**æ‰€æœ‰é™çº§æ–¹æ¡ˆçš„æ ¸å¿ƒåŸåˆ™**:

1. âœ… **ä¼˜å…ˆä¿è¯åŠŸèƒ½å¯ç”¨**ï¼ˆå®å¯é™çº§ä¹Ÿä¸å´©æºƒï¼‰
2. âœ… **è‡ªåŠ¨ç›‘æ§ä¸é™çº§**ï¼ˆæ— éœ€äººå·¥å¹²é¢„ï¼‰
3. âœ… **é€æ˜åŒ–å¤„ç†**ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥æˆ–ä»…è½»å¾®æç¤ºï¼‰
4. âœ… **å¯æ¢å¤æ€§**ï¼ˆæ¡ä»¶æ”¹å–„åå¯è‡ªåŠ¨æ¢å¤ï¼‰
5. âœ… **å®Œæ•´æ—¥å¿—**ï¼ˆä¾¿äºé—®é¢˜æ’æŸ¥ï¼‰

---

## âš ï¸ 12. é”™è¯¯å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ

### æ ¸å¿ƒåŸåˆ™

æ’¤é”€/é‡åšç³»ç»Ÿå¿…é¡»ä¿è¯**æ•°æ®ä¸€è‡´æ€§**å’Œ**æ“ä½œå¯é€†æ€§**ï¼Œå³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿä¸èƒ½æŸåç”¨æˆ·æ•°æ®ã€‚

---

### 1. æ–‡ä»¶ä¸¢å¤±å¤„ç†

#### é—®é¢˜åœºæ™¯

ç”¨æˆ·æ’¤é”€æ–‡ä»¶æ›¿æ¢æ“ä½œæ—¶ï¼Œæ—§æ–‡ä»¶å¯èƒ½å·²è¢«åƒåœ¾å›æ”¶åˆ é™¤ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼ˆæ— ä¿æŠ¤ï¼‰ï¼š

```typescript
undo(): void {
  // âŒ å±é™©ï¼šç›´æ¥æ¢å¤æ–‡ä»¶å¼•ç”¨
  this.schemaManager.update(draft => {
    draft.assets.images.get(this.assetKey).hash = this.oldHash;
  });
  // å¦‚æœæ–‡ä»¶å·²è¢« GC åˆ é™¤ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°"å›¾ç‰‡åŠ è½½å¤±è´¥"
}
```

**æ­£ç¡®æ–¹æ¡ˆ**ï¼ˆæ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§ï¼‰ï¼š

```typescript
undo(): void {
  // âœ… 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜å­˜åœ¨
  const filePath = this.filePool.getFilePath(this.oldHash);

  if (!filePath || !fs.existsSync(filePath)) {
    // 2. æ–‡ä»¶å·²ä¸¢å¤±ï¼Œæç¤ºç”¨æˆ·
    throw new UndoError(
      `æ— æ³•æ’¤é”€ï¼šæ–‡ä»¶å·²è¢«æ¸…ç† (hash: ${this.oldHash.substring(0, 8)}...)`,
      {
        type: 'FILE_MISSING',
        hash: this.oldHash,
        canRetry: false,
        suggestion: 'è¯¥æ“ä½œå·²è¶…è¿‡æ’¤é”€æ—¶é—´çª—å£ï¼ˆ30åˆ†é’Ÿï¼‰ï¼Œæ–‡ä»¶å·²è¢«æ¸…ç†'
      }
    );
  }

  // 3. æ–‡ä»¶å­˜åœ¨ï¼Œæ‰§è¡Œæ’¤é”€
  this.schemaManager.update(draft => {
    draft.assets.images.get(this.assetKey).hash = this.oldHash;
  });
  this.filePool.addReference(this.oldHash, this.id);
}
```

**UI å±‚å¤„ç†**ï¼š

```typescript
// ç¼–è¾‘å™¨é”™è¯¯å¤„ç†
editor.on('undo-error', (error: UndoError) => {
  if (error.type === 'FILE_MISSING') {
    showNotification({
      type: 'warning',
      title: 'æ— æ³•æ’¤é”€',
      message: error.message,
      actions: [
        { label: 'ä¿ç•™å½“å‰ç‰ˆæœ¬', onClick: () => {} },
        { label: 'é‡æ–°ä¸Šä¼ æ–‡ä»¶', onClick: () => openFileDialog() }
      ]
    });
  }
});
```

---

### 2. å†…å­˜ä¸è¶³å¤„ç†

#### é—®é¢˜åœºæ™¯

100 æ­¥å†å²è®°å½• + å¤§é‡æ–‡ä»¶ = å†…å­˜æº¢å‡º â†’ Electron å´©æºƒ

**ç›‘æ§ç­–ç•¥**ï¼š

```typescript
class MemoryMonitor {
  private warningThreshold = 400 * 1024 * 1024; // 400MB
  private criticalThreshold = 480 * 1024 * 1024; // 480MB

  /**
   * å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨ï¼ˆæ¯ 10 ç§’ï¼‰
   */
  startMonitoring(): void {
    setInterval(() => {
      const usage = process.memoryUsage();
      const heapUsed = usage.heapUsed;

      if (heapUsed > this.criticalThreshold) {
        this.handleCriticalMemory();
      } else if (heapUsed > this.warningThreshold) {
        this.handleWarningMemory();
      }
    }, 10000);
  }

  /**
   * è­¦å‘Šçº§åˆ«ï¼šæç¤ºç”¨æˆ·
   */
  private handleWarningMemory(): void {
    console.warn('[Memory] High memory usage detected');

    // è§¦å‘è‡ªåŠ¨æ¸…ç†
    historyManager.trimOldHistory(50); // ä¿ç•™æœ€è¿‘ 50 æ­¥
    filePool.garbageCollect();
  }

  /**
   * å±é™©çº§åˆ«ï¼šå¼ºåˆ¶æ¸…ç†
   */
  private handleCriticalMemory(): void {
    console.error('[Memory] Critical memory usage!');

    // 1. æ¸…ç†å†å²è®°å½•ï¼ˆä¿ç•™æœ€è¿‘ 20 æ­¥ï¼‰
    historyManager.clear();
    historyManager.maxHistorySize = 20;

    // 2. ç«‹å³æ‰§è¡Œ GCï¼ˆé›¶å¼•ç”¨æ–‡ä»¶å…¨åˆ ï¼‰
    filePool.emergencyCleanup();

    // 3. æ¸…ç©ºå¿«ç…§
    historyManager.clearSnapshots();

    // 4. é€šçŸ¥ç”¨æˆ·
    showNotification({
      type: 'error',
      title: 'å†…å­˜ä¸è¶³',
      message: 'å†å²è®°å½•å·²è¢«æ¸…ç†ä»¥é‡Šæ”¾å†…å­˜ã€‚å»ºè®®ä¿å­˜é¡¹ç›®å¹¶é‡å¯ç¼–è¾‘å™¨ã€‚',
      persistent: true
    });
  }
}
```

**æ–‡ä»¶æ± ç´§æ€¥æ¸…ç†**ï¼š

```typescript
class FilePoolManager {
  /**
   * ç´§æ€¥æ¸…ç†ï¼šåˆ é™¤æ‰€æœ‰é›¶å¼•ç”¨æ–‡ä»¶ï¼ˆå¿½ç•¥ 30 åˆ†é’Ÿä¿æŠ¤æœŸï¼‰
   */
  async emergencyCleanup(): Promise<void> {
    const deleted: string[] = [];

    for (const [hash, meta] of this.metadata.entries()) {
      if (this.refCount[hash]?.count === 0) {
        const filePath = this.getFilePath(hash);
        if (filePath && fs.existsSync(filePath)) {
          await fs.promises.unlink(filePath);
          this.metadata.delete(hash);
          delete this.refCount[hash];
          deleted.push(hash);
        }
      }
    }

    console.log(`[Emergency GC] Deleted ${deleted.length} files`);
  }
}
```

---

### 3. æ“ä½œæ ˆæº¢å‡ºå¤„ç†

#### é—®é¢˜åœºæ™¯

ç”¨æˆ·é•¿æ—¶é—´å·¥ä½œï¼Œå†å²è®°å½•è¶…è¿‡ 100 æ­¥ â†’ å†…å­˜å ç”¨æŒç»­å¢é•¿

**LRU ç­–ç•¥**ï¼ˆè‡ªåŠ¨æ·˜æ±°æ—§è®°å½•ï¼‰ï¼š

```typescript
class HistoryManager {
  private maxHistorySize = 100;

  /**
   * é™åˆ¶å†å²æ ˆå¤§å°ï¼ˆLRU æ·˜æ±°ï¼‰
   */
  private trimHistoryIfNeeded(): void {
    if (this.undoStack.length > this.maxHistorySize) {
      const removeCount = this.undoStack.length - this.maxHistorySize;

      // 1. è·å–å°†è¢«åˆ é™¤çš„å‘½ä»¤
      const removedCommands = this.undoStack.slice(0, removeCount);

      // 2. æ¸…ç†è¿™äº›å‘½ä»¤å¼•ç”¨çš„æ–‡ä»¶
      removedCommands.forEach((cmd) => {
        if (cmd instanceof ReplaceAssetCommand) {
          this.filePool.removeReference(cmd.oldHash, cmd.id);
          this.filePool.removeReference(cmd.newHash, cmd.id);
        }
      });

      // 3. åˆ é™¤å‘½ä»¤
      this.undoStack.splice(0, removeCount);

      // 4. æ¸…ç†å¯¹åº”çš„å¿«ç…§
      this.snapshots.forEach((_, index) => {
        if (index < removeCount) {
          this.snapshots.delete(index);
        }
      });

      console.log(`[History] Trimmed ${removeCount} old operations`);
    }
  }
}
```

---

### 4. Command æ‰§è¡Œå¤±è´¥å¤„ç†

#### é—®é¢˜åœºæ™¯

ç”¨æˆ·æ‰§è¡Œæ“ä½œæ—¶ï¼Œå‘½ä»¤å¯èƒ½å› å„ç§åŸå› å¤±è´¥ï¼ˆç½‘ç»œã€æƒé™ã€æ•°æ®é”™è¯¯ï¼‰

**äº‹åŠ¡å›æ»šæœºåˆ¶**ï¼š

```typescript
class HistoryManager {
  execute(command: ICommand): void {
    const beforeState = this.schemaManager.cloneState();

    try {
      // 1. å°è¯•æ‰§è¡Œå‘½ä»¤
      command.execute();

      // 2. æˆåŠŸï¼šæ·»åŠ åˆ°å†å²æ ˆ
      this.undoStack.push(command);
      this.redoStack = [];
    } catch (error) {
      // 3. å¤±è´¥ï¼šå›æ»šåˆ°æ‰§è¡Œå‰çŠ¶æ€
      console.error('[History] Command execution failed:', error);
      this.schemaManager.setState(beforeState);

      // 4. é€šçŸ¥ UI å±‚
      this.emit('command-error', {
        command: command,
        error: error,
        message: `æ“ä½œå¤±è´¥ï¼š${error.message}`
      });

      // 5. ä¸æ·»åŠ åˆ°å†å²æ ˆ
    }
  }
}
```

**ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º**ï¼š

```typescript
// UI å±‚é”™è¯¯å¤„ç†
editor.historyManager.on('command-error', ({ command, error, message }) => {
  // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
  if (error.code === 'FILE_TOO_LARGE') {
    showDialog({
      title: 'æ–‡ä»¶è¿‡å¤§',
      message: 'ä¸Šä¼ çš„å›¾ç‰‡è¶…è¿‡ 10MBï¼Œè¯·å‹ç¼©åé‡è¯•',
      type: 'error',
      actions: [
        { label: 'å–æ¶ˆ', onClick: () => {} },
        { label: 'ä½¿ç”¨åœ¨çº¿å‹ç¼©', onClick: () => openCompressTool() }
      ]
    });
  } else if (error.code === 'PERMISSION_DENIED') {
    showDialog({
      title: 'æƒé™ä¸è¶³',
      message: 'æ— æ³•è®¿é—®æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™',
      type: 'error'
    });
  } else {
    // é€šç”¨é”™è¯¯æç¤º
    showNotification({
      type: 'error',
      title: 'æ“ä½œå¤±è´¥',
      message: message
    });
  }
});
```

---

### 5. åµŒå¥—äº‹åŠ¡å¤„ç†

#### é—®é¢˜åœºæ™¯

ç”¨æˆ·ä»£ç ä¸­å¯èƒ½æ„å¤–åµŒå¥—è°ƒç”¨ `transaction()`

**æ£€æµ‹ä¸æ‹’ç»**ï¼š

```typescript
class TransactionManager {
  private activeTransaction: Transaction | null = null;

  beginTransaction(description: string): Transaction {
    // âŒ æ£€æµ‹åµŒå¥—äº‹åŠ¡
    if (this.activeTransaction) {
      throw new Error('ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡ï¼å½“å‰äº‹åŠ¡: ' + this.activeTransaction.description);
    }

    this.activeTransaction = new Transaction(description);
    return this.activeTransaction;
  }
}
```

**å¼€å‘æ¨¡å¼è­¦å‘Š**ï¼š

```typescript
// å¼€å‘ç¯å¢ƒä¸‹æä¾›æ›´è¯¦ç»†çš„å †æ ˆä¿¡æ¯
if (process.env.NODE_ENV === 'development') {
  if (this.activeTransaction) {
    console.error('[Transaction] Nested transaction detected!', {
      current: this.activeTransaction.description,
      stackTrace: new Error().stack
    });
    throw new Error('ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡');
  }
}
```

---

### 6. å¼‚å¸¸ä¸­æ–­åçš„æ¢å¤

#### é—®é¢˜åœºæ™¯

ç”¨æˆ·æ“ä½œè¿‡ç¨‹ä¸­çªç„¶å…³é—­ç¼–è¾‘å™¨ â†’ æœªæäº¤çš„äº‹åŠ¡ä¸¢å¤±

**è‡ªåŠ¨ä¿å­˜æœºåˆ¶**ï¼š

```typescript
class AutoSaveManager {
  private saveInterval = 60 * 1000; // 1 åˆ†é’Ÿ
  private isDirty = false;

  start(): void {
    // 1. ç›‘å¬æ•°æ®å˜æ›´
    schemaManager.subscribe(() => {
      this.isDirty = true;
    });

    // 2. å®šæœŸè‡ªåŠ¨ä¿å­˜
    setInterval(async () => {
      if (this.isDirty) {
        await this.saveProject();
        this.isDirty = false;
      }
    }, this.saveInterval);

    // 3. çª—å£å…³é—­å‰ä¿å­˜
    window.addEventListener('beforeunload', (e) => {
      if (this.isDirty) {
        e.preventDefault();
        e.returnValue = ''; // è§¦å‘æµè§ˆå™¨ç¡®è®¤å¯¹è¯æ¡†

        // å°è¯•åŒæ­¥ä¿å­˜
        this.saveProject();
      }
    });
  }

  private async saveProject(): Promise<void> {
    try {
      const state = schemaManager.getState();
      const history = historyManager.serialize();

      await fs.promises.writeFile(path.join(app.getPath('userData'), 'autosave.json'), JSON.stringify({ state, history }), 'utf-8');

      console.log('[AutoSave] Project saved');
    } catch (error) {
      console.error('[AutoSave] Failed:', error);
    }
  }
}
```

**æ¢å¤é€»è¾‘**ï¼š

```typescript
// å¯åŠ¨æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ•°æ®
async function recoverAutoSave(): Promise<boolean> {
  const autosavePath = path.join(app.getPath('userData'), 'autosave.json');

  if (fs.existsSync(autosavePath)) {
    const { state, history } = JSON.parse(await fs.promises.readFile(autosavePath, 'utf-8'));

    // è¯¢é—®ç”¨æˆ·æ˜¯å¦æ¢å¤
    const shouldRecover = await showDialog({
      title: 'å‘ç°æœªä¿å­˜çš„æ•°æ®',
      message: 'æ£€æµ‹åˆ°ä¸Šæ¬¡ç¼–è¾‘æœªæ­£å¸¸ä¿å­˜ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ',
      type: 'question',
      actions: [
        { label: 'æ”¾å¼ƒ', value: false },
        { label: 'æ¢å¤', value: true }
      ]
    });

    if (shouldRecover) {
      schemaManager.setState(state);
      historyManager = HistoryManager.deserialize(history, commandFactory);
      return true;
    }
  }

  return false;
}
```

---

### 7. æ•°æ®å®Œæ•´æ€§æ ¡éªŒ

#### é—®é¢˜åœºæ™¯

åºåˆ—åŒ–/ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ•°æ®æŸå

**æ ¡éªŒæœºåˆ¶**ï¼š

```typescript
class IntegrityChecker {
  /**
   * ä¿å­˜æ—¶è®¡ç®—æ ¡éªŒå’Œ
   */
  static async saveWithChecksum(data: any, filePath: string): Promise<void> {
    const json = JSON.stringify(data);
    const checksum = crypto.createHash('sha256').update(json).digest('hex');

    const wrapper = {
      version: '1.0',
      timestamp: Date.now(),
      checksum: checksum,
      data: data
    };

    await fs.promises.writeFile(filePath, JSON.stringify(wrapper), 'utf-8');
  }

  /**
   * åŠ è½½æ—¶éªŒè¯æ ¡éªŒå’Œ
   */
  static async loadWithChecksum(filePath: string): Promise<any> {
    const wrapper = JSON.parse(await fs.promises.readFile(filePath, 'utf-8'));

    // 1. éªŒè¯ç‰ˆæœ¬
    if (wrapper.version !== '1.0') {
      throw new Error(`ä¸æ”¯æŒçš„ç‰ˆæœ¬: ${wrapper.version}`);
    }

    // 2. éªŒè¯æ ¡éªŒå’Œ
    const json = JSON.stringify(wrapper.data);
    const actualChecksum = crypto.createHash('sha256').update(json).digest('hex');

    if (actualChecksum !== wrapper.checksum) {
      throw new Error('æ•°æ®å®Œæ•´æ€§æ ¡éªŒå¤±è´¥ï¼æ–‡ä»¶å¯èƒ½å·²æŸå');
    }

    return wrapper.data;
  }
}
```

---

### 8. è¾¹ç•Œæƒ…å†µæ¸…å•

| è¾¹ç•Œæƒ…å†µ               | æ£€æµ‹æ–¹æ³•                 | å¤„ç†ç­–ç•¥                |
| ---------------------- | ------------------------ | ----------------------- |
| **ç©ºæ“ä½œ**             | `patches.length === 0`   | ä¸äº§ç”Ÿå†å²è®°å½•          |
| **é‡å¤æ“ä½œ**           | æ¯”è¾ƒ patches å†…å®¹        | åˆå¹¶ä¸ºå•ä¸ªæ“ä½œ          |
| **è¶…å¤§æ–‡ä»¶**           | æ£€æŸ¥æ–‡ä»¶å¤§å°             | æ‹’ç»æ“ä½œï¼Œæç¤ºå‹ç¼©      |
| **ç£ç›˜ç©ºé—´ä¸è¶³**       | æ•è· `ENOSPC` é”™è¯¯       | æç¤ºæ¸…ç†ç£ç›˜            |
| **æ–‡ä»¶åå†²çª**         | hash å†²çªï¼ˆæä½æ¦‚ç‡ï¼‰    | ä½¿ç”¨ `hash + timestamp` |
| **å†å²è®°å½•ä¸ºç©ºæ—¶æ’¤é”€** | `undoStack.length === 0` | ä¸æ‰§è¡Œï¼Œæç¤ºç”¨æˆ·        |
| **é‡åšæ ˆä¸ºç©ºæ—¶é‡åš**   | `redoStack.length === 0` | ä¸æ‰§è¡Œï¼Œæç¤ºç”¨æˆ·        |
| **å¿«ç…§åˆ›å»ºå¤±è´¥**       | `cloneState()` æŠ›å‡ºå¼‚å¸¸  | é™çº§ä¸ºæ— å¿«ç…§æ¨¡å¼        |
| **Patch åº”ç”¨å¤±è´¥**     | `applyPatches()` å¼‚å¸¸    | å›æ»šåˆ°ä¸Šä¸€çŠ¶æ€          |
| **å¼•ç”¨è®¡æ•°å¼‚å¸¸**       | `refCount < 0`           | è®°å½•é”™è¯¯æ—¥å¿—ï¼Œé‡ç½®ä¸º 0  |

---

### 9. é”™è¯¯ç±»å‹å®šä¹‰

```typescript
/**
 * è‡ªå®šä¹‰é”™è¯¯ç±»å‹
 */
class UndoError extends Error {
  type: 'FILE_MISSING' | 'MEMORY_ERROR' | 'PERMISSION_DENIED' | 'DATA_CORRUPTED';
  canRetry: boolean;
  suggestion?: string;

  constructor(
    message: string,
    options: {
      type: UndoError['type'];
      canRetry: boolean;
      suggestion?: string;
    }
  ) {
    super(message);
    this.name = 'UndoError';
    this.type = options.type;
    this.canRetry = options.canRetry;
    this.suggestion = options.suggestion;
  }
}

/**
 * é”™è¯¯æŠ¥å‘Š
 */
interface ErrorReport {
  timestamp: number;
  errorType: string;
  message: string;
  stack?: string;
  context: {
    historySize: number;
    memoryUsage: NodeJS.MemoryUsage;
    lastCommand?: string;
  };
}
```

---

### 10. è°ƒè¯•å·¥å…·

```typescript
/**
 * å¼€å‘æ¨¡å¼è°ƒè¯•é¢æ¿
 */
class HistoryDebugger {
  /**
   * æ‰“å°å½“å‰çŠ¶æ€
   */
  static printState(historyManager: HistoryManager): void {
    console.group('ğŸ“Š History State');
    console.log(
      'Undo Stack:',
      historyManager.getUndoStack().map((c) => c.description)
    );
    console.log(
      'Redo Stack:',
      historyManager.getRedoStack().map((c) => c.description)
    );
    console.log('Memory Usage:', process.memoryUsage());
    console.log('File Pool:', filePool.getStats());
    console.groupEnd();
  }

  /**
   * éªŒè¯æ•°æ®ä¸€è‡´æ€§
   */
  static validateIntegrity(historyManager: HistoryManager): boolean {
    // æ£€æŸ¥å¼•ç”¨è®¡æ•°æ˜¯å¦æ­£ç¡®
    const allHashes = new Set<string>();
    historyManager.getUndoStack().forEach((cmd) => {
      if (cmd instanceof ReplaceAssetCommand) {
        allHashes.add(cmd.oldHash);
        allHashes.add(cmd.newHash);
      }
    });

    let isValid = true;
    allHashes.forEach((hash) => {
      const expected = filePool.getRefCount(hash);
      const actual = filePool.countReferences(hash);

      if (expected !== actual) {
        console.error(`âŒ Ref count mismatch for ${hash}: expected ${expected}, actual ${actual}`);
        isValid = false;
      }
    });

    return isValid;
  }
}
```

---

## ğŸ“ 13. æŠ€æœ¯çº¦æŸ

### Electron ç¯å¢ƒ

- âœ… å¯ä»¥ä½¿ç”¨ Node.js APIï¼ˆfs, path ç­‰ï¼‰
- âœ… å¯ä»¥é€šè¿‡ IPC ä¸ä¸»è¿›ç¨‹é€šä¿¡
- âœ… å¯ä»¥è®¿é—®ä¸´æ—¶ç›®å½•å­˜å‚¨å¤§æ–‡ä»¶
- âš ï¸ éœ€è¦è€ƒè™‘è·¨å¹³å°è·¯å¾„å…¼å®¹æ€§

### Schema ç»“æ„ç‰¹ç‚¹

- ğŸ“¦ **åµŒå¥—æ·±åº¦**: å¯èƒ½ 5-10 å±‚æ·±çš„å¯¹è±¡ç»“æ„
- ğŸ”¢ **ç»„ä»¶æ•°é‡**: å•ä¸ªä¸»é¢˜å¯èƒ½åŒ…å« 50-200 ä¸ªç»„ä»¶
- ğŸ“Š **æ•°æ®ç±»å‹**: åŒ…å«åŸºæœ¬ç±»å‹ã€æ•°ç»„ã€åµŒå¥—å¯¹è±¡ã€æ–‡ä»¶å¼•ç”¨
- ğŸ”— **å¼•ç”¨å…³ç³»**: ç»„ä»¶é—´å¯èƒ½å­˜åœ¨æ•°æ®ç»‘å®šå…³ç³»

### æ€§èƒ½è¦æ±‚

- âš¡ **UI çº¿ç¨‹**: æ’¤é”€/é‡åšä¸èƒ½é˜»å¡æ¸²æŸ“ï¼ˆ< 16msï¼‰
- ğŸ’¾ **å†…å­˜é™åˆ¶**: Electron æ¸²æŸ“è¿›ç¨‹å»ºè®® < 500MB
- ğŸ”„ **å“åº”é€Ÿåº¦**: ç”¨æˆ·ç‚¹å‡»åˆ° UI æ›´æ–° < 100ms

---

## âœ… 14. æˆåŠŸæ ‡å‡†

### å¯é‡åŒ–æŒ‡æ ‡

1. **å†…å­˜å ç”¨** â‰¤ 10MBï¼ˆ100 æ­¥å†å²ï¼‰
2. **æ’¤é”€å»¶è¿Ÿ** < 50msï¼ˆP95ï¼‰
3. **é‡åšå»¶è¿Ÿ** < 50msï¼ˆP95ï¼‰
4. **æ”¯æŒå†å²** â‰¥ 100 æ­¥
5. **åˆå¹¶æ•ˆç‡** â‰¥ 80%ï¼ˆè¿ç»­ç›¸ä¼¼æ“ä½œï¼‰

### ç”¨æˆ·ä½“éªŒ

- âœ… æ“ä½œæµç•…ï¼Œæ— å¡é¡¿æ„Ÿ
- âœ… å†å²è®°å½•æ¸…æ™°ï¼Œå¯ç†è§£ï¼ˆå¦‚æ˜¾ç¤º "ä¿®æ”¹ Header èƒŒæ™¯è‰²"ï¼‰
- âœ… æ”¯æŒå¿«æ·é”®æ— å»¶è¿Ÿ
- âœ… å¤§é‡æ’¤é”€ä¸å´©æºƒ

### å¼€å‘ä½“éªŒ

- âœ… æ–°å¢ç¼–è¾‘æ“ä½œåªéœ€å®ç°å¯¹åº” Command ç±»
- âœ… æ ¸å¿ƒé€»è¾‘ä¸ UI æ¡†æ¶è§£è€¦ï¼ˆå¯ç”¨äº Vue/React ç­‰ï¼‰
- âœ… å®Œå–„çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… æ˜“äºå•å…ƒæµ‹è¯•

---

## ğŸš€ 15. åç»­æ‰©å±•æ–¹å‘

### çŸ­æœŸï¼ˆMVP é˜¶æ®µï¼‰

- [ ] å®ç°åŸºç¡€æ’¤é”€/é‡åšï¼ˆCommand Patternï¼‰
- [ ] æ”¯æŒ 10 ç§æ ¸å¿ƒç¼–è¾‘æ“ä½œ
- [ ] å®ç°æ“ä½œåˆå¹¶é€»è¾‘
- [ ] **å®ç°æ’¤é”€/é‡åšæ‰¹å¤„ç†ï¼ˆæ–¹æ¡ˆ 5ï¼‰** â­ æ–°å¢
- [ ] æ·»åŠ å†å²é¢æ¿ UI

### ä¸­æœŸï¼ˆä¼˜åŒ–é˜¶æ®µï¼‰

- [ ] å¼•å…¥ Immer.js è‡ªåŠ¨ç”Ÿæˆ Diff
- [ ] å®ç°å‘¨æœŸå¿«ç…§æ··åˆç­–ç•¥
- [ ] æ·»åŠ å†å²æŒä¹…åŒ–ï¼ˆå­˜å‚¨åˆ°ä¸´æ—¶æ–‡ä»¶ï¼‰
- [ ] **ä¼˜åŒ–æ‰¹å¤„ç†çª—å£åŠ¨æ€è°ƒæ•´** â­ æ–°å¢
- [ ] **æ·»åŠ æ’¤é”€/é‡åšè¿›åº¦åé¦ˆ** â­ æ–°å¢
- [ ] æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### é•¿æœŸï¼ˆé«˜çº§ç‰¹æ€§ï¼‰

- [ ] æ”¯æŒåä½œç¼–è¾‘ï¼ˆOT/CRDTï¼‰
- [ ] æ“ä½œå†å²å¯è§†åŒ–æ—¶é—´è½´
- [ ] æ”¯æŒåˆ†æ”¯å†å²ï¼ˆéçº¿æ€§æ’¤é”€ï¼‰
- [ ] äº‘ç«¯åŒæ­¥å’Œç‰ˆæœ¬ç®¡ç†

---

## ğŸ“š 16. å‚è€ƒèµ„æ–™

### ä¸šç•Œæ¡ˆä¾‹

- **Figma**: ä½¿ç”¨ Operational Transformation å®ç°åä½œç¼–è¾‘
- **VS Code**: Monaco Editor ä½¿ç”¨åŸºäºè¡Œçš„ Diff ç®—æ³•
- **Google Docs**: CRDT + æœåŠ¡ç«¯åè°ƒ
- **Photoshop**: åŸºäºæ …æ ¼çš„å†å²è®°å½•ï¼ˆHistory Statesï¼‰

### å¼€æºåº“æ¨è

- **Immer.js**: ä¸å¯å˜æ•°æ® + è‡ªåŠ¨ Diff ç”Ÿæˆ
- **json-patch**: RFC 6902 JSON Patch æ ‡å‡†
- **history**: React Router çš„å†å²ç®¡ç†åº“
- **slate.js**: å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„ Operation è®¾è®¡

---

## ğŸ“ é™„å½• A. æ–‡æ¡£ç»´æŠ¤

### æ–‡æ¡£ç»´æŠ¤

- **åˆ›å»ºæ—¶é—´**: 2025-12-09
- **æœ€åæ›´æ–°**: 2025-12-09
- **è´Ÿè´£äºº**: å¾…å®š
- **ç‰ˆæœ¬**: v1.1
- **æ›´æ–°å†…å®¹**:
  - âœ… æ–°å¢æ–¹æ¡ˆ 5ï¼šæ’¤é”€/é‡åšæ“ä½œæ‰¹å¤„ç†
  - âœ… è¡¥å……é¢‘ç¹ç‚¹å‡»æŒ‰é’®çš„ä¼˜åŒ–æ–¹æ¡ˆ
  - âœ… æ·»åŠ  UndoRedoBatchManager å®Œæ•´å®ç°
  - âœ… æ›´æ–°æ€§èƒ½å¯¹æ¯”æ•°æ®å’Œä½¿ç”¨åœºæ™¯

---
