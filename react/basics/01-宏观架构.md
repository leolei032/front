# React 宏观架构

## 核心包结构

React Web 开发涉及 4 个核心包：

### 1. react
- **定位**：基础包
- **作用**：提供定义 React 组件的必要函数
- **常用 API**：`React.createElement`、`React.Component`、`useState`、`useEffect` 等

### 2. react-dom
- **定位**：渲染器
- **作用**：连接 React 与 Web 平台的桥梁
- **核心功能**：
  - 启动 React 应用：`ReactDOM.render()`
  - 将 Fiber 树渲染成实际的 DOM 节点
  - 实现 HostConfig 协议

### 3. react-reconciler
- **定位**：核心协调器
- **作用**：React 得以运行的核心，协调各包之间的调用
- **核心流程**：
  ```
  接收输入 (scheduleUpdateOnFiber)
    ↓
  封装回调 (fiber 树构造逻辑)
    ↓
  送入 scheduler 调度
    ↓
  回调执行 (构造 fiber 树)
    ↓
  调用渲染器输出
  ```

### 4. scheduler
- **定位**：调度中心
- **作用**：控制回调函数的执行时机
- **核心能力**：
  - 执行回调函数
  - 任务优先级管理
  - 实现可中断渲染（Concurrent 模式）

## 架构分层

### 接口层（API）
**包含**：react 包

**核心能力**：
- `setState()` - class 组件状态更新
- `dispatchAction()` - Hook 状态更新
- Context API - 跨组件通信

所有能改变渲染的操作都通过接口层发起。

### 内核层（Core）

#### 1. 调度器（Scheduler）
```javascript
职责：执行回调
  ├─ 包装任务对象
  ├─ 维护优先级队列（最小堆）
  └─ 循环消费任务队列
```

#### 2. 构造器（Reconciler）
```javascript
职责：构造 Fiber 树
  ├─ 装载渲染器（HostConfig）
  ├─ 接收更新请求
  └─ 包装回调函数送入 scheduler
```

#### 3. 渲染器（React-DOM）
```javascript
职责：输出到平台
  ├─ 启动应用（ReactDOM.render）
  └─ 实现 HostConfig 协议
      ├─ 创建 DOM 节点
      └─ 更新 DOM 属性
```

## 核心包调用关系

```
┌─────────────────────────────────────────────┐
│                   React 包                   │
│         (setState, dispatchAction)          │
└───────────────────┬─────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│              React-Reconciler                │
│   ┌─────────────────────────────────────┐  │
│   │ 输入：scheduleUpdateOnFiber         │  │
│   └─────────────────────────────────────┘  │
│                    ↓                        │
│   ┌─────────────────────────────────────┐  │
│   │ 注册：ensureRootIsScheduled         │  │
│   └─────────────────────────────────────┘  │
└───────────────────┬─────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│                 Scheduler                    │
│   ┌─────────────────────────────────────┐  │
│   │ 调度：scheduleCallback              │  │
│   └─────────────────────────────────────┘  │
└───────────────────┬─────────────────────────┘
                    ↓ (回调执行)
┌─────────────────────────────────────────────┐
│              React-Reconciler                │
│   ┌─────────────────────────────────────┐  │
│   │ 构造：renderRoot (fiber 树)        │  │
│   └─────────────────────────────────────┘  │
│                    ↓                        │
│   ┌─────────────────────────────────────┐  │
│   │ 输出：commitRoot                    │  │
│   └─────────────────────────────────────┘  │
└───────────────────┬─────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│                React-DOM                     │
│          (渲染 DOM，更新界面)                │
└─────────────────────────────────────────────┘
```

## 关键特性

### 1. 输入到输出的链路
所有更新都遵循固定路径：
```
输入 → 注册调度 → 执行回调 → 输出
```

### 2. 包之间的解耦
- React 包不直接操作 DOM
- Reconciler 不关心渲染平台
- Scheduler 独立于 React，可单独使用

### 3. 优化策略
基于此架构实现的优化：
- **批量更新**：多次 setState 合并处理
- **可中断渲染**：Scheduler 控制任务执行时机
- **优先级调度**：紧急任务优先处理

## 总结

React 的架构设计体现了**关注点分离**的思想：
- **React 包**：定义组件和 API
- **Scheduler**：控制调度时机
- **Reconciler**：协调更新流程
- **React-DOM**：平台相关渲染

这种分层架构使得 React 能够：
1. 支持多平台（Web、Native、VR 等）
2. 实现高性能渲染策略
3. 保持良好的代码可维护性
